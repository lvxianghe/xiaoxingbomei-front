<template>
  <div class="chat-container" 
    :class="[
      `theme-${currentTheme}`, 
      isDarkMode ? 'dark-mode' : '',
      `font-size-${currentFontSettings.size}`,
      `font-spacing-${currentFontSettings.spacing}`,
      `font-family-${currentFontSettings.family}`
    ]"
  >
    <!-- ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® - å½“ä¾§è¾¹æ æŠ˜å æ—¶æ˜¾ç¤º -->
    <div class="sidebar-toggle" v-if="sidebarCollapsed" @click="toggleSidebar" title="å±•å¼€ä¾§è¾¹æ ">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 18l6-6-6-6"></path>
      </svg>
    </div>
    
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" :class="{'sidebar-collapsed': sidebarCollapsed}">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">
            <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.000000 512.000000" preserveAspectRatio="xMidYMid meet">
              <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)" fill="#333333" stroke="none">
                <path d="M2330 5110 c-192 -19 -372 -56 -550 -112 -101 -32 -107 -33 -170 -21
                -147 28 -348 7 -490 -51 -264 -108 -459 -334 -531 -614 -10 -41 -19 -89 -19
                -106 0 -23 -18 -56 -66 -121 -643 -879 -672 -2055 -72 -2947 135 -202 343
                -428 533 -580 600 -480 1387 -662 2150 -498 228 50 562 179 584 226 16 35 14
                48 -10 78 -28 36 -58 34 -169 -15 -361 -156 -780 -224 -1165 -189 -470 44
                -875 200 -1254 483 -123 92 -366 335 -458 458 -196 262 -336 547 -412 841
                -165 638 -71 1296 266 1859 l77 130 26 -83 c34 -107 59 -154 107 -200 56 -55
                115 -78 199 -78 87 0 155 31 213 96 75 85 90 188 45 315 -21 60 -25 86 -21
                140 7 104 42 164 150 255 43 36 48 68 16 108 -27 34 -63 34 -120 -2 -165 -105
                -243 -352 -170 -542 26 -69 27 -116 1 -157 -27 -46 -72 -66 -132 -61 -69 7
                -99 39 -132 140 -117 352 30 722 353 892 119 62 199 81 346 81 117 0 139 -3
                219 -29 100 -33 140 -61 156 -112 17 -51 5 -99 -35 -139 -47 -46 -90 -53 -161
                -26 -70 26 -108 27 -134 1 -26 -26 -26 -81 -2 -103 10 -10 52 -29 93 -43 57
                -20 86 -25 126 -21 106 11 192 69 241 162 21 41 26 63 25 125 0 84 -16 130
                -64 185 -18 20 -30 37 -28 39 7 7 174 45 264 61 228 40 521 44 746 10 110 -17
                318 -61 327 -70 3 -3 -6 -18 -20 -33 -101 -108 -97 -291 10 -395 84 -82 207
                -104 329 -58 52 20 76 23 140 19 90 -5 143 -28 202 -87 88 -88 112 -211 67
                -340 -44 -125 -30 -227 40 -310 56 -65 113 -93 200 -99 166 -11 273 85 330
                294 l17 65 47 -73 c356 -561 467 -1246 305 -1888 -142 -564 -495 -1071 -976
                -1400 -48 -33 -89 -67 -93 -76 -19 -50 16 -104 68 -104 60 0 310 195 501 391
                203 209 338 400 465 661 415 849 326 1855 -234 2628 -55 77 -76 113 -76 136 0
                43 -33 169 -65 245 -62 147 -199 311 -337 399 -177 115 -433 166 -638 127 -63
                -12 -68 -12 -170 21 -124 40 -275 75 -420 97 -124 18 -469 27 -590 15z"/>
                <path d="M1735 2940 c-77 -40 -80 -48 -83 -282 -3 -230 0 -245 61 -292 49 -37
                102 -42 156 -14 83 43 86 51 89 286 3 203 3 208 -20 241 -51 76 -130 99 -203
                61z"/>
                <path d="M3245 2936 c-68 -42 -78 -70 -83 -233 -3 -78 -1 -172 3 -210 6 -62
                11 -71 49 -109 53 -53 105 -64 169 -36 24 11 55 35 68 53 24 33 24 38 24 246
                0 198 -1 213 -21 239 -54 73 -139 94 -209 50z"/>
                <path d="M2479 2295 c-25 -8 -66 -33 -91 -55 -144 -126 -116 -354 54 -441 21
                -11 38 -24 38 -29 0 -22 -43 -100 -76 -138 -19 -23 -60 -53 -92 -69 -48 -24
                -70 -28 -137 -28 -67 0 -89 4 -137 28 -96 47 -161 142 -174 254 -12 95 -75
                133 -129 78 -30 -29 -32 -73 -10 -160 56 -212 241 -355 461 -355 48 0 61 -4
                97 -34 165 -133 377 -137 546 -10 54 40 63 44 118 44 110 0 227 44 312 117 84
                71 149 207 152 318 2 52 -1 61 -25 82 -59 50 -110 13 -126 -91 -18 -114 -72
                -190 -173 -243 -71 -37 -187 -39 -262 -5 -63 29 -120 83 -151 144 -31 61 -30
                74 6 93 195 101 202 375 12 478 -62 34 -148 43 -213 22z m189 -817 c23 -18 42
                -35 42 -39 0 -15 -98 -44 -150 -44 -52 0 -150 29 -150 44 0 4 13 14 29 24 16
                9 51 41 78 70 l48 53 30 -37 c17 -21 49 -53 73 -71z"/>
              </g>
            </svg>
          </div>
          <span>å°å‹åšç¾</span>
        </div>
        <div class="header-buttons">
          <button class="exit-btn" @click="goToHome" title="è¿”å›é¦–é¡µ">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </button>
          <button class="collapse-btn" @click="toggleSidebar" :title="sidebarCollapsed ? 'å±•å¼€ä¾§è¾¹æ ' : 'æ”¶èµ·ä¾§è¾¹æ '">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 18l-6-6 6-6" v-if="!sidebarCollapsed"></path>
              <path d="M9 18l6-6-6-6" v-else></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="sidebar-actions">
        <button class="new-chat-btn" @click="startNewChat">
          <span class="btn-icon">+</span> æ–°å»ºå¯¹è¯
        </button>
      </div>
      <div class="history-list">
        <div class="history-item" v-for="(item, index) in chatHistory" :key="index" @click="loadConversation(index)">
          <div class="history-content">
            <div class="history-title">{{ item.title }}</div>
            <div class="history-meta">
              <span class="history-time">{{ item.time }}</span>
              <div class="history-tags" v-if="item.tags && item.tags.length > 0">
                <span 
                  v-for="(tag, tagIndex) in limitTags(item.tags)" 
                  :key="tagIndex" 
                  class="history-tag"
                  :style="{ backgroundColor: getTagColor(tag) }"
                >
                  {{ tag }}
                </span>
              </div>
            </div>
          </div>
          <div class="history-actions">
            <button class="history-action-btn tag-btn" @click.stop="openTagSelector(index)" title="ç¼–è¾‘ä¼šè¯">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
            <button class="history-action-btn export-btn" @click.stop="openExportMenu(index)" title="å¯¼å‡ºå¯¹è¯">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <button class="history-action-btn delete-history-btn" @click.stop="deleteHistory(index)" title="åˆ é™¤æ­¤å¯¹è¯">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"></path>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="sidebar-footer">
        <button class="settings-btn" @click="openThemeSettings">
          <span class="btn-icon">âš™ï¸</span> ä¸ªæ€§åŒ–è®¾ç½®
        </button>
        <button class="profile-btn" @click="showToast('ä¸ªäººä¿¡æ¯åŠŸèƒ½å¼€å‘ä¸­')">
          <span class="btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          ä¸ªäººä¿¡æ¯
        </button>
      </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content" :class="{'full-width': !showSidebar}">
      <!-- èŠå¤©å†…å®¹å®¹å™¨ -->
      <div 
        class="chat-content" 
        ref="chatContentRef"
        @scroll="handleScroll"
      >
        <!-- æ¬¢è¿ä¿¡æ¯ -->
        <div v-if="messages.length === 0" class="welcome-container">
          <div class="bot-avatar">
            <img src="/icons/pomeranian.svg" alt="å°å‹åšç¾" />
          </div>
          <div class="welcome-title">æˆ‘æ˜¯ å°å‹åšç¾, å¾ˆé«˜å…´è§åˆ°ä½ !</div>
          <div class="welcome-subtitle">æˆ‘å¯ä»¥å¸®ä½ å†™ä»£ç ã€è¯»æ–‡ä»¶ã€å†™ä½œå„ç§åˆ›æ„å†…å®¹ï¼Œè¯·æŠŠä½ çš„ä»»åŠ¡äº¤ç»™æˆ‘å§~</div>
        </div>
        
        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <div class="message-container" v-else>
          <div v-for="(message, index) in messages" :key="index" 
               :class="['message-item', message.role === 'user' ? 'user-message' : 'bot-message']">
            <div class="message-avatar">
              {{ message.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–' }}
            </div>
            <div class="message-content">
              <!-- æ€è€ƒå†…å®¹åŒº -->
              <div v-if="message.thinking" class="message-thinking">
                <div class="thinking-header">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12" y2="16"></line>
                  </svg>
                  <span>æ€è€ƒè¿‡ç¨‹</span>
                </div>
                <div class="thinking-content markdown-body" v-html="renderMarkdown(message.thinking)"></div>
              </div>
              <!-- æ¶ˆæ¯å†…å®¹åŒº -->
              <div class="message-text markdown-body" v-html="renderMarkdown(message.content)"></div>
              <div class="message-time">{{ message.time }}</div>
            </div>
          </div>
          <div class="typing-indicator" v-if="isTyping">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      </div>
      
      <!-- ä¸­å¤®è¾“å…¥åŒºåŸŸ -->
      <div class="chat-input-wrapper" :class="{
        'with-messages': messages.length > 0,
        'sidebar-expanded': !sidebarCollapsed
      }">
        <div class="chat-input-area">
          <div class="mode-selector-inner">
            <button class="mode-btn deep-think-btn" @click="showToast('æ·±åº¦æ€è€ƒåŠŸèƒ½å¼€å‘ä¸­')" title="æ·±åº¦æ€è€ƒ">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 2a4.5 4.5 0 0 0 0 9 4.5 4.5 0 0 1 0 9 10 10 0 0 0 0-18z"></path>
                <path d="M12 8a2.5 2.5 0 1 0 0 5 2.5 2.5 0 1 0 0-5"></path>
              </svg>
              <span>æ·±åº¦æ€è€ƒ (R1)</span>
            </button>
            <button class="mode-btn web-search-btn" @click="showToast('è”ç½‘æœç´¢åŠŸèƒ½å¼€å‘ä¸­')" title="è”ç½‘æœç´¢">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
              </svg>
              <span>è”ç½‘æœç´¢</span>
            </button>
            <button class="mode-btn prompt-library-btn" @click="openPromptLibrary" title="æç¤ºè¯åº“">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
              </svg>
              <span>æç¤ºè¯åº“</span>
            </button>
            <button class="mode-btn cloud-model-btn" @click="useCloudModel = !useCloudModel" :class="{ 'active': useCloudModel }" title="äº‘ç«¯å¤§æ¨¡å‹">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
              </svg>
              <span>äº‘ç«¯å¤§æ¨¡å‹</span>
            </button>
          </div>
          
          <div class="input-row">
            <textarea 
              v-model="userInput" 
              class="chat-input" 
              placeholder="ç»™ å°å‹åšç¾ å‘é€æ¶ˆæ¯" 
              @keydown.enter.prevent="sendMessage"
              rows="1"
              ref="inputRef"
            ></textarea>
            
            <div class="input-tools">
              <button class="tool-btn upload-btn" @click="openFileManager" title="ç®¡ç†æ–‡ä»¶">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              </button>
              <button class="send-btn" @click="sendMessage" :disabled="!userInput.trim()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Toast æ¶ˆæ¯æç¤º -->
    <div class="toast-container" v-if="toast.show" :class="{ 'toast-show': toast.show }">
      <div class="toast-message">{{ toast.message }}</div>
    </div>
    
    <!-- æ ‡ç­¾é€‰æ‹©å™¨å¼¹å‡ºå±‚ -->
    <div class="modal-overlay" v-if="showTagSelector" @mousedown="handleModalOverlayMouseDown" @mouseup="handleModalOverlayMouseUp">
      <div class="modal-container tag-selector" @click.stop>
        <div class="modal-header">
          <h3>ç¼–è¾‘ä¼šè¯</h3>
          <button class="modal-close" @click="showTagSelector = false">Ã—</button>
        </div>
        <div class="modal-body">
          <!-- æ·»åŠ ä¼šè¯æ ‡é¢˜ç¼–è¾‘ -->
          <div class="form-group mb-4">
            <label for="chatTitle" class="form-label mb-2 font-medium text-gray-700">ä¼šè¯æ ‡é¢˜</label>
            <input 
              type="text" 
              id="chatTitle" 
              v-model="editingChatTitle" 
              class="title-input" 
              placeholder="è¯·è¾“å…¥ä¼šè¯æ ‡é¢˜"
            />
          </div>
          
          <div class="form-group mb-4">
            <label class="form-label mb-2 font-medium text-gray-700">é€‰æ‹©æ ‡ç­¾</label>
            <div class="tags-container">
              <div 
                v-for="tag in availableTags" 
                :key="tag.id" 
                class="tag-item"
                :class="{ selected: isTagSelected(tag.name) }"
                @click="toggleTag(tag.name)"
                :style="{ borderColor: tag.color }"
              >
                <span class="tag-color" :style="{ backgroundColor: tag.color }"></span>
                <span class="tag-name">{{ tag.name }}</span>
                <span class="tag-check" v-if="isTagSelected(tag.name)">âœ“</span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" @click="showTagSelector = false">å–æ¶ˆ</button>
          <button class="confirm-btn" @click="saveTagsToChat">ä¿å­˜</button>
        </div>
      </div>
    </div>
    
    <!-- å¯¼å‡ºèœå•å¼¹å‡ºå±‚ -->
    <div class="modal-overlay" v-if="showExportMenu" @mousedown="handleModalOverlayMouseDown" @mouseup="handleExportMenuOverlayMouseUp">
      <div class="modal-container export-menu" @click.stop>
        <div class="modal-header">
          <h3>å¯¼å‡ºå¯¹è¯</h3>
          <button class="modal-close" @click="showExportMenu = false">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="export-options">
            <div 
              v-for="format in exportFormats" 
              :key="format.id" 
              class="export-option"
              @click="exportConversation(format.id)"
            >
              <span class="export-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              </span>
              <span class="export-format">{{ format.name }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ–‡ä»¶ç®¡ç†å™¨å¼¹å‡ºå±‚ -->
    <div class="modal-overlay" v-if="showFileManager" @mousedown="handleModalOverlayMouseDown" @mouseup="handleFileManagerOverlayMouseUp">
      <div class="modal-container file-manager" @click.stop style="max-width: 700px; width: 90%;">
        <div class="modal-header">
          <h3>æ–‡ä»¶ç®¡ç†</h3>
          <button class="modal-close" @click="showFileManager = false">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="file-manager-toolbar">
            <div class="file-search">
              <input 
                type="text" 
                v-model="fileSearchQuery" 
                placeholder="æœç´¢æ–‡ä»¶..." 
                class="file-search-input"
              />
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </div>
            <div class="file-filters">
              <button 
                :class="['filter-btn', currentFilter === 'all' ? 'active' : '']" 
                @click="currentFilter = 'all'"
              >
                å…¨éƒ¨
              </button>
              <button 
                :class="['filter-btn', currentFilter === 'accessible' ? 'active' : '']" 
                @click="currentFilter = 'accessible'"
              >
                AIå¯è®¿é—®
              </button>
              <button 
                :class="['filter-btn', currentFilter === 'restricted' ? 'active' : '']" 
                @click="currentFilter = 'restricted'"
              >
                AIå—é™
              </button>
            </div>
            <button class="upload-file-btn" @click="openUploadModal">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              ä¸Šä¼ æ–‡ä»¶
            </button>
          </div>
          
          <div class="files-container">
            <div 
              v-for="file in filteredFiles" 
              :key="file.id" 
              :class="['file-item', selectedFile === file.id ? 'selected' : '']"
              @click="selectFile(file.id)"
            >
              <div class="file-icon">
                <svg v-if="file.type === 'pdf'" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <rect x="8" y="12" width="8" height="2" rx="1"></rect>
                  <rect x="8" y="16" width="8" height="2" rx="1"></rect>
                </svg>
                <svg v-else-if="file.type === 'docx'" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4285F4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                <svg v-else-if="file.type === 'xlsx'" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#34A853" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="9" y1="3" x2="9" y2="21"></line>
                  <line x1="3" y1="9" x2="21" y2="9"></line>
                </svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                  <polyline points="13 2 13 9 20 9"></polyline>
                </svg>
              </div>
              <div class="file-details">
                <div class="file-name" :class="{ 'restricted': !file.aiAccessible }">
                  {{ file.name }}
                  <span v-if="!file.aiAccessible" class="restricted-badge">AIå—é™</span>
                </div>
                <div class="file-meta">
                  <span class="file-size">{{ formatFileSize(file.size) }}</span>
                  <span class="file-date">{{ file.uploadTime }}</span>
                </div>
                <div class="file-description">{{ file.description || 'æ— æè¿°' }}</div>
              </div>
              <div class="file-actions">
                <button class="file-action-btn toggle-access" @click.stop="toggleAccess(file.id)" :title="file.aiAccessible ? 'è®¾ä¸ºAIå—é™' : 'å…è®¸AIè®¿é—®'">
                  <svg v-if="file.aiAccessible" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  <svg v-else xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                    <line x1="2" y1="2" x2="22" y2="22"></line>
                  </svg>
                </button>
                <button class="file-action-btn delete-file" @click.stop="deleteFile(file.id)" title="åˆ é™¤æ–‡ä»¶">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div class="no-files" v-if="filteredFiles.length === 0">
              æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" @click="showFileManager = false">å…³é—­</button>
        </div>
      </div>
    </div>
    
    <!-- æ–‡ä»¶ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div class="modal-overlay" v-if="showFileUploadModal" @mousedown="handleModalOverlayMouseDown" @mouseup="handleFileUploadOverlayMouseUp">
      <div class="modal-container file-upload-modal" @click.stop>
        <div class="modal-header">
          <h3>ä¸Šä¼ æ–‡ä»¶</h3>
          <button class="modal-close" @click="showFileUploadModal = false">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="file-upload-area">
            <div class="upload-dropzone">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤å¤„ä¸Šä¼ </p>
              <span class="upload-formats">æ”¯æŒçš„æ ¼å¼: PDF, Word, Excel, TXT</span>
            </div>
            
            <div class="upload-form">
              <div class="form-group">
                <label for="file-name">æ–‡ä»¶åç§°</label>
                <input type="text" id="file-name" v-model="newFile.name" placeholder="è¯·è¾“å…¥æ–‡ä»¶åç§°" />
              </div>
              <div class="form-group">
                <label for="file-description">æ–‡ä»¶æè¿°</label>
                <textarea id="file-description" v-model="newFile.description" placeholder="è¯·è¾“å…¥æ–‡ä»¶æè¿°ï¼ˆå¯é€‰ï¼‰" rows="3"></textarea>
              </div>
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" v-model="newFile.aiAccessible" />
                  å…è®¸AIè®¿é—®è¯¥æ–‡ä»¶å†…å®¹
                  <span class="hint">é€‰ä¸­åï¼Œå°å‹åšç¾å°†å¯ä»¥è¯»å–å’Œåˆ†æè¯¥æ–‡ä»¶å†…å®¹</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" @click="showFileUploadModal = false">å–æ¶ˆ</button>
          <button class="confirm-btn" @click="uploadFile">ä¸Šä¼ </button>
        </div>
      </div>
    </div>
    
    <!-- ä¸»é¢˜è®¾ç½®å¼¹å‡ºçª—å£ -->
    <div class="modal-overlay" v-if="showThemeSettings" @mousedown="handleModalOverlayMouseDown" @mouseup="handleThemeSettingsOverlayMouseUp">
      <div class="modal-container theme-settings" @click.stop style="max-width: 860px; width: 90%;">
        <div class="modal-header">
          <h3>ä¸ªæ€§åŒ–è®¾ç½®</h3>
          <button class="modal-close" @click="showThemeSettings = false">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="settings-layout">
            <div class="settings-column">
              <div class="theme-section">
                <div class="section-row">
                  <h4 class="section-title">ä¸»é¢˜é£æ ¼</h4>
                  <div class="theme-options">
                    <div 
                      v-for="theme in themeOptions" 
                      :key="theme.id"
                      :class="['theme-option', currentTheme === theme.id ? 'selected' : '']"
                      @click="setTheme(theme.id)"
                    >
                      <div class="theme-preview" :style="{ background: theme.preview }"></div>
                      <div class="theme-name">{{ theme.name }}</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="theme-section">
                <div class="section-row">
                  <h4 class="section-title">æ˜æš—æ¨¡å¼</h4>
                  <div class="mode-toggle">
                    <button 
                      :class="['mode-btn', !isDarkMode ? 'active' : '']" 
                      @click="setDarkMode(false)"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                      </svg>
                      <span>æµ…è‰²</span>
                    </button>
                    <button 
                      :class="['mode-btn', isDarkMode ? 'active' : '']" 
                      @click="setDarkMode(true)"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                      </svg>
                      <span>æ·±è‰²</span>
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="theme-section">
                <div class="font-settings">
                  <div class="font-setting section-row">
                    <span class="setting-label">å­—ä½“å¤§å°</span>
                    <div class="setting-options">
                      <button 
                        :class="['option-btn', currentFontSettings.size === 'small' ? 'active' : '']"
                        @click="setFontSize('small')"
                      >
                        å°
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.size === 'medium' ? 'active' : '']"
                        @click="setFontSize('medium')"
                      >
                        ä¸­
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.size === 'large' ? 'active' : '']"
                        @click="setFontSize('large')"
                      >
                        å¤§
                      </button>
                    </div>
                  </div>
                  
                  <div class="font-setting section-row">
                    <span class="setting-label">å­—ä½“é—´è·</span>
                    <div class="setting-options">
                      <button 
                        :class="['option-btn', currentFontSettings.spacing === 'compact' ? 'active' : '']"
                        @click="setFontSpacing('compact')"
                      >
                        ç´§å‡‘
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.spacing === 'normal' ? 'active' : '']"
                        @click="setFontSpacing('normal')"
                      >
                        æ ‡å‡†
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.spacing === 'relaxed' ? 'active' : '']"
                        @click="setFontSpacing('relaxed')"
                      >
                        å®½æ¾
                      </button>
                    </div>
                  </div>
                  
                  <div class="font-setting section-row">
                    <span class="setting-label">å­—ä½“é£æ ¼</span>
                    <div class="setting-options">
                      <button 
                        :class="['option-btn', currentFontSettings.family === 'default' ? 'active' : '']"
                        @click="setFontFamily('default')"
                      >
                        é»˜è®¤
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.family === 'serif' ? 'active' : '']"
                        @click="setFontFamily('serif')"
                      >
                        è¡¬çº¿
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.family === 'mono' ? 'active' : '']"
                        @click="setFontFamily('mono')"
                      >
                        ç­‰å®½
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="settings-column">
              <div class="theme-preview-section">
                <h4 class="section-title">é¢„è§ˆæ•ˆæœ</h4>
                <div 
                  class="preview-container"
                  :class="[
                    `theme-${currentTheme}`, 
                    isDarkMode ? 'dark-mode' : '',
                    `font-size-${currentFontSettings.size}`,
                    `font-spacing-${currentFontSettings.spacing}`,
                    `font-family-${currentFontSettings.family}`
                  ]"
                >
                  <div class="preview-header">
                    <div class="preview-logo">å°å‹åšç¾</div>
                    <div class="preview-controls"></div>
                  </div>
                  <div class="preview-message user">æ‚¨å¥½ï¼Œè¯·é—®å¦‚ä½•ä¼˜åŒ–æˆ‘çš„æç¤ºè¯ï¼Ÿ</div>
                  <div class="preview-message bot">
                    è¦ä¼˜åŒ–æç¤ºè¯ï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼šä½¿ç”¨æ¸…æ™°å…·ä½“çš„æŒ‡ç¤ºã€æä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯ã€è®¾å®šåˆé€‚çš„è§’è‰²å’Œæ ¼å¼è¦æ±‚ã€åˆ†æ­¥éª¤å¼•å¯¼å›ç­”ã€‚
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" @click="resetThemeSettings">é‡ç½®</button>
          <button class="confirm-btn" @click="applyThemeSettings">åº”ç”¨</button>
        </div>
      </div>
    </div>
    
    <!-- æç¤ºè¯åº“å¼¹å‡ºå±‚ -->
    <div class="modal-overlay" v-if="showPromptLibrary" @mousedown="handleModalOverlayMouseDown" @mouseup="handlePromptLibraryOverlayMouseUp">
      <div class="modal-container prompt-library" @click.stop style="max-width: 900px; width: 90%; max-height: 80vh;">
        <div class="modal-header">
          <h3>æç¤ºè¯åº“</h3>
          <button class="modal-close" @click="showPromptLibrary = false">Ã—</button>
        </div>
        <div class="modal-body" style="max-height: calc(80vh - 120px); overflow-y: auto;">
          <div class="prompt-library-toolbar">
            <div class="prompt-search">
              <input 
                type="text" 
                v-model="promptSearchQuery" 
                placeholder="æœç´¢æç¤ºè¯..." 
                class="prompt-search-input"
              />
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </div>
            <div class="prompt-filters">
              <button 
                :class="['filter-btn', currentPromptFilter === 'all' ? 'active' : '']" 
                @click="currentPromptFilter = 'all'"
              >
                å…¨éƒ¨
              </button>
              <button 
                :class="['filter-btn', currentPromptFilter === 'writing' ? 'active' : '']" 
                @click="currentPromptFilter = 'writing'"
              >
                å†™ä½œ
              </button>
              <button 
                :class="['filter-btn', currentPromptFilter === 'coding' ? 'active' : '']" 
                @click="currentPromptFilter = 'coding'"
              >
                ç¼–ç¨‹
              </button>
              <button 
                :class="['filter-btn', currentPromptFilter === 'analysis' ? 'active' : '']" 
                @click="currentPromptFilter = 'analysis'"
              >
                åˆ†æ
              </button>
              <button 
                :class="['filter-btn', currentPromptFilter === 'creativity' ? 'active' : '']" 
                @click="currentPromptFilter = 'creativity'"
              >
                åˆ›æ„
              </button>
              <button 
                :class="['filter-btn', currentPromptFilter === 'education' ? 'active' : '']" 
                @click="currentPromptFilter = 'education'"
              >
                æ•™è‚²
              </button>
            </div>
            <button class="add-prompt-btn" @click="openAddPromptModal">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              æ–°å¢æç¤ºè¯
            </button>
          </div>
          
          <div class="prompts-container">
            <div class="prompts-grid">
              <div 
                v-for="prompt in filteredPrompts" 
                :key="prompt.id" 
                class="prompt-card"
                :style="{ borderColor: getPromptCategoryColor(prompt.category) }"
                @mouseover="(event) => showPromptPreview(prompt, event)"
                @mouseleave="hidePromptPreview()"
              >
                <div class="prompt-card-header" :style="{ backgroundColor: getPromptCategoryColor(prompt.category) }">
                  <span class="prompt-name">{{ prompt.name }}</span>
                  <div class="prompt-category-badge">{{ getCategoryLabel(prompt.category) }}</div>
                </div>
                <div class="prompt-card-body">
                  <div class="prompt-description">{{ prompt.description }}</div>
                  <div class="prompt-tags">
                    <span v-for="(tag, index) in prompt.tags.slice(0, 3)" :key="index" class="prompt-tag">
                      {{ tag }}
                    </span>
                    <span v-if="prompt.tags.length > 3" class="prompt-tag-more">+{{ prompt.tags.length - 3 }}</span>
                  </div>
                </div>
                <div class="prompt-card-footer">
                  <div class="prompt-usage">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9"></path>
                      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                    <span>å·²ä½¿ç”¨ {{ prompt.usageCount }} æ¬¡</span>
                  </div>
                  <div class="prompt-actions">
                    <button class="prompt-action-btn copy-btn" @click.stop="copyPromptToInput(prompt)" title="å¤åˆ¶åˆ°è¾“å…¥æ¡†">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                      </svg>
                    </button>
                    <button class="prompt-action-btn edit-btn" @click.stop="editPrompt(prompt)" title="ç¼–è¾‘æç¤ºè¯">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </button>
                    <button class="prompt-action-btn delete-btn" @click.stop="deletePrompt(prompt.id)" title="åˆ é™¤æç¤ºè¯">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                        <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="no-prompts" v-if="filteredPrompts.length === 0">
              æ²¡æœ‰åŒ¹é…çš„æç¤ºè¯
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æç¤ºè¯é¢„è§ˆæç¤º -->
    <div class="prompt-preview-tooltip" v-if="showPreview" :style="previewPosition">
      <div class="preview-header">å†…å®¹é¢„è§ˆ</div>
      <div class="preview-content">{{ previewContent }}</div>
    </div>
    
    <!-- æ–°å¢/ç¼–è¾‘æç¤ºè¯å¼¹å‡ºå±‚ -->
    <div class="modal-overlay" v-if="showPromptModal" @mousedown="handleModalOverlayMouseDown" @mouseup="handlePromptModalOverlayMouseUp">
      <div class="modal-container prompt-modal" @click.stop>
        <div class="modal-header">
          <h3>{{ isEditingPrompt ? 'ç¼–è¾‘æç¤ºè¯' : 'æ–°å¢æç¤ºè¯' }}</h3>
          <button class="modal-close" @click="showPromptModal = false">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="prompt-form">
            <div class="form-group">
              <label for="promptName">æç¤ºè¯åç§°</label>
              <input type="text" id="promptName" v-model="editingPrompt.name" placeholder="è¾“å…¥æç¤ºè¯åç§°">
            </div>
            
            <div class="form-group">
              <label for="promptCategory">ç±»å‹</label>
              <select id="promptCategory" v-model="editingPrompt.category">
                <option value="writing">å†™ä½œ</option>
                <option value="coding">ç¼–ç¨‹</option>
                <option value="analysis">åˆ†æ</option>
                <option value="creativity">åˆ›æ„</option>
                <option value="education">æ•™è‚²</option>
                <option value="other">å…¶ä»–</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="promptDescription">ç®€çŸ­æè¿°</label>
              <input type="text" id="promptDescription" v-model="editingPrompt.description" placeholder="ç®€çŸ­æè¿°æ­¤æç¤ºè¯çš„ç”¨é€”">
            </div>
            
            <div class="form-group">
              <label for="promptTags">æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)</label>
              <input type="text" id="promptTags" v-model="promptTagsInput" placeholder="ä¾‹å¦‚: ä¸“ä¸š,æŠ¥å‘Š,å·¥ä½œ">
            </div>
            
            <div class="form-group">
              <label for="promptContent">æç¤ºè¯å†…å®¹</label>
              
              <textarea 
                id="promptContent" 
                v-model="editingPrompt.content" 
                placeholder="è¾“å…¥æç¤ºè¯å†…å®¹..." 
                rows="8"
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" @click="showPromptModal = false">å–æ¶ˆ</button>
          <button class="confirm-btn" @click="savePrompt">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, watch, nextTick, computed } from 'vue';
import { marked } from 'marked';

// é…ç½® marked
marked.setOptions({
  breaks: true, // å…è®¸æ¢è¡Œ
  gfm: true,    // å¯ç”¨GFM
  headerIds: false // ç¦ç”¨è‡ªåŠ¨æ·»åŠ id
});

// APIåŸºç¡€URL
const API_BASE_URL = import.meta.env.VITE_APP_AI_API_URL || 'http://localhost:28928';

// èŠå¤©æ¶ˆæ¯
interface Message {
  role: 'user' | 'bot';
  content: string;
  time: string;
  thinking?: string; // æ·»åŠ æ€è€ƒå†…å®¹å­—æ®µ
}

// å†å²è®°å½•
interface HistoryItem {
  id: number;
  title: string;
  time: string;
  tags?: string[]; // æ·»åŠ æ ‡ç­¾å­—æ®µ
  exportedFormats?: string[]; // æ·»åŠ å¯¼å‡ºæ ¼å¼è®°å½•
}

// æ ‡ç­¾ç±»å‹
interface Tag {
  id: number;
  name: string;
  color: string;
}

// æ–‡ä»¶ç±»å‹
interface FileItem {
  id: number;
  name: string;
  type: string;
  size: number;
  uploadTime: string;
  aiAccessible: boolean; // æ˜¯å¦å…è®¸AIè®¿é—®è¯¥æ–‡ä»¶
  description?: string;
}

// ä¸»é¢˜è®¾ç½®
interface ThemeOption {
  id: string;
  name: string;
  primaryColor: string;
  secondaryColor: string;
  backgroundColor: string;
  textColor: string;
  accentColor: string;
  preview: string; // CSS gradient for preview
}

// æç¤ºè¯æ¨¡æ¿
interface PromptTemplate {
  id: number;
  name: string;
  description: string;
  content: string;
  category: string;
  tags: string[];
  usageCount: number;
}

// æç¤ºè¯è¯„åˆ†
interface PromptEvaluation {
  clarity: number; // æ¸…æ™°åº¦
  specificity: number; // å…·ä½“åº¦
  context: number; // ä¸Šä¸‹æ–‡
  conciseness: number; // ç®€æ´åº¦
  structure: number; // ç»“æ„æ€§
  overall: number; // æ€»ä½“è¯„åˆ†
  suggestions: string[]; // æ”¹è¿›å»ºè®®
}

// å­—ä½“è®¾ç½®
interface FontSetting {
  size: 'small' | 'medium' | 'large';
  spacing: 'compact' | 'normal' | 'relaxed';
  family: 'default' | 'serif' | 'mono';
}

const userInput = ref('');
const messages = ref<Message[]>([]);
const isTyping = ref(false);
const chatContentRef = ref<HTMLElement | null>(null);
const inputRef = ref<HTMLTextAreaElement | null>(null);
const sidebarCollapsed = ref(false);
const useCloudModel = ref(false); // æ˜¯å¦ä½¿ç”¨äº‘ç«¯å¤§æ¨¡å‹
const streamController = ref<AbortController | null>(null); // ç”¨äºæ§åˆ¶æµå¼è¯·æ±‚

// åç«¯æœåŠ¡å™¨é…ç½®

// ä¸»é¢˜è®¾ç½®ç›¸å…³çŠ¶æ€
const showThemeSettings = ref(false);
const isDarkMode = ref(false);
const currentTheme = ref('default');
const currentFontSettings = ref<FontSetting>({
  size: 'medium',
  spacing: 'normal',
  family: 'default'
});

// æç¤ºè¯å·¥ç¨‹å·¥å…·ç›¸å…³çŠ¶æ€
const showPromptEngineer = ref(false);
const currentPrompt = ref('');
const promptName = ref('');
const promptCategory = ref('general');
const promptTags = ref<string[]>([]);
const currentTemplateId = ref<number | null>(null);
const isEvaluating = ref(false);
const promptEvaluation = ref<PromptEvaluation>({
  clarity: 0,
  specificity: 0,
  context: 0,
  conciseness: 0,
  structure: 0,
  overall: 0,
  suggestions: []
});

// é¢„å®šä¹‰çš„ä¸»é¢˜
const themeOptions = ref<ThemeOption[]>([
  {
    id: 'default',
    name: 'é»˜è®¤è“',
    primaryColor: '#4665ee',
    secondaryColor: '#f0f0f3',
    backgroundColor: '#f7f7f9',
    textColor: '#333333',
    accentColor: '#FF6B95',
    preview: 'linear-gradient(to right, #4665ee, #6B8CFF)'
  },
  {
    id: 'emerald',
    name: 'ç¿¡ç¿ ç»¿',
    primaryColor: '#10b981',
    secondaryColor: '#ecfdf5',
    backgroundColor: '#f8fafc',
    textColor: '#1e293b',
    accentColor: '#8b5cf6',
    preview: 'linear-gradient(to right, #10b981, #34d399)'
  },
  {
    id: 'sunset',
    name: 'æ™šéœæ©™',
    primaryColor: '#f97316',
    secondaryColor: '#fff7ed',
    backgroundColor: '#fffbf5',
    textColor: '#431407',
    accentColor: '#3b82f6',
    preview: 'linear-gradient(to right, #f97316, #fb923c)'
  },
  {
    id: 'lavender',
    name: 'è–°è¡£è‰',
    primaryColor: '#8b5cf6',
    secondaryColor: '#f5f3ff',
    backgroundColor: '#faf5ff',
    textColor: '#581c87',
    accentColor: '#ec4899',
    preview: 'linear-gradient(to right, #8b5cf6, #a78bfa)'
  },
  {
    id: 'graphite',
    name: 'çŸ³å¢¨é»‘',
    primaryColor: '#334155',
    secondaryColor: '#f1f5f9',
    backgroundColor: '#f8fafc',
    textColor: '#0f172a',
    accentColor: '#6366f1',
    preview: 'linear-gradient(to right, #334155, #475569)'
  }
]);

// æ–‡ä»¶ç®¡ç†ç›¸å…³çŠ¶æ€
const showFileManager = ref(false);
const userFiles = ref<FileItem[]>([
  { 
    id: 1, 
    name: 'äº§å“è¯´æ˜ä¹¦.pdf', 
    type: 'pdf', 
    size: 2560000, 
    uploadTime: '2023-06-15', 
    aiAccessible: true,
    description: 'åŒ…å«å…¬å¸æœ€æ–°äº§å“çš„è¯¦ç»†è¯´æ˜å’Œä½¿ç”¨æŒ‡å—'
  },
  { 
    id: 2, 
    name: 'å‘˜å·¥æ‰‹å†Œ.docx', 
    type: 'docx', 
    size: 1280000, 
    uploadTime: '2023-05-20', 
    aiAccessible: true,
    description: 'å…¬å¸å‘˜å·¥æ‰‹å†Œï¼ŒåŒ…å«å…¬å¸æ”¿ç­–å’Œè§„ç« åˆ¶åº¦'
  },
  { 
    id: 3, 
    name: 'è´¢åŠ¡æŠ¥è¡¨.xlsx', 
    type: 'xlsx', 
    size: 856000, 
    uploadTime: '2023-06-01', 
    aiAccessible: false,
    description: 'å…¬å¸2023å¹´Q2è´¢åŠ¡æŠ¥è¡¨ï¼ˆæ•æ„Ÿèµ„æ–™ï¼‰'
  }
]);
const selectedFile = ref<number | null>(null);
const currentFilter = ref('all'); // 'all', 'accessible', 'restricted'
const fileSearchQuery = ref('');
const showFileUploadModal = ref(false);
const newFile = ref<FileItem>({
  id: 0,
  name: '',
  type: '',
  size: 0,
  uploadTime: '',
  aiAccessible: true,
  description: ''
});

// æ ‡ç­¾åŠŸèƒ½ç›¸å…³çŠ¶æ€
const availableTags = ref<Tag[]>([
  { id: 1, name: 'é‡è¦', color: '#FF6B95' },
  { id: 2, name: 'å·¥ä½œ', color: '#4665ee' },
  { id: 3, name: 'å­¦ä¹ ', color: '#42b983' },
  { id: 4, name: 'å‚è€ƒ', color: '#f39c12' },
]);
const showTagSelector = ref(false);
const selectedHistoryItem = ref<number | null>(null);
const newTagName = ref('');
const selectedTags = ref<string[]>([]);
const editingChatTitle = ref(''); // æ·»åŠ ä¼šè¯æ ‡é¢˜ç¼–è¾‘å˜é‡

// å¯¼å‡ºåŠŸèƒ½ç›¸å…³çŠ¶æ€
const exportFormats = [
  { id: 'pdf', name: 'PDF æ–‡ä»¶' },
  { id: 'markdown', name: 'Markdown æ–‡ä»¶' },
  { id: 'txt', name: 'æ–‡æœ¬æ–‡ä»¶' },
];
const showExportMenu = ref(false);

// çœŸå®å†å²è®°å½•æ•°æ®
const chatHistory = ref<HistoryItem[]>([]);

// Toast æ¶ˆæ¯çŠ¶æ€
const toast = ref({
  show: false,
  message: ''
});

// åŠŸèƒ½ç‰¹ç‚¹å±•ç¤º
const features = [
  {
    icon: 'ğŸ”',
    title: 'çŸ¥è¯†åº“æ£€ç´¢',
    description: 'ç²¾å‡†æ£€ç´¢ä¼ä¸šçŸ¥è¯†åº“ï¼Œå›ç­”ä¸“ä¸šé—®é¢˜'
  },
  {
    icon: 'ğŸ’¬',
    title: 'å¤šè½®å¯¹è¯',
    description: 'æ”¯æŒä¸Šä¸‹æ–‡ç†è§£ä¸çŠ¶æ€ä¿æŒ'
  },
  {
    icon: 'ğŸ“„',
    title: 'æ–‡æ¡£å¤„ç†',
    description: 'è‡ªåŠ¨è§£æå¤šç§æ ¼å¼æ–‡æ¡£å¹¶å‘é‡åŒ–'
  },
  {
    icon: 'âš¡',
    title: 'æµå¼å“åº”',
    description: 'å®æ—¶æ‰“å­—æ•ˆæœï¼Œæå‡ç”¨æˆ·ä½“éªŒ'
  }
];

// æ˜¾ç¤º Toast æ¶ˆæ¯
const showToast = (message: string) => {
  toast.value.message = message;
  toast.value.show = true;
  
  // 3ç§’åè‡ªåŠ¨å…³é—­
  setTimeout(() => {
    toast.value.show = false;
  }, 3000);
};

// è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
const adjustTextareaHeight = () => {
  if (!inputRef.value) return;
  
  // é‡ç½®é«˜åº¦ä»¥ä¾¿é‡æ–°è®¡ç®—
  inputRef.value.style.height = 'auto';
  
  // è®¡ç®—æ–°çš„é«˜åº¦ï¼ˆæœ€å¤§é«˜åº¦ä¸º150pxï¼‰
  const newHeight = Math.min(150, inputRef.value.scrollHeight);
  
  // è®¾ç½®æ–°é«˜åº¦
  inputRef.value.style.height = `${newHeight}px`;
};

// ç›‘å¬è¾“å…¥å†…å®¹å˜åŒ–ï¼Œè‡ªåŠ¨è°ƒæ•´é«˜åº¦
watch(userInput, () => {
  nextTick(adjustTextareaHeight);
});

// åˆ‡æ¢ä¾§è¾¹æ 
const toggleSidebar = () => {
  sidebarCollapsed.value = !sidebarCollapsed.value;
  // æœ¬åœ°å­˜å‚¨ç”¨æˆ·åå¥½
  localStorage.setItem('sidebarCollapsed', String(sidebarCollapsed.value));
};

// åˆ é™¤å†å²è®°å½•
const deleteHistory = async (index: number) => {
  try {
    const selectedChatId = chatHistory.value[index].id;
    
    // å‘åç«¯å‘é€åˆ é™¤è¯·æ±‚
    const response = await fetch(`${API_BASE_URL}/ai/chat/deleteChatHistoryList`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        chatId: selectedChatId.toString()
      })
    });
    
    const result = await response.json();
    
    // åªæœ‰è¯·æ±‚æˆåŠŸæ—¶æ‰ä»æœ¬åœ°åˆ é™¤
    if (result.code === "200") {
      // ä»æœ¬åœ°åˆ é™¤
      chatHistory.value.splice(index, 1);
      
      // å¦‚æœå½“å‰æ­£åœ¨æ˜¾ç¤ºè¢«åˆ é™¤çš„å¯¹è¯ï¼Œåˆ™æ¸…ç©ºæ¶ˆæ¯
      if (messages.value.length > 0) {
        messages.value = [];
      }
      
      showToast('å·²åˆ é™¤è¯¥å¯¹è¯');
    } else {
      // è¯·æ±‚å¤±è´¥
      showToast('åˆ é™¤å¤±è´¥: ' + (result.userMessage || result.message || 'è¯·æ±‚é”™è¯¯'));
      console.warn('åˆ é™¤ä¼šè¯è¯·æ±‚å¤±è´¥:', result);
    }
  } catch (error) {
    console.error('åˆ é™¤ä¼šè¯è¯·æ±‚é”™è¯¯:', error);
    showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
  }
};

// å¼€å§‹æ–°å¯¹è¯
const startNewChat = async () => {
  // ç«‹å³æ¸…ç©ºå½“å‰æ¶ˆæ¯ï¼Œæä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ
  messages.value = [];
  
  // ç”ŸæˆchatId
  const newChatId = Date.now().toString();
  console.log('ç”Ÿæˆæ–°ä¼šè¯chatId:', newChatId);
  
  // ç”Ÿæˆå½“å‰æ—¶é—´
  const currentDate = new Date();
  
  // åˆ›å»ºæ–°ä¼šè¯çš„æ•°æ®
  const newChatData = {
    chatId: newChatId,
    chatTittle: "æ–°å»ºä¼šè¯", // é»˜è®¤æ ‡é¢˜ï¼Œä½¿ç”¨chatTittleè€Œä¸æ˜¯title
    chatTag: [], // é»˜è®¤æ— æ ‡ç­¾
    createTime: formatDateToFriendly(currentDate),
    updateTime: formatDateToFriendly(currentDate)
  };
  
  // å…ˆåœ¨æœ¬åœ°æ·»åŠ ä¸€ä¸ªä¸´æ—¶è®°å½•ï¼Œæä¾›å³æ—¶åé¦ˆ
  const tempHistoryItem: HistoryItem = {
    id: parseInt(newChatId),
    title: newChatData.chatTittle, // ä½¿ç”¨chatTittle
    time: newChatData.updateTime,
    tags: []
  };
  
  chatHistory.value = [tempHistoryItem, ...chatHistory.value];
  selectedHistoryItem.value = 0; // é€‰ä¸­æ–°åˆ›å»ºçš„ä¼šè¯
  
  // æ˜¾ç¤ºæ–°å»ºæˆåŠŸæç¤º
  showToast('å·²åˆ›å»ºæ–°å¯¹è¯');
  
  // åœ¨åå°å‘é€è¯·æ±‚åˆ›å»ºä¼šè¯
  try {
    const response = await fetch(`${API_BASE_URL}/ai/chat/insertChatHistoryList`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(newChatData)
    });
    
    const result = await response.json();
    
    if (result.code === "200" && result.data) {
      console.log('æ–°å»ºä¼šè¯æˆåŠŸï¼ŒchatId:', newChatId);
      // ä¸è¦è°ƒç”¨fetchAllChatHistoryï¼Œè¿™å¯èƒ½å¯¼è‡´chatIdå˜åŒ–
      // fetchAllChatHistory();
    } else {
      console.warn('æ–°å»ºä¼šè¯è¯·æ±‚å¤±è´¥ï¼Œä½†ç”¨æˆ·ç•Œé¢å·²æ›´æ–°:', result.message);
    }
  } catch (error) {
    console.error('æ–°å»ºä¼šè¯è¯·æ±‚é”™è¯¯:', error);
    // å³ä½¿è¯·æ±‚å¤±è´¥ï¼Œç”¨æˆ·ä»ç„¶å¯ä»¥ç»§ç»­ä½¿ç”¨æ–°ä¼šè¯ï¼Œåªæ˜¯æœªä¿å­˜åˆ°æœåŠ¡å™¨
  }
};

// å°†æ—¥æœŸè½¬æ¢ä¸ºå‹å¥½æ ¼å¼ï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€xå¤©å‰ï¼‰
const formatDateToFriendly = (date: Date): string => {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const dateDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  
  // è®¡ç®—å¤©æ•°å·®å¼‚
  const diffInDays = Math.floor((today.getTime() - dateDay.getTime()) / (1000 * 60 * 60 * 24));
  
  if (diffInDays === 0) {
    return 'ä»Šå¤©';
  } else if (diffInDays === 1) {
    return 'æ˜¨å¤©';
  } else if (diffInDays < 7) {
    return `${diffInDays}å¤©å‰`;
  } else {
    // è¶…è¿‡7å¤©åˆ™è¿”å›å…·ä½“æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  }
};

// å°†å‹å¥½æ ¼å¼çš„æ—¥æœŸè½¬å›å®é™…æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆç”¨äºå‘é€åˆ°æœåŠ¡å™¨ï¼‰
const friendlyToActualDate = (friendlyDate: string): string => {
  const now = new Date();
  
  if (friendlyDate === 'ä»Šå¤©') {
    return now.toISOString().split('T')[0];
  } else if (friendlyDate === 'æ˜¨å¤©') {
    const yesterday = new Date(now);
    yesterday.setDate(now.getDate() - 1);
    return yesterday.toISOString().split('T')[0];
  } else if (friendlyDate.endsWith('å¤©å‰')) {
    const days = parseInt(friendlyDate.replace('å¤©å‰', ''), 10);
    const pastDate = new Date(now);
    pastDate.setDate(now.getDate() - days);
    return pastDate.toISOString().split('T')[0];
  }
  
  // å¦‚æœæ˜¯æ—¥æœŸæ ¼å¼ï¼Œç›´æ¥è¿”å›
  return friendlyDate;
};

// è·å–å½“å‰æ—¶é—´
const getCurrentTime = () => {
  const now = new Date();
  return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
};

// å‘é€æ¶ˆæ¯å¹¶è·å–å›å¤
const sendMessage = async () => {
  if (!userInput.value.trim()) return;
  
  const userMessage = userInput.value.trim();
  userInput.value = '';
  
  // è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
  nextTick(adjustTextareaHeight);
  
  // è·å–å½“å‰æ—¶é—´
  const now = new Date();
  const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  
  // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©ä¼šè¯
  if (selectedHistoryItem.value === null) {
    // å¦‚æœæ²¡æœ‰é€‰æ‹©ä¼šè¯ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯
    await startNewChat();
  }
  
  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°æ¶ˆæ¯åˆ—è¡¨
  messages.value.push({
    role: 'user',
    content: userMessage,
    time: timeStr
  });
  
  // è®¾ç½®AIæ­£åœ¨è¾“å…¥çŠ¶æ€
  isTyping.value = true;
  
  // æ»šåŠ¨åˆ°åº•éƒ¨
  nextTick(scrollToBottom);
  
  try {
    if (useCloudModel.value) {
      // ä½¿ç”¨äº‘ç«¯æ¨¡å‹
      await chatWithServer(userMessage);
    } else {
      // ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿå›å¤
      await simulateResponse(userMessage);
    }
  } catch (error) {
    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
    messages.value.push({
      role: 'bot',
      content: 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚',
      time: timeStr
    });
  } finally {
    // ç¡®ä¿ä¸å†æ˜¾ç¤ºæ‰“å­—ä¸­çŠ¶æ€
    isTyping.value = false;
    nextTick(scrollToBottom);
  }
};

// ä¸æœåŠ¡å™¨é€šä¿¡
const chatWithServer = async (prompt: string) => {
  try {
    // å‡†å¤‡æŸ¥è¯¢å‚æ•°
    const queryParams = new URLSearchParams({
      prompt: prompt
    });
    
    
    // æ·»åŠ ä¼šè¯ID
    if (selectedHistoryItem.value !== null) {
      const currentChatId = chatHistory.value[selectedHistoryItem.value].id.toString();
      queryParams.append('chatId', currentChatId);
      console.log('ä½¿ç”¨ä¼šè¯ID:', currentChatId, 'ç±»å‹:', typeof chatHistory.value[selectedHistoryItem.value].id);
      
      // è°ƒè¯•chatHistory
      console.log('å½“å‰chatHistory:', JSON.stringify(chatHistory.value));
      console.log('selectedHistoryItemç´¢å¼•:', selectedHistoryItem.value);
    } else {
      console.error('æœªé€‰æ‹©ä¼šè¯ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
      throw new Error('æœªé€‰æ‹©ä¼šè¯');
    }
    
    // åˆ›å»ºAbortControllerä»¥ä¾¿éœ€è¦æ—¶å¯ä»¥ä¸­æ­¢è¯·æ±‚
    if (streamController.value) {
      streamController.value.abort();
    }
    streamController.value = new AbortController();
    
    // è·å–å½“å‰æ—¶é—´
    const now = new Date();
    const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    
    // å…ˆæ·»åŠ ä¸€ä¸ªç©ºçš„å›å¤æ¶ˆæ¯ï¼Œåç»­ä¼šæ›´æ–°å®ƒ
    const messageIndex = messages.value.length;
    messages.value.push({
      role: 'bot',
      content: '',
      thinking: '',
      time: timeStr
    });
    
    // å‘é€æ¶ˆæ¯æ—¶å·²è®¾ç½®isTyping = trueï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤è®¾ç½®
    
    // å‘é€GETè¯·æ±‚å¹¶å¤„ç†æµå¼å“åº”
    const response = await fetch(`${API_BASE_URL}/ai/chat/chat_for_stream?${queryParams.toString()}`, {
      method: 'GET',
      headers: {
        'Accept': 'text/html, text/plain, */*'
      },
      signal: streamController.value.signal
    });
    
    // æ£€æŸ¥å“åº”çŠ¶æ€
    if (!response.ok) {
      // æ£€æŸ¥æ˜¯å¦ä¸ºJSONé”™è¯¯å“åº”
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const errorData = await response.json();
        if (errorData && errorData.code === "999") {
          throw new Error(errorData.userMessage || "å½“å‰åŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•");
        }
      }
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    // ç›´æ¥ä»æµä¸­è¯»å–æ•°æ®
    try {
      const reader = response.body?.getReader();
      const decoder = new TextDecoder('utf-8');
      let responseText = '';
      
      // å¦‚æœæ²¡æœ‰readerï¼Œè¡¨ç¤ºæµè§ˆå™¨ä¸æ”¯æŒæµå¼å“åº”
      if (!reader) {
        const text = await response.text();
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯JSONé”™è¯¯å“åº”
        try {
          const errorData = JSON.parse(text);
          if (errorData && errorData.code === "999") {
            throw new Error(errorData.userMessage || "å½“å‰åŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•");
          }
        } catch (jsonError) {
          // è§£æJSONå‡ºé”™ï¼ŒæŒ‰æ–‡æœ¬å¤„ç†
        }
        
        const parsedResponse = parseResponse(text);
        
        // æ›´æ–°æ¶ˆæ¯å†…å®¹
        messages.value[messageIndex].content = parsedResponse.response;
        messages.value[messageIndex].thinking = parsedResponse.thinking;
        
        isTyping.value = false;
        return;
      }
      
      // å¤„ç†æµå¼å“åº”
      try {
        while (true) {
          const { done, value } = await reader.read();
          
          if (done) {
            break;
          }
          
          // è§£ç å¹¶æ·»åŠ åˆ°å“åº”æ–‡æœ¬
          const chunk = decoder.decode(value, { stream: true });
          responseText += chunk;
          
          console.log('æ”¶åˆ°æ•°æ®å—:', chunk); // è°ƒè¯•ä¿¡æ¯
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯JSONé”™è¯¯å“åº”
          if (responseText.trim().startsWith('{"code":"999"')) {
            try {
              const errorData = JSON.parse(responseText);
              if (errorData && errorData.code === "999") {
                throw new Error(errorData.userMessage || "å½“å‰åŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•");
              }
            } catch (jsonError) {
              // è§£æé”™è¯¯ï¼Œç»§ç»­å¤„ç†
            }
          }
          
          // è§£æå½“å‰ç´¯ç§¯çš„å“åº”
          const parsedResponse = parseResponse(responseText);
          
          // æ›´æ–°æ¶ˆæ¯å†…å®¹
          messages.value[messageIndex].content = parsedResponse.response;
          messages.value[messageIndex].thinking = parsedResponse.thinking;
          
          // å¦‚æœæœ‰å†…å®¹äº†ï¼Œä¸”ä¸æ˜¯åœ¨æ€è€ƒä¸­ï¼Œåˆ™éšè—æ‰“å­—æŒ‡ç¤ºå™¨
          // å¦‚æœåªæœ‰æ€è€ƒå†…å®¹ï¼Œä¿æŒæ‰“å­—æŒ‡ç¤ºå™¨æ˜¾ç¤º
          const hasThinkingOnly = parsedResponse.thinking && !parsedResponse.response;
          if ((parsedResponse.response && !hasThinkingOnly) || 
              (parsedResponse.thinking && parsedResponse.thinking.includes('</think>'))) {
            isTyping.value = false;
          }
          
          // æ»šåŠ¨åˆ°åº•éƒ¨
          scrollToBottom();
        }
      } catch (error) {
        if (error.name === 'AbortError') {
          console.log('è¯·æ±‚è¢«ä¸­æ­¢');
        } else {
          throw error;
        }
      } finally {
        // ç¡®ä¿æœ€åçš„è§£ç 
        const finalChunk = decoder.decode();
        if (finalChunk) {
          responseText += finalChunk;
          
          const parsedResponse = parseResponse(responseText);
          messages.value[messageIndex].content = parsedResponse.response;
          messages.value[messageIndex].thinking = parsedResponse.thinking;
        }
        
        isTyping.value = false;
      }
    } catch (error) {
      if (error.name !== 'AbortError') {
        console.error('å¤„ç†æµå“åº”å¤±è´¥:', error);
        showToast('è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        
        // å¦‚æœå·²ç»æ·»åŠ äº†æ¶ˆæ¯ï¼Œåˆ™æ›´æ–°ä¸ºé”™è¯¯æ¶ˆæ¯
        if (messages.value.length > 0 && messages.value[messages.value.length - 1].role === 'bot') {
          messages.value[messages.value.length - 1].content = 'æŠ±æ­‰ï¼Œä¸æœåŠ¡å™¨é€šä¿¡å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚';
        }
      }
      isTyping.value = false;
    }
  } catch (error) {
    if (error.name !== 'AbortError') {
      console.error('ä¸æœåŠ¡å™¨é€šä¿¡å¤±è´¥:', error);
      
      // æå–é”™è¯¯æ¶ˆæ¯
      let errorMessage = 'è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
      
      // æ£€æŸ¥æ˜¯å¦åŒ…å«ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
      if (error.message && 
         (error.message.includes('å½“å‰åŠŸèƒ½ä¸å¯ç”¨') || 
          error.message.includes('Exception'))) {
        errorMessage = error.message;
      }
      
      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      showToast(errorMessage);
      
      // å¦‚æœå·²ç»æ·»åŠ äº†æ¶ˆæ¯ï¼Œåˆ™æ›´æ–°ä¸ºé”™è¯¯æ¶ˆæ¯
      if (messages.value.length > 0 && messages.value[messages.value.length - 1].role === 'bot') {
        messages.value[messages.value.length - 1].content = `æŠ±æ­‰ï¼Œ${errorMessage}`;
      }
    }
    isTyping.value = false;
  }
};

// æ¨¡æ‹Ÿæœ¬åœ°å›å¤ï¼ˆç°æœ‰åŠŸèƒ½ï¼‰
const simulateResponse = async (input: string) => {
  // å»¶è¿Ÿä»¥æ¨¡æ‹Ÿ API å“åº”æ—¶é—´
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  const now = new Date();
  const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  
  let botResponse = '';
  let thinking = '';
  
  // æ¨¡æ‹Ÿå›å¤é€»è¾‘
  if (input.includes('ä½ å¥½') || input.includes('å—¨') || input.includes('hi') || input.includes('hello')) {
    thinking = 'ç”¨æˆ·æ‰“æ‹›å‘¼äº†ï¼Œæˆ‘åº”è¯¥ç¤¼è²Œåœ°å›åº”å¹¶è¡¨ç¤ºæ„¿æ„æä¾›å¸®åŠ©ã€‚';
    botResponse = 'ä½ å¥½ï¼æˆ‘æ˜¯å°å‹åšç¾ï¼Œå¾ˆé«˜å…´ä¸ºä½ æœåŠ¡ã€‚ä½ æœ‰ä»€ä¹ˆéœ€è¦å¸®åŠ©çš„å—ï¼Ÿ';
  } else if (input.includes('åŠŸèƒ½') || input.includes('èƒ½åšä»€ä¹ˆ')) {
    thinking = 'ç”¨æˆ·æƒ³äº†è§£æˆ‘çš„åŠŸèƒ½ï¼Œæˆ‘åº”è¯¥è¯¦ç»†åˆ—å‡ºæˆ‘èƒ½åšçš„äº‹æƒ…ã€‚';
    botResponse = 'æˆ‘å¯ä»¥å¸®ä½ å†™ä»£ç ã€è¯»æ–‡ä»¶ã€å›ç­”é—®é¢˜ã€å†™ä½œå„ç§åˆ›æ„å†…å®¹ï¼Œè¿˜å¯ä»¥è¿æ¥åˆ°ä½ çš„çŸ¥è¯†åº“å›ç­”ä¸“ä¸šé—®é¢˜ã€‚è¯·å‘Šè¯‰æˆ‘ä½ éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ';
  } else if (input.includes('çŸ¥è¯†åº“')) {
    thinking = 'ç”¨æˆ·è¯¢é—®çŸ¥è¯†åº“åŠŸèƒ½ï¼Œæˆ‘åº”è¯¥è§£é‡Šè¿™ä¸ªç‰¹æ€§çš„å·¥ä½œåŸç†å’Œä¼˜åŠ¿ã€‚';
    botResponse = 'æˆ‘ä»¬çš„çŸ¥è¯†åº“åŠŸèƒ½å…è®¸æ‚¨ä¸Šä¼ å’Œç´¢å¼•å…¬å¸æ–‡æ¡£ï¼Œç„¶åAIåŠ©æ‰‹å¯ä»¥åŸºäºè¿™äº›æ–‡æ¡£å›ç­”é—®é¢˜ã€‚æ”¯æŒå¤šç§æ ¼å¼å¦‚PDFã€Wordå’ŒExcelï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨æå–å’Œå‘é‡åŒ–å†…å®¹ä»¥å®ç°è¯­ä¹‰æœç´¢ã€‚';
  } else if (input.includes('markdown')) {
    thinking = 'ç”¨æˆ·æåˆ°äº†Markdownï¼Œæˆ‘åº”è¯¥å±•ç¤ºä¸€äº›Markdownæ ¼å¼çš„ç¤ºä¾‹ã€‚';
    botResponse = 'è¿™æ˜¯Markdownæ ¼å¼çš„ç¤ºä¾‹ï¼š\n\n# æ ‡é¢˜1\n## æ ‡é¢˜2\n### æ ‡é¢˜3\n\n- åˆ—è¡¨é¡¹1\n- åˆ—è¡¨é¡¹2\n\n```javascript\n// ä»£ç ç¤ºä¾‹\nfunction hello() {\n  console.log("Hello world!");\n}\n```\n\n**ç²—ä½“æ–‡æœ¬** å’Œ *æ–œä½“æ–‡æœ¬*';
  } else {
    thinking = 'è¿™æ˜¯ä¸€ä¸ªä¸€èˆ¬æ€§çš„é—®é¢˜ï¼Œæˆ‘å°†ç»™å‡ºå‹å¥½çš„å›åº”ï¼Œå¹¶å‘ŠçŸ¥ç”¨æˆ·è¿™æ˜¯æ¼”ç¤ºæ¨¡å¼ã€‚';
    botResponse = 'æ„Ÿè°¢ä½ çš„æé—®ã€‚åœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œæˆ‘ä¼šæ ¹æ®ä½ çš„é—®é¢˜ç»™å‡ºè¯¦ç»†çš„å›ç­”ã€‚ç°åœ¨ç³»ç»Ÿå¤„äºæ¼”ç¤ºæ¨¡å¼ï¼Œå¦‚éœ€æ›´å¤šå¸®åŠ©ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€é€šå®Œæ•´åŠŸèƒ½ã€‚';
  }
  
  // æ·»åŠ AIå›å¤
  messages.value.push({
    role: 'bot',
    content: botResponse,
    thinking: thinking,
    time: timeStr
  });
  
  // å¦‚æœæ˜¯æ–°å¯¹è¯ï¼Œå¯èƒ½éœ€è¦åˆ›å»ºä¼šè¯
  if (selectedHistoryItem.value === null && messages.value.length === 2) {
    // ç¬¬ä¸€æ¬¡å¯¹è¯æ—¶åˆ›å»ºæ–°ä¼šè¯
    const title = input.length > 20 ? input.substring(0, 20) + '...' : input;
    
    // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
    const tempItem: HistoryItem = {
      id: Date.now(),
      title: title,
      time: 'åˆšåˆš',
      tags: []
    };
    
    chatHistory.value = [tempItem, ...chatHistory.value];
    selectedHistoryItem.value = 0;
  }
};

// ç”¨æˆ·æ§åˆ¶æ»šåŠ¨çš„æ ‡å¿—
const userScrolling = ref(false);
const lastScrollTop = ref(0);

// æ»šåŠ¨åˆ°åº•éƒ¨
const scrollToBottom = () => {
  // å¦‚æœç”¨æˆ·æ­£åœ¨æ‰‹åŠ¨æ»šåŠ¨ï¼Œåˆ™ä¸æ‰§è¡Œè‡ªåŠ¨æ»šåŠ¨
  if (userScrolling.value) return;
  
  if (chatContentRef.value) {
    chatContentRef.value.scrollTop = chatContentRef.value.scrollHeight;
  }
};

// æ£€æµ‹ç”¨æˆ·æ»šåŠ¨è¡Œä¸º
const handleScroll = () => {
  if (!chatContentRef.value) return;
  
  // è·å–å½“å‰æ»šåŠ¨ä½ç½®
  const currentScrollTop = chatContentRef.value.scrollTop;
  const maxScrollTop = chatContentRef.value.scrollHeight - chatContentRef.value.clientHeight;
  
  // å¦‚æœç”¨æˆ·å‘ä¸Šæ»šåŠ¨æˆ–è·ç¦»åº•éƒ¨è¶…è¿‡100pxï¼Œæ ‡è®°ä¸ºç”¨æˆ·æ»šåŠ¨
  if (currentScrollTop < lastScrollTop.value || (maxScrollTop - currentScrollTop) > 100) {
    userScrolling.value = true;
  }
  
  // å¦‚æœç”¨æˆ·æ»šåŠ¨åˆ°æ¥è¿‘åº•éƒ¨ï¼Œæ¢å¤è‡ªåŠ¨æ»šåŠ¨
  if ((maxScrollTop - currentScrollTop) < 30) {
    userScrolling.value = false;
  }
  
  // æ›´æ–°æœ€åæ»šåŠ¨ä½ç½®
  lastScrollTop.value = currentScrollTop;
};

// ç›‘å¬æ¶ˆæ¯å˜åŒ–ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
watch(messages, () => {
  nextTick(() => {
    scrollToBottom();
  });
});

// è¿”å›é¦–é¡µ
const goToHome = () => {
  // ä½¿ç”¨Vue Routerå¯¼èˆªåˆ°é¦–é¡µ
  window.location.href = '/ai';
  // ä¹Ÿå¯ä»¥ä½¿ç”¨router.push('/ai') å¦‚æœæœ‰å¼•å…¥router
};

// è·å–æ ‡ç­¾é¢œè‰²
const getTagColor = (tagName: string) => {
  const tag = availableTags.value.find(t => t.name === tagName);
  return tag ? tag.color : '#999';
};

// æ›´æ–°ä¼šè¯
const updateChatHistory = async (chatId: number, updates: any) => {
  try {
    // æ„å»ºæ›´æ–°è¯·æ±‚æ•°æ®
    const updateData = {
      chatId: chatId.toString(),
      ...updates
    };
    
    // å‘é€æ›´æ–°è¯·æ±‚
    const response = await fetch(`${API_BASE_URL}/ai/chat/updateChatHistoryList`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updateData)
    });
    
    const result = await response.json();
    
    if (result.code === "200") {
      // æ›´æ–°æˆåŠŸ
      showToast('ä¼šè¯å·²æ›´æ–°');
      // åˆ·æ–°ä¼šè¯åˆ—è¡¨
      fetchAllChatHistory();
      return true;
    } else {
      // è¯·æ±‚å¤±è´¥
      showToast('æ›´æ–°å¤±è´¥: ' + (result.userMessage || result.message || 'è¯·æ±‚é”™è¯¯'));
      console.warn('æ›´æ–°ä¼šè¯å¤±è´¥:', result);
      return false;
    }
  } catch (error) {
    console.error('æ›´æ–°ä¼šè¯è¯·æ±‚é”™è¯¯:', error);
    showToast('æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    return false;
  }
};

// ä¿å­˜æ ‡ç­¾åˆ°ä¼šè¯
const saveTagsToChat = async () => {
  if (selectedHistoryItem.value === null) return;
  
  const chatId = chatHistory.value[selectedHistoryItem.value].id;
  const tags = selectedTags.value;
  const title = editingChatTitle.value.trim();
  
  // æ£€æŸ¥æ ‡é¢˜æ˜¯å¦ä¸ºç©º
  if (!title) {
    showToast('ä¼šè¯æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
    return;
  }
  
  // å‡†å¤‡æ›´æ–°æ•°æ®
  const updateData = {
    chatTittle: title,
    chatTag: tags,
    updateTime: formatDateToFriendly(new Date())
  };
  
  // æ˜¾ç¤ºæ›´æ–°ä¸­æç¤º
  showToast('æ­£åœ¨æ›´æ–°ä¼šè¯...');
  
  // è°ƒç”¨é€šç”¨æ›´æ–°å‡½æ•°
  const success = await updateChatHistory(chatId, updateData);
  
  if (success) {
    // å…³é—­é€‰æ‹©å™¨
    showTagSelector.value = false;
  }
};

// æ‰“å¼€æ ‡ç­¾é€‰æ‹©å™¨
const openTagSelector = (index: number) => {
  selectedHistoryItem.value = index;
  
  // åˆå§‹åŒ–å·²é€‰æ ‡ç­¾
  if (chatHistory.value[index].tags) {
    selectedTags.value = [...chatHistory.value[index].tags];
  } else {
    selectedTags.value = [];
  }
  
  // åˆå§‹åŒ–ä¼šè¯æ ‡é¢˜
  editingChatTitle.value = chatHistory.value[index].title;
  
  showTagSelector.value = true;
};

// æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²è¢«é€‰ä¸­
const isTagSelected = (tagName: string) => {
  return selectedTags.value.includes(tagName);
};

// åˆ‡æ¢æ ‡ç­¾é€‰æ‹©çŠ¶æ€
const toggleTag = (tagName: string) => {
  if (isTagSelected(tagName)) {
    selectedTags.value = selectedTags.value.filter(t => t !== tagName);
  } else {
    selectedTags.value.push(tagName);
  }
};

// æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
const addCustomTag = () => {
  if (!newTagName.value.trim()) return;
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ ‡ç­¾
  if (!availableTags.value.some(t => t.name === newTagName.value)) {
    // éšæœºç”Ÿæˆæ ‡ç­¾é¢œè‰²
    const colors = ['#FF6B95', '#4665ee', '#42b983', '#f39c12', '#e74c3c', '#9b59b6', '#3498db'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    // æ·»åŠ åˆ°å¯ç”¨æ ‡ç­¾åˆ—è¡¨
    availableTags.value.push({
      id: availableTags.value.length + 1,
      name: newTagName.value,
      color: randomColor
    });
  }
  
  // å¦‚æœæ²¡æœ‰è¢«é€‰ä¸­ï¼Œåˆ™é€‰ä¸­è¯¥æ ‡ç­¾
  if (!isTagSelected(newTagName.value)) {
    selectedTags.value.push(newTagName.value);
  }
  
  // æ¸…ç©ºè¾“å…¥æ¡†
  newTagName.value = '';
};

// æ‰“å¼€å¯¼å‡ºèœå•
const openExportMenu = (index: number) => {
  selectedHistoryItem.value = index;
  showExportMenu.value = true;
};

// å¯¼å‡ºå¯¹è¯
const exportConversation = (format: string) => {
  if (selectedHistoryItem.value === null) return;
  
  // è¿™é‡Œæ˜¯æ¨¡æ‹Ÿå¯¼å‡ºåŠŸèƒ½ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦å®ç°çœŸæ­£çš„å¯¼å‡ºé€»è¾‘
  const item = chatHistory.value[selectedHistoryItem.value];
  
  // è®°å½•å¯¼å‡ºæ ¼å¼
  if (!item.exportedFormats) {
    item.exportedFormats = [];
  }
  if (!item.exportedFormats.includes(format)) {
    item.exportedFormats.push(format);
  }
  
  // æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸæç¤º
  showToast(`å¯¹è¯å·²å¯¼å‡ºä¸º${format.toUpperCase()}æ ¼å¼`);
  showExportMenu.value = false;
  
  // å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ç”Ÿæˆå¹¶ä¸‹è½½å¯¹åº”æ ¼å¼çš„æ–‡ä»¶
  // ä¾‹å¦‚ä½¿ç”¨ html2pdf åº“ç”Ÿæˆ PDFï¼Œæˆ–è€…ç”Ÿæˆ markdown æ–‡æœ¬å¹¶ä¸‹è½½
};

// åŠ è½½å¯¹è¯
const loadConversation = async (index: number) => {
  try {
    const chatId = chatHistory.value[index].id;
    selectedHistoryItem.value = index;
    
    // æ¸…ç©ºå½“å‰æ¶ˆæ¯
    messages.value = [];
    
    // æ˜¾ç¤ºåŠ è½½æç¤º
    showToast(`æ­£åœ¨åŠ è½½å¯¹è¯: ${chatHistory.value[index].title}`);
    
    // å‘é€è¯·æ±‚è·å–èŠå¤©è®°å½•
    const response = await fetch(`${API_BASE_URL}/ai/chat/getChatHistoryById?chatId=${chatId}`);
    const result = await response.json();
    
    if (Array.isArray(result)) {
      // å°†æ¥å£è¿”å›çš„æ•°æ®è½¬æ¢ä¸ºæ¶ˆæ¯æ ¼å¼
      result.forEach(item => {
        const now = new Date();
        const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        
        // è§£æassistantæ¶ˆæ¯ä¸­çš„æ€è€ƒå†…å®¹
        let thinking = '';
        let content = item.chatContent;
        
        if (item.chatRole === 'assistant') {
          const parsedResponse = parseResponse(item.chatContent);
          content = parsedResponse.response;
          thinking = parsedResponse.thinking;
        }
        
        messages.value.push({
          role: item.chatRole === 'user' ? 'user' : 'bot',
          content: content,
          thinking: thinking,
          time: timeStr
        });
      });
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      nextTick(scrollToBottom);
    } else {
      showToast('æ— æ³•åŠ è½½å¯¹è¯è®°å½•');
      console.error('è·å–èŠå¤©è®°å½•è¿”å›æ ¼å¼é”™è¯¯:', result);
    }
  } catch (error) {
    console.error('åŠ è½½å¯¹è¯è®°å½•å¤±è´¥:', error);
    showToast('åŠ è½½å¯¹è¯è®°å½•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
  }
};

// é™åˆ¶æ ‡ç­¾æ˜¾ç¤ºæ•°é‡ï¼Œé¿å…æ¢è¡Œ
const limitTags = (tags: string[]) => {
  // æœ€å¤šæ˜¾ç¤º4ä¸ªæ ‡ç­¾ï¼Œç¡®ä¿åœ¨åŒä¸€è¡Œå†…å±•ç¤º
  return tags.slice(0, 4);
};

// æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨
const openFileManager = () => {
  showFileManager.value = true;
};

// è¿‡æ»¤æ–‡ä»¶
const filteredFiles = computed(() => {
  let result = userFiles.value;
  
  // åº”ç”¨è¿‡æ»¤å™¨
  if (currentFilter.value === 'accessible') {
    result = result.filter(file => file.aiAccessible);
  } else if (currentFilter.value === 'restricted') {
    result = result.filter(file => !file.aiAccessible);
  }
  
  // åº”ç”¨æœç´¢
  if (fileSearchQuery.value) {
    const query = fileSearchQuery.value.toLowerCase();
    result = result.filter(file => 
      file.name.toLowerCase().includes(query) ||
      (file.description && file.description.toLowerCase().includes(query))
    );
  }
  
  return result;
});

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
const formatFileSize = (size: number) => {
  if (size < 1024) {
    return `${size} B`;
  } else if (size < 1024 * 1024) {
    return `${(size / 1024).toFixed(1)} KB`;
  } else {
    return `${(size / (1024 * 1024)).toFixed(1)} MB`;
  }
};

// é€‰æ‹©æ–‡ä»¶
const selectFile = (id: number) => {
  selectedFile.value = id;
};

// åˆ‡æ¢æ–‡ä»¶AIè®¿é—®æƒé™
const toggleAccess = (id: number) => {
  const fileIndex = userFiles.value.findIndex(file => file.id === id);
  if (fileIndex !== -1) {
    userFiles.value[fileIndex].aiAccessible = !userFiles.value[fileIndex].aiAccessible;
    showToast(`${userFiles.value[fileIndex].name} ${userFiles.value[fileIndex].aiAccessible ? 'ç°åœ¨å¯è¢«AIè®¿é—®' : 'ç°åœ¨å¯¹AIå—é™'}`);
  }
};

// åˆ é™¤æ–‡ä»¶
const deleteFile = (id: number) => {
  const fileIndex = userFiles.value.findIndex(file => file.id === id);
  if (fileIndex !== -1) {
    const fileName = userFiles.value[fileIndex].name;
    userFiles.value = userFiles.value.filter(file => file.id !== id);
    showToast(`æ–‡ä»¶ ${fileName} å·²åˆ é™¤`);
    
    if (selectedFile.value === id) {
      selectedFile.value = null;
    }
  }
};

// æ‰“å¼€ä¸Šä¼ æ–‡ä»¶æ¨¡æ€æ¡†
const openUploadModal = () => {
  // é‡ç½®æ–°æ–‡ä»¶è¡¨å•
  newFile.value = {
    id: Date.now(),
    name: '',
    type: '',
    size: 0,
    uploadTime: '',
    aiAccessible: true,
    description: ''
  };
  showFileUploadModal.value = true;
};

// ä¸Šä¼ æ–‡ä»¶ï¼ˆæ¨¡æ‹Ÿï¼‰
const uploadFile = () => {
  if (!newFile.value.name) {
    showToast('è¯·è¾“å…¥æ–‡ä»¶åç§°');
    return;
  }
  
  // ç¡®å®šæ–‡ä»¶ç±»å‹ï¼ˆæ¨¡æ‹Ÿï¼‰
  if (newFile.value.name.endsWith('.pdf')) {
    newFile.value.type = 'pdf';
  } else if (newFile.value.name.endsWith('.docx') || newFile.value.name.endsWith('.doc')) {
    newFile.value.type = 'docx';
  } else if (newFile.value.name.endsWith('.xlsx') || newFile.value.name.endsWith('.xls')) {
    newFile.value.type = 'xlsx';
  } else {
    // å¦‚æœæ²¡æœ‰æ‰©å±•åï¼Œæ·»åŠ é»˜è®¤æ‰©å±•å
    if (!newFile.value.name.includes('.')) {
      newFile.value.name += '.pdf';
      newFile.value.type = 'pdf';
    } else {
      newFile.value.type = 'other';
    }
  }
  
  // æ¨¡æ‹Ÿéšæœºæ–‡ä»¶å¤§å° (100KB - 5MB)
  newFile.value.size = Math.floor(Math.random() * 5 * 1024 * 1024) + 100 * 1024;
  
  // æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
  userFiles.value.push({...newFile.value});
  
  showToast(`æ–‡ä»¶ ${newFile.value.name} ä¸Šä¼ æˆåŠŸ`);
  showFileUploadModal.value = false;
};

onMounted(() => {
  // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
  if (inputRef.value) {
    inputRef.value.focus();
  }
  
  // æ¢å¤ä¾§è¾¹æ çŠ¶æ€
  const savedState = localStorage.getItem('sidebarCollapsed');
  if (savedState) {
    sidebarCollapsed.value = savedState === 'true';
  }
  
  // åŠ è½½ä¿å­˜çš„ä¸»é¢˜è®¾ç½®
  loadSavedThemeSettings();
  
  // ç›‘å¬å…¨å±€ç‚¹å‡»äº‹ä»¶
  document.body.addEventListener('click', () => {
    showPreview.value = false;
  });
  
  // åˆå§‹åŒ–è¾“å…¥æ¡†é«˜åº¦
  nextTick(adjustTextareaHeight);
  
  // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬ï¼Œå®æ—¶è°ƒæ•´é«˜åº¦
  if (inputRef.value) {
    inputRef.value.addEventListener('input', adjustTextareaHeight);
  }
  
  // è·å–æ‰€æœ‰èŠå¤©å†å²
  fetchAllChatHistory();
});

// æ‰“å¼€ä¸»é¢˜è®¾ç½®
const openThemeSettings = () => {
  showThemeSettings.value = true;
};

// è®¾ç½®ä¸»é¢˜
const setTheme = (themeId: string) => {
  currentTheme.value = themeId;
};

// è®¾ç½®æ˜æš—æ¨¡å¼
const setDarkMode = (isDark: boolean) => {
  isDarkMode.value = isDark;
};

// è®¾ç½®å­—ä½“å¤§å°
const setFontSize = (size: 'small' | 'medium' | 'large') => {
  currentFontSettings.value.size = size;
};

// è®¾ç½®å­—ä½“é—´è·
const setFontSpacing = (spacing: 'compact' | 'normal' | 'relaxed') => {
  currentFontSettings.value.spacing = spacing;
};

// è®¾ç½®å­—ä½“é£æ ¼
const setFontFamily = (family: 'default' | 'serif' | 'mono') => {
  currentFontSettings.value.family = family;
};

// é‡ç½®ä¸»é¢˜è®¾ç½®
const resetThemeSettings = () => {
  currentTheme.value = 'default';
  isDarkMode.value = false;
  currentFontSettings.value = {
    size: 'medium',
    spacing: 'normal',
    family: 'default'
  };
};

// åº”ç”¨ä¸»é¢˜è®¾ç½®
const applyThemeSettings = () => {
  // ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
  localStorage.setItem('pomeranian_theme', currentTheme.value);
  localStorage.setItem('pomeranian_darkMode', isDarkMode.value.toString());
  localStorage.setItem('pomeranian_fontSettings', JSON.stringify(currentFontSettings.value));
  
  showToast('ä¸ªæ€§åŒ–è®¾ç½®å·²åº”ç”¨');
  showThemeSettings.value = false;
};

// åŠ è½½å·²ä¿å­˜çš„ä¸»é¢˜è®¾ç½®
const loadSavedThemeSettings = () => {
  const savedTheme = localStorage.getItem('pomeranian_theme');
  const savedDarkMode = localStorage.getItem('pomeranian_darkMode');
  const savedFontSettings = localStorage.getItem('pomeranian_fontSettings');
  
  if (savedTheme) {
    currentTheme.value = savedTheme;
  }
  
  if (savedDarkMode) {
    isDarkMode.value = savedDarkMode === 'true';
  }
  
  if (savedFontSettings) {
    try {
      const parsedSettings = JSON.parse(savedFontSettings);
      currentFontSettings.value = {
        size: parsedSettings.size || 'medium',
        spacing: parsedSettings.spacing || 'normal',
        family: parsedSettings.family || 'default'
      };
    } catch (error) {
      console.error('Failed to parse saved font settings:', error);
    }
  }
};

// é¢„å®šä¹‰çš„æç¤ºè¯æ¨¡æ¿
const promptTemplates = ref<PromptTemplate[]>([
  {
    id: 1,
    name: 'ä¸“ä¸šæ–‡æ¡£å†™ä½œ',
    description: 'åˆ›å»ºä¸“ä¸šçš„æ–‡æ¡£ã€æŠ¥å‘Šæˆ–ç™½çš®ä¹¦',
    content: 'è¯·ä»¥[ä¸“ä¸šé¢†åŸŸ]ä¸“å®¶çš„èº«ä»½ï¼Œåˆ›å»ºä¸€ä»½å…³äº[ä¸»é¢˜]çš„è¯¦ç»†æ–‡æ¡£ã€‚åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š\n1. æ‰§è¡Œæ‘˜è¦\n2. èƒŒæ™¯ä¿¡æ¯\n3. å…³é”®å‘ç°\n4. è¯¦ç»†åˆ†æ\n5. ç»“è®ºä¸å»ºè®®\nä½¿ç”¨ä¸“ä¸šä½†æ¸…æ™°çš„è¯­è¨€ï¼Œå¹¶æä¾›å…·ä½“ç¤ºä¾‹æˆ–æ•°æ®æ”¯æŒä½ çš„åˆ†æã€‚',
    category: 'writing',
    tags: ['ä¸“ä¸š', 'æŠ¥å‘Š', 'æ–‡æ¡£'],
    usageCount: 125
  },
  {
    id: 2,
    name: 'ä»£ç ä¼˜åŒ–',
    description: 'åˆ†æå¹¶ä¼˜åŒ–ç°æœ‰ä»£ç ',
    content: 'è¯·åˆ†æä»¥ä¸‹[ç¼–ç¨‹è¯­è¨€]ä»£ç å¹¶æä¾›ä¼˜åŒ–å»ºè®®ï¼š\n```\n[åœ¨æ­¤ç²˜è´´ä»£ç ]\n```\n\nè¯·ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æä¾›ä¼˜åŒ–ï¼š\n1. æ€§èƒ½ä¼˜åŒ–\n2. ä»£ç ç®€æ´æ€§\n3. å¯è¯»æ€§ä¸å¯ç»´æŠ¤æ€§\n4. æœ€ä½³å®è·µéµå¾ª\n5. æ½œåœ¨é”™è¯¯ä¿®å¤\n\nå¯¹äºæ¯ä¸ªå»ºè®®ï¼Œè¯·è¯´æ˜åŸå› å¹¶æä¾›æ”¹è¿›åçš„ä»£ç ç¤ºä¾‹ã€‚',
    category: 'coding',
    tags: ['ä»£ç ', 'ä¼˜åŒ–', 'å¼€å‘'],
    usageCount: 98
  },
  {
    id: 3,
    name: 'å†³ç­–åˆ†ææ¡†æ¶',
    description: 'ç³»ç»Ÿåˆ†æå¤æ‚å†³ç­–é—®é¢˜',
    content: 'æˆ‘éœ€è¦å°±[å†³ç­–é—®é¢˜]åšå‡ºå†³å®šã€‚è¯·ä½¿ç”¨SWOTåˆ†ææ¡†æ¶å¸®æˆ‘åˆ†æï¼š\n\n1. ä¼˜åŠ¿ï¼šè¿™ä¸ªé€‰é¡¹æœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼Ÿ\n2. åŠ£åŠ¿ï¼šå­˜åœ¨ä»€ä¹ˆæ½œåœ¨ç¼ºç‚¹æˆ–é™åˆ¶ï¼Ÿ\n3. æœºä¼šï¼šé€‰æ‹©æ­¤æ–¹æ¡ˆå¯èƒ½å¸¦æ¥ä»€ä¹ˆæœºä¼šï¼Ÿ\n4. å¨èƒï¼šæœ‰å“ªäº›æ½œåœ¨é£é™©æˆ–å¤–éƒ¨å› ç´ éœ€è¦è€ƒè™‘ï¼Ÿ\n\nåˆ†æå®Œæˆåï¼Œè¯·åŸºäºä¸Šè¿°å› ç´ æä¾›ä¸€ä¸ªæ˜ç¡®çš„å»ºè®®å’Œè¡ŒåŠ¨è®¡åˆ’ã€‚',
    category: 'analysis',
    tags: ['å†³ç­–', 'åˆ†æ', 'è§„åˆ’'],
    usageCount: 67
  },
  {
    id: 4,
    name: 'åˆ›æ„å¤´è„‘é£æš´',
    description: 'ç”Ÿæˆåˆ›æ–°æƒ³æ³•å’Œè§£å†³æ–¹æ¡ˆ',
    content: 'æˆ‘éœ€è¦å…³äº[ä¸»é¢˜/é—®é¢˜]çš„åˆ›æ–°æƒ³æ³•ã€‚è¯·å¸®æˆ‘è¿›è¡Œå¤´è„‘é£æš´ï¼Œç”Ÿæˆè‡³å°‘10ä¸ªä¸åŒçš„åˆ›æ„æˆ–è§£å†³æ–¹æ¡ˆã€‚\n\nè¦æ±‚ï¼š\n1. æƒ³æ³•åº”è¯¥å¤šæ ·åŒ–ä¸”æœ‰åˆ›æ„\n2. åŒ…æ‹¬ä¸€äº›å¸¸è§„æ€è·¯å’Œä¸€äº›çªç ´æ€§æ€è·¯\n3. å¯¹æ¯ä¸ªæƒ³æ³•æä¾›ç®€çŸ­è¯´æ˜\n4. è€ƒè™‘ä¸åŒè§’åº¦å’Œæ–¹æ³•\n5. æŒ‡å‡ºç‰¹åˆ«æœ‰æ½œåŠ›çš„æƒ³æ³•\n\nä¸è¦å—é™äºå¸¸è§„æ€ç»´ï¼Œé¼“åŠ±æå‡ºå¤§èƒ†åˆ›æ–°çš„æ¦‚å¿µã€‚',
    category: 'creativity',
    tags: ['åˆ›æ„', 'å¤´è„‘é£æš´', 'åˆ›æ–°'],
    usageCount: 83
  },
  {
    id: 5,
    name: 'å­¦ä¹ è¾…å¯¼åŠ©æ‰‹',
    description: 'æ·±å…¥è§£é‡Šå¤æ‚æ¦‚å¿µ',
    content: 'æˆ‘æ­£åœ¨å­¦ä¹ [ä¸»é¢˜/æ¦‚å¿µ]ï¼Œä½†é‡åˆ°äº†ä¸€äº›å›°éš¾ã€‚è¯·ä½ ä½œä¸ºä¸€ä½ç»éªŒä¸°å¯Œçš„è€å¸ˆï¼Œå¸®æˆ‘è§£é‡Šè¿™ä¸ªæ¦‚å¿µã€‚\n\nè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œï¼š\n1. ç”¨ç®€å•çš„è¯­è¨€è§£é‡Šæ ¸å¿ƒæ¦‚å¿µ\n2. æä¾›ä¸€ä¸ªå½¢è±¡çš„ç±»æ¯”æˆ–æ¯”å–»\n3. å±•ç¤ºä¸€ä¸ªç®€å•çš„ä¾‹å­\n4. ç„¶åæä¾›ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­\n5. è§£é‡Šè¿™ä¸ªæ¦‚å¿µåœ¨å®é™…ä¸­çš„åº”ç”¨\n6. æå‡º3-5ä¸ªé—®é¢˜ä¾›æˆ‘æ€è€ƒï¼Œä»¥æ£€éªŒæˆ‘çš„ç†è§£\n\nå¦‚æœæœ‰ä»»ä½•ä¸“ä¸šæœ¯è¯­ï¼Œè¯·åŒæ—¶æä¾›è§£é‡Šã€‚',
    category: 'education',
    tags: ['å­¦ä¹ ', 'æ•™è‚²', 'è§£é‡Š'],
    usageCount: 132
  }
]);

// æç¤ºè¯åº“ç›¸å…³çŠ¶æ€
const showPromptLibrary = ref(false);
const currentPromptFilter = ref('all');
const promptSearchQuery = ref('');
const showPromptModal = ref(false);
const isEditingPrompt = ref(false);
const showPreview = ref(false);
const previewContent = ref('');
const previewPosition = ref({ top: '50%', left: '50%' });
const promptTagsInput = ref('');
const editingPrompt = ref<PromptTemplate>({
  id: 0,
  name: '',
  description: '',
  content: '',
  category: 'general',
  tags: [],
  usageCount: 0

});

// æ·»åŠ æ¨¡æ€è’™å±‚çš„é¼ æ ‡äº‹ä»¶å¤„ç†
const modalMouseDownTarget = ref(null);

// å¤„ç†æ¨¡æ€è’™å±‚çš„é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
const handleModalOverlayMouseDown = (event) => {
  // è®°å½•é¼ æ ‡æŒ‰ä¸‹çš„ç›®æ ‡å…ƒç´ 
  modalMouseDownTarget.value = event.target;
};

// å¤„ç†æ¨¡æ€è’™å±‚çš„é¼ æ ‡æ¾å¼€äº‹ä»¶
const handleModalOverlayMouseUp = (event) => {
  // åªæœ‰å½“é¼ æ ‡æŒ‰ä¸‹å’Œæ¾å¼€çš„æ˜¯åŒä¸€ä¸ªå…ƒç´ ï¼Œä¸”æ˜¯è’™å±‚æœ¬èº«æ—¶ï¼Œæ‰å…³é—­å¼¹çª—
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showTagSelector.value = false;
  }
  // é‡ç½®é¼ æ ‡æŒ‰ä¸‹çš„ç›®æ ‡
  modalMouseDownTarget.value = null;
};

// å¤„ç†å¯¼å‡ºèœå•æ¨¡æ€è’™å±‚çš„é¼ æ ‡æ¾å¼€äº‹ä»¶
const handleExportMenuOverlayMouseUp = (event) => {
  // åªæœ‰å½“é¼ æ ‡æŒ‰ä¸‹å’Œæ¾å¼€çš„æ˜¯åŒä¸€ä¸ªå…ƒç´ ï¼Œä¸”æ˜¯è’™å±‚æœ¬èº«æ—¶ï¼Œæ‰å…³é—­å¼¹çª—
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showExportMenu.value = false;
  }
  // é‡ç½®é¼ æ ‡æŒ‰ä¸‹çš„ç›®æ ‡
  modalMouseDownTarget.value = null;
};

// å¤„ç†æ–‡ä»¶ç®¡ç†å™¨æ¨¡æ€è’™å±‚çš„é¼ æ ‡æ¾å¼€äº‹ä»¶
const handleFileManagerOverlayMouseUp = (event) => {
  // åªæœ‰å½“é¼ æ ‡æŒ‰ä¸‹å’Œæ¾å¼€çš„æ˜¯åŒä¸€ä¸ªå…ƒç´ ï¼Œä¸”æ˜¯è’™å±‚æœ¬èº«æ—¶ï¼Œæ‰å…³é—­å¼¹çª—
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showFileManager.value = false;
  }
  // é‡ç½®é¼ æ ‡æŒ‰ä¸‹çš„ç›®æ ‡
  modalMouseDownTarget.value = null;
};

// å¤„ç†æ–‡ä»¶ä¸Šä¼ æ¨¡æ€è’™å±‚çš„é¼ æ ‡æ¾å¼€äº‹ä»¶
const handleFileUploadOverlayMouseUp = (event) => {
  // åªæœ‰å½“é¼ æ ‡æŒ‰ä¸‹å’Œæ¾å¼€çš„æ˜¯åŒä¸€ä¸ªå…ƒç´ ï¼Œä¸”æ˜¯è’™å±‚æœ¬èº«æ—¶ï¼Œæ‰å…³é—­å¼¹çª—
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showFileUploadModal.value = false;
  }
  // é‡ç½®é¼ æ ‡æŒ‰ä¸‹çš„ç›®æ ‡
  modalMouseDownTarget.value = null;
};

// å¤„ç†ä¸»é¢˜è®¾ç½®æ¨¡æ€è’™å±‚çš„é¼ æ ‡æ¾å¼€äº‹ä»¶
const handleThemeSettingsOverlayMouseUp = (event) => {
  // åªæœ‰å½“é¼ æ ‡æŒ‰ä¸‹å’Œæ¾å¼€çš„æ˜¯åŒä¸€ä¸ªå…ƒç´ ï¼Œä¸”æ˜¯è’™å±‚æœ¬èº«æ—¶ï¼Œæ‰å…³é—­å¼¹çª—
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showThemeSettings.value = false;
  }
  // é‡ç½®é¼ æ ‡æŒ‰ä¸‹çš„ç›®æ ‡
  modalMouseDownTarget.value = null;
};

// å¤„ç†æç¤ºè¯åº“æ¨¡æ€è’™å±‚çš„é¼ æ ‡æ¾å¼€äº‹ä»¶
const handlePromptLibraryOverlayMouseUp = (event) => {
  // åªæœ‰å½“é¼ æ ‡æŒ‰ä¸‹å’Œæ¾å¼€çš„æ˜¯åŒä¸€ä¸ªå…ƒç´ ï¼Œä¸”æ˜¯è’™å±‚æœ¬èº«æ—¶ï¼Œæ‰å…³é—­å¼¹çª—
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showPromptLibrary.value = false;
  }
  // é‡ç½®é¼ æ ‡æŒ‰ä¸‹çš„ç›®æ ‡
  modalMouseDownTarget.value = null;
};

// å¤„ç†æç¤ºè¯ç¼–è¾‘æ¨¡æ€è’™å±‚çš„é¼ æ ‡æ¾å¼€äº‹ä»¶
const handlePromptModalOverlayMouseUp = (event) => {
  // åªæœ‰å½“é¼ æ ‡æŒ‰ä¸‹å’Œæ¾å¼€çš„æ˜¯åŒä¸€ä¸ªå…ƒç´ ï¼Œä¸”æ˜¯è’™å±‚æœ¬èº«æ—¶ï¼Œæ‰å…³é—­å¼¹çª—
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showPromptModal.value = false;
  }
  // é‡ç½®é¼ æ ‡æŒ‰ä¸‹çš„ç›®æ ‡
  modalMouseDownTarget.value = null;
};

// æ‰“å¼€æç¤ºè¯åº“
const openPromptLibrary = () => {
  showPromptLibrary.value = true;
};

// è¿‡æ»¤æç¤ºè¯åº“ä¸­çš„æç¤ºè¯
const filteredPrompts = computed(() => {
  let result = [...promptTemplates.value];
  
  // æŒ‰ç±»åˆ«è¿‡æ»¤
  if (currentPromptFilter.value !== 'all') {
    result = result.filter(prompt => prompt.category === currentPromptFilter.value);
  }
  
  // æŒ‰æœç´¢å…³é”®å­—è¿‡æ»¤
  if (promptSearchQuery.value.trim()) {
    const query = promptSearchQuery.value.toLowerCase();
    result = result.filter(prompt => 
      prompt.name.toLowerCase().includes(query) || 
      prompt.description.toLowerCase().includes(query) || 
      prompt.content.toLowerCase().includes(query) ||
      prompt.tags.some(tag => tag.toLowerCase().includes(query))
    );
  }
  
  return result;
});

// è·å–æç¤ºè¯ç±»åˆ«çš„é¢œè‰²
const getPromptCategoryColor = (category: string) => {
  const colorMap: {[key: string]: string} = {
    writing: '#FF6B95',
    coding: '#4665ee',
    analysis: '#42b983',
    creativity: '#f39c12',
    education: '#9b59b6',
    other: '#3498db'
  };
  
  return colorMap[category] || '#3498db';
};

// è·å–æç¤ºè¯ç±»åˆ«çš„æ ‡ç­¾
const getCategoryLabel = (category: string) => {
  const labelMap: {[key: string]: string} = {
    writing: 'å†™ä½œ',
    coding: 'ç¼–ç¨‹',
    analysis: 'åˆ†æ',
    creativity: 'åˆ›æ„',
    education: 'æ•™è‚²',
    other: 'å…¶ä»–'
  };
  
  return labelMap[category] || 'å…¶ä»–';
};

// æ˜¾ç¤ºæç¤ºè¯å†…å®¹é¢„è§ˆ
const showPromptPreview = (prompt: PromptTemplate, event: MouseEvent) => {
  previewContent.value = prompt.content;
  
  // è®¡ç®—é¢„è§ˆæ¡†çš„ä½ç½®
  const target = event.currentTarget as HTMLElement;
  const rect = target.getBoundingClientRect();
  
  // è®¡ç®—è§†çª—å¤§å°
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  // é»˜è®¤å®½é«˜
  const previewWidth = 600;
  // æ ¹æ®å†…å®¹é•¿åº¦å†³å®šé¢„è§ˆé«˜åº¦ï¼Œä½†è‡³å°‘200pxï¼Œæœ€å¤š500px
  const previewHeight = 500; // ä½¿ç”¨å›ºå®šæœ€å¤§é«˜åº¦ï¼Œå†…éƒ¨æ»šåŠ¨
  
  // ç¡®å®šå·¦å³ä½ç½® - å¦‚æœå³ä¾§ç©ºé—´ä¸è¶³åˆ™æ˜¾ç¤ºåœ¨å·¦ä¾§
  let left;
  if (rect.right + previewWidth + 20 < viewportWidth) {
    // æ˜¾ç¤ºåœ¨å³ä¾§
    left = `${rect.right + 10}px`;
  } else {
    // æ˜¾ç¤ºåœ¨å·¦ä¾§
    left = `${Math.max(10, rect.left - previewWidth - 10)}px`;
  }
  
  // ç¡®å®šä¸Šä¸‹ä½ç½® - å°½é‡å±…ä¸­å¯¹é½ï¼Œä½†ä¸è¶…å‡ºè§†çª—
  let top = rect.top - 100; // åœ¨å¡ç‰‡ä¸Šæ–¹æ˜¾ç¤ºï¼Œç•™å‡ºç©ºé—´
  top = Math.max(10, Math.min(viewportHeight - previewHeight - 10, top));
  
  // è®¾ç½®é¢„è§ˆæ¡†ä½ç½®
  previewPosition.value = {
    top: `${top}px`,
    left: left,
    maxWidth: `${previewWidth}px`,
    height: `${previewHeight}px`
  };
  
  showPreview.value = true;
};

// éšè—æç¤ºè¯å†…å®¹é¢„è§ˆ
const hidePromptPreview = () => {
  showPreview.value = false;
};

// å¤åˆ¶æç¤ºè¯åˆ°è¾“å…¥æ¡†
const copyPromptToInput = (prompt: PromptTemplate) => {
  userInput.value = prompt.content;
  showPromptLibrary.value = false;
  showPreview.value = false; // ç¡®ä¿å…³é—­é¢„è§ˆ
  
  // å¢åŠ ä½¿ç”¨æ¬¡æ•°
  const index = promptTemplates.value.findIndex(p => p.id === prompt.id);
  if (index !== -1) {
    promptTemplates.value[index].usageCount++;
  }
  
  // èšç„¦è¾“å…¥æ¡†
  nextTick(() => {
    if (inputRef.value) {
      inputRef.value.focus();
    }
  });
  
  // æ˜¾ç¤ºæˆåŠŸæç¤º
  showToast(`å·²å¤åˆ¶"${prompt.name}"åˆ°è¾“å…¥æ¡†`);
};

// æ‰“å¼€æ–°å¢æç¤ºè¯æ¨¡æ€æ¡†
const openAddPromptModal = () => {
  isEditingPrompt.value = false;
  editingPrompt.value = {
    id: Date.now(),
    name: '',
    description: '',
    content: '',
    category: 'writing',
    tags: [],
    usageCount: 0
  };
  promptTagsInput.value = '';
  showPromptModal.value = true;
};

// ç¼–è¾‘æç¤ºè¯
const editPrompt = (prompt: PromptTemplate) => {
  isEditingPrompt.value = true;
  editingPrompt.value = { ...prompt };
  promptTagsInput.value = prompt.tags.join(',');
  showPromptModal.value = true;
};

// ä¿å­˜æç¤ºè¯
const savePrompt = () => {
  // éªŒè¯è¡¨å•
  if (!editingPrompt.value.name.trim()) {
    showToast('è¯·è¾“å…¥æç¤ºè¯åç§°');
    return;
  }
  
  if (!editingPrompt.value.content.trim()) {
    showToast('è¯·è¾“å…¥æç¤ºè¯å†…å®¹');
    return;
  }
  
  // å¤„ç†æ ‡ç­¾
  if (promptTagsInput.value.trim()) {
    editingPrompt.value.tags = promptTagsInput.value.split(',')
      .map(tag => tag.trim())
      .filter(tag => tag.length > 0);
  } else {
    editingPrompt.value.tags = [];
  }
  
  if (isEditingPrompt.value) {
    // æ›´æ–°ç°æœ‰æç¤ºè¯
    const index = promptTemplates.value.findIndex(p => p.id === editingPrompt.value.id);
    if (index !== -1) {
      promptTemplates.value[index] = { ...editingPrompt.value };
      showToast('æç¤ºè¯æ›´æ–°æˆåŠŸ');
    }
  } else {
    // æ·»åŠ æ–°æç¤ºè¯
    promptTemplates.value.push({ ...editingPrompt.value });
    showToast('æç¤ºè¯æ·»åŠ æˆåŠŸ');
  }
  
  showPromptModal.value = false;
};

// åˆ é™¤æç¤ºè¯
const deletePrompt = (id: number) => {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºè¯å—ï¼Ÿ')) {
    const index = promptTemplates.value.findIndex(p => p.id === id);
    if (index !== -1) {
      const promptName = promptTemplates.value[index].name;
      promptTemplates.value.splice(index, 1);
      showToast(`æç¤ºè¯"${promptName}"å·²åˆ é™¤`);
    }
  }
};

// ç›‘å¬æç¤ºè¯åº“æ˜¾ç¤ºçŠ¶æ€
watch(showPromptLibrary, (newValue) => {
  if (!newValue) {
    // å½“æç¤ºè¯åº“å…³é—­æ—¶ï¼Œç¡®ä¿é¢„è§ˆä¹Ÿå…³é—­
    showPreview.value = false;
  }
});

// ç›‘å¬å…¨å±€ç‚¹å‡»äº‹ä»¶
onMounted(() => {
  document.body.addEventListener('click', () => {
    showPreview.value = false;
  });
});

// è·å–æ‰€æœ‰èŠå¤©å†å²
const fetchAllChatHistory = async () => {
  try {
    const response = await fetch(`${API_BASE_URL}/ai/chat/getAllChatHistoryList`);
    const result = await response.json() as ApiResponse<{allChatHistoryList: string}>;
    
    if (result.code === "200" && result.data) {
      // å¤„ç†åç«¯è¿”å›çš„å­—ç¬¦ä¸²æ ¼å¼æ•°æ®
      const historyListStr = result.data.allChatHistoryList;
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
      if (!historyListStr || historyListStr === "[]") {
        chatHistory.value = [];
        return;
      }
      
      // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æå­—ç¬¦ä¸²æ ¼å¼çš„æ•°æ®
      const regex = /LlmChatHistoryList\(chatId=(\d+), chatTittle=([^,]+), chatTag=(\[[^\]]*\]), createTime=([^,]+), updateTime=([^\)]+)\)/g;
      const parsedItems: HistoryItem[] = [];
      
      let match;
      while ((match = regex.exec(historyListStr)) !== null) {
        try {
          // è§£ææ ‡ç­¾æ•°ç»„
          let tags: string[] = [];
          try {
            tags = JSON.parse(match[3]);
          } catch (e) {
            console.warn('æ— æ³•è§£ææ ‡ç­¾:', match[3]);
          }
          
          const item: HistoryItem = {
            id: parseInt(match[1], 10),
            title: match[2].trim(),
            time: match[5].trim(), // æ³¨æ„ç´¢å¼•å˜åŒ–
            tags: tags
          };
          parsedItems.push(item);
        } catch (err) {
          console.error('è§£æå•ä¸ªå†å²è®°å½•å¤±è´¥:', err);
        }
      }
      
      chatHistory.value = parsedItems;
    } else {
      console.warn('è·å–èŠå¤©å†å²å¤±è´¥:', result.message);
      chatHistory.value = [];
    }
  } catch (error) {
    console.error('è·å–èŠå¤©å†å²æ¥å£é”™è¯¯:', error);
    chatHistory.value = [];
  }
};

// è§£ææ¶ˆæ¯å†…å®¹ï¼Œåˆ†ç¦»æ€è€ƒå’Œå›å¤
const parseResponse = (content: string) => {
  let thinking = '';
  let response = content;
  
  // å¤„ç†æ€è€ƒéƒ¨åˆ†
  const thinkOpenTagIndex = content.indexOf('<think>');
  
  if (thinkOpenTagIndex !== -1) {
    // æ‰¾åˆ°å¼€å§‹æ ‡ç­¾
    const afterOpenTag = content.substring(thinkOpenTagIndex + 7); // <think> é•¿åº¦ä¸º7
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç»“æŸæ ‡ç­¾
    const thinkCloseTagIndex = afterOpenTag.indexOf('</think>');
    
    if (thinkCloseTagIndex !== -1) {
      // å®Œæ•´çš„æ€è€ƒå†…å®¹
      thinking = afterOpenTag.substring(0, thinkCloseTagIndex).trim();
      // ç§»é™¤æ•´ä¸ªæ€è€ƒéƒ¨åˆ†ä»å“åº”ä¸­ï¼ŒåŒ…æ‹¬æ ‡ç­¾
      response = content.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
    } else {
      // åªæœ‰å¼€å§‹æ ‡ç­¾ï¼Œè¿˜æ²¡æœ‰ç»“æŸæ ‡ç­¾
      thinking = afterOpenTag.trim();
      // ç§»é™¤ä»å¼€å§‹æ ‡ç­¾åˆ°å†…å®¹ç»“æŸçš„éƒ¨åˆ†
      response = content.substring(0, thinkOpenTagIndex).trim();
    }
  }
  
  return {
    thinking,
    response
  };
};

// æ¸²æŸ“Markdownå†…å®¹
const renderMarkdown = (content: string) => {
  return marked(content);
};

// ä»å“åº”ä¸­æå–chatId
const extractChatIdFromResponse = (responseText: string): string | null => {
  // å°è¯•ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…chatId
  const chatIdRegex = /chatId[=:]\s*["']?(\d+)["']?/i;
  const match = responseText.match(chatIdRegex);
  
  if (match && match[1]) {
    console.log('ä»å“åº”ä¸­æå–åˆ°æ–°çš„chatId:', match[1]);
    return match[1];
  }
  
  // å°è¯•æ£€æŸ¥æ˜¯å¦åŒ…å«JSONæ ¼å¼çš„æ•°æ®
  try {
    // å¯»æ‰¾å¯èƒ½çš„JSONéƒ¨åˆ†
    const jsonStart = responseText.indexOf('{');
    if (jsonStart !== -1) {
      // å°è¯•è§£æJSON
      const possibleJson = responseText.substring(jsonStart);
      const jsonObj = JSON.parse(possibleJson);
      
      // æ£€æŸ¥å¸¸è§çš„chatIdå­—æ®µä½ç½®
      if (jsonObj.chatId) return jsonObj.chatId.toString();
      if (jsonObj.data && jsonObj.data.chatId) return jsonObj.data.chatId.toString();
    }
  } catch (error) {
    // JSONè§£æå¤±è´¥ï¼Œç»§ç»­å…¶ä»–å°è¯•
  }
  
  return null;
};

// åˆ›å»ºæ–°çš„èŠå¤©ä¼šè¯
const createNewChatSession = (prompt: string, chatId: string) => {
  // æ£€æŸ¥æ˜¯å¦å·²ç»é€šè¿‡tempChatIdåˆ›å»ºäº†ä¼šè¯
  if (selectedHistoryItem.value !== null) {
    // å·²ç»æœ‰é€‰ä¸­çš„ä¼šè¯äº†ï¼Œä¸éœ€è¦å†åˆ›å»º
    console.log('å·²æœ‰é€‰ä¸­ä¼šè¯ï¼Œä¸åˆ›å»ºæ–°ä¼šè¯');
    return;
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ªchatIdçš„ä¼šè¯
  const existingSession = chatHistory.value.find(item => item.id === parseInt(chatId, 10));
  if (existingSession) {
    console.log('å·²å­˜åœ¨chatIdä¸º', chatId, 'çš„ä¼šè¯ï¼Œä¸é‡å¤åˆ›å»º');
    return;
  }
  
  // ç¬¬ä¸€æ¬¡å¯¹è¯æ—¶åˆ›å»ºæ–°ä¼šè¯
  const title = prompt.length > 20 ? prompt.substring(0, 20) + '...' : prompt;
  
  // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
  const tempItem: HistoryItem = {
    id: parseInt(chatId, 10),
    title: title,
    time: 'åˆšåˆš',
    tags: []
  };
  
  chatHistory.value = [tempItem, ...chatHistory.value];
  selectedHistoryItem.value = 0;
  
  console.log('åˆ›å»ºæ–°ä¼šè¯æˆåŠŸï¼ŒchatId:', chatId);
};

// åˆ›å»ºæ–°çš„èŠå¤©å†å²è®°å½•
const insertChatHistory = async (title: string, chatId: string) => {
  try {
    // æ ¼å¼åŒ–æ ‡é¢˜
    const formattedTitle = title.length > 20 ? title.substring(0, 20) + '...' : title;
    
    // ç”Ÿæˆå½“å‰æ—¶é—´
    const currentDate = new Date();
    
    // æ„å»ºè¯·æ±‚æ•°æ®
    const chatData = {
      chatId: chatId,
      chatTittle: formattedTitle, // æ³¨æ„åç«¯ä½¿ç”¨çš„æ˜¯chatTittleè€Œä¸æ˜¯title
      chatTag: [], // é»˜è®¤æ— æ ‡ç­¾
      createTime: formatDateToFriendly(currentDate),
      updateTime: formatDateToFriendly(currentDate)
    };
    
    // å‘é€è¯·æ±‚åˆ›å»ºèŠå¤©å†å²
    const response = await fetch(`${API_BASE_URL}/ai/chat/insertChatHistoryList`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(chatData)
    });
    
    const result = await response.json();
    
    if (result.code === "200") {
      // åˆ›å»ºæˆåŠŸï¼Œæ›´æ–°æœ¬åœ°ä¼šè¯åˆ—è¡¨
      const tempItem: HistoryItem = {
        id: parseInt(chatId),
        title: formattedTitle,
        time: 'åˆšåˆš',
        tags: []
      };
      
      chatHistory.value = [tempItem, ...chatHistory.value];
      selectedHistoryItem.value = 0;
      
      console.log('åˆ›å»ºä¼šè¯æˆåŠŸï¼ŒchatId:', chatId);
      return true;
    } else {
      // è¯·æ±‚å¤±è´¥
      console.warn('åˆ›å»ºä¼šè¯å¤±è´¥:', result);
      showToast('åˆ›å»ºä¼šè¯å¤±è´¥: ' + (result.userMessage || result.message || 'è¯·æ±‚é”™è¯¯'));
      return false;
    }
  } catch (error) {
    console.error('åˆ›å»ºä¼šè¯è¯·æ±‚é”™è¯¯:', error);
    showToast('åˆ›å»ºä¼šè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    return false;
  }
};

</script>

<style lang="less" scoped>
.chat-container {
  display: flex;
  height: 100vh;
  overflow: hidden;
  font-family: var(--font-family, 'PingFang SC', 'Microsoft YaHei', sans-serif);
  color: var(--text-color, #333);
  background-color: var(--background-color, #f7f7f9);
  
  // é»˜è®¤ä¸»é¢˜å˜é‡
  --primary-color: #4665ee;
  --secondary-color: #f7f7f9;
  --background-color: #f7f7f9;
  --text-color: #333333;
  --accent-color: #FF6B95;

  // æ·»åŠ ä¸»é¢˜å˜é‡ï¼Œè·Ÿéšç³»ç»Ÿä¸»é¢˜åˆ‡æ¢
  &.theme-default {
    --primary-color: #4665ee;
    --secondary-color: #f7f7f9; // ä¸èƒŒæ™¯è‰²ä¿æŒä¸€è‡´
    --background-color: #f7f7f9;
    --text-color: #333333;
    --accent-color: #FF6B95;
  }

  &.theme-emerald {
    --primary-color: #10b981;
    --secondary-color: #ecfdf5; // è°ƒæ•´å›ç•¥æ·±çš„æ¬¡è¦é¢œè‰²
    --background-color: #f0fbf5; // è°ƒæ•´ä¸ºç•¥å¸¦ç»¿è‰²è°ƒçš„èƒŒæ™¯
    --text-color: #064e3b; // åŠ æ·±æ–‡æœ¬é¢œè‰²
    --accent-color: #7c3aed; // åŠ æ·±ç´«è‰²å¼ºè°ƒè‰²
  }

  &.theme-sunset {
    --primary-color: #f97316;
    --secondary-color: #fff1e6; // æ›´æ˜æ˜¾çš„æ©™è‰²èƒŒæ™¯
    --background-color: #fffaf5; // è°ƒæ•´ä¸ºç•¥å¸¦æ©™è‰²è°ƒçš„èƒŒæ™¯
    --text-color: #7c2d12; // åŠ æ·±æ–‡æœ¬é¢œè‰²
    --accent-color: #2563eb; // æ›´æ·±çš„è“è‰²å¼ºè°ƒ
  }

  &.theme-lavender {
    --primary-color: #8b5cf6;
    --secondary-color: #faf5ff; // ä¸èƒŒæ™¯è‰²ä¿æŒä¸€è‡´
    --background-color: #faf5ff;
    --text-color: #581c87;
    --accent-color: #ec4899;
  }

  &.theme-graphite {
    --primary-color: #334155;
    --secondary-color: #f1f5f9; // æ›´æ˜æ˜¾çš„èƒŒæ™¯è‰²
    --background-color: #f8fafc;
    --text-color: #0f172a;
    --accent-color: #4f46e5; // æ›´äº®çš„å¼ºè°ƒè‰²
  }
  
  /* æ ¹æ®å­—ä½“è®¾ç½®è°ƒæ•´ */
  &.font-size-small {
    font-size: 0.9rem;
  }
  
  &.font-size-medium {
    font-size: 1rem;
  }
  
  &.font-size-large {
    font-size: 1.1rem;
  }
  
  &.font-spacing-compact {
    line-height: 1.4;
  }
  
  &.font-spacing-normal {
    line-height: 1.6;
  }
  
  &.font-spacing-relaxed {
    line-height: 1.8;
  }
  
  &.font-family-default {
    --font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
  }
  
  &.font-family-serif {
    --font-family: 'Noto Serif SC', serif;
  }
  
  &.font-family-mono {
    --font-family: 'Fira Code', 'Source Code Pro', monospace;
  }
  
  /* æ·±è‰²æ¨¡å¼ */
  &.dark-mode {
    --background-color: #1a1a1a;
    --secondary-color: #2a2a2a;
    --text-color: #f0f0f0;
    --sidebar-border-color: #333;
    
    .sidebar {
      background: var(--secondary-color);
      border-right-color: var(--sidebar-border-color);
      
      .sidebar-header {
        border-bottom-color: var(--sidebar-border-color);
      }
      
      .logo {
        color: #fff;
      }
      
      .history-item {
        &:hover {
          background: #333;
        }
      }
      
      .sidebar-footer {
        border-top-color: var(--sidebar-border-color);
      }
    }
    
    .message-content {
      background: #2a2a2a;
      color: #f0f0f0;
      
      .message-time {
        color: #aaa;
      }
    }
    
    .user-message .message-content {
      background: linear-gradient(135deg, #FF9A8B, #FF6B95); // ä¿æŒæ·±è‰²æ¨¡å¼ä¸‹ç”¨æˆ·æ¶ˆæ¯èƒŒæ™¯ä¹Ÿä½¿ç”¨ç²‰è‰²ç³»
    }
    
    .chat-input-area {
      background: #2a2a2a;
      border: 1px solid #333;
      
      .chat-input {
        color: #f0f0f0;
      }
    }
    
    .modal-container {
      background: #2a2a2a;
      color: #f0f0f0;
      
      .modal-header {
        border-bottom-color: #333;
      }
      
      .modal-footer {
        border-top-color: #333;
      }
    }
  }
}

/* ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® */
.sidebar-toggle {
  position: fixed;
  left: 10px;
  top: 10px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 30;
  border: none;
  color: #666;
  transition: all 0.2s;
  
  &:hover {
    background: #f0f0f3;
    color: #333;
    transform: scale(1.05);
  }
  
  svg {
    stroke: currentColor;
  }
}

/* ä¾§è¾¹æ æ ·å¼ */
.sidebar {
  width: 260px;
  background: var(--background-color, #f7f7f9); // ä½¿ç”¨ä¸ä¸»é¡µé¢ç›¸åŒçš„èƒŒæ™¯è‰²
  border-right: 1px solid rgba(0, 0, 0, 0.12); // åŠ æ·±è¾¹æ¡†é¢œè‰²
  display: flex;
  flex-direction: column;
  height: 100%;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.03); // æ·»åŠ è½»å¾®é˜´å½±å¢åŠ å±‚æ¬¡æ„Ÿ
  
  &.sidebar-collapsed {
    width: 0;
    margin-left: -10px;
    border: none;
  }
  
  .sidebar-header {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.12); // åŠ æ·±è¾¹æ¡†é¢œè‰²
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 50px;
    background: rgba(0, 0, 0, 0.02); // è½»å¾®èƒŒæ™¯è‰²åŒºåˆ«
    
    .logo {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color, #333); // ä½¿ç”¨ä¸»é¢˜æ–‡æœ¬é¢œè‰²
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
      
      .logo-icon {
        width: 24px;
        height: 24px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        
        svg {
          width: 100%;
          height: 100%;
        }
      }
      
      span {
        position: relative;
        top: 1px;
      }
    }
    
    .header-buttons {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
    }
    
    .exit-btn,
    .collapse-btn {
      background: transparent;
      border: none;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #666;
      transition: all 0.2s;
      
      &:hover {
        background: rgba(0, 0, 0, 0.05);
        color: #333;
      }
    }
    
    .exit-btn:hover {
      color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
    }
  }
  
  .sidebar-actions {
    padding: 12px;
    
    .new-chat-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 10px;
      background: linear-gradient(135deg, #FF9A8B, #FF6B95);
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 3px 8px rgba(255, 107, 149, 0.3);
      font-weight: 600;
      
      &:hover {
        background: linear-gradient(135deg, #FF8A7B, #FF5B85);
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(255, 107, 149, 0.4);
      }
      
      .btn-icon {
        margin-right: 6px;
        font-weight: bold;
        font-size: 1.1rem;
      }
    }
  }
  
  .history-list {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    
    .history-item {
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
      border: 1px solid rgba(0, 0, 0, 0.04); // æ·»åŠ è½»å¾®è¾¹æ¡†
      
      &:hover {
        background: rgba(0, 0, 0, 0.06); // åŠ æ·±æ‚¬åœæ•ˆæœ
        border-color: rgba(0, 0, 0, 0.08); // åŠ æ·±æ‚¬åœæ—¶è¾¹æ¡†
      }
      
      .history-content {
        flex: 1;
        overflow: hidden;
        
        .history-title {
          font-size: 0.9rem;
          margin-bottom: 4px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          padding-right: 80px;
          position: relative;
        }
        
        .history-meta {
          display: flex;
          align-items: center;
          gap: 6px;
          flex-wrap: nowrap;
          overflow: hidden;
          
          .history-time {
            font-size: 0.75rem;
            color: #888;
            flex-shrink: 0;
          }
          
          .history-tags {
            display: inline-flex;
            flex-wrap: nowrap;
            gap: 4px;
            overflow: hidden;
            
            .history-tag {
              font-size: 0.65rem;
              padding: 1px 5px;
              border-radius: 10px;
              color: white;
              white-space: nowrap;
              font-weight: 500;
              flex-shrink: 0;
            }
          }
        }
      }
      
      .history-actions {
        display: flex;
        position: absolute;
        top: 10px;
        right: 8px;
        gap: 3px;
        
        .history-action-btn {
          background: transparent;
          border: none;
          color: #999;
          width: 24px;
          height: 24px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          opacity: 0.8;
          transition: all 0.2s;
          
          &:hover {
            background: rgba(0, 0, 0, 0.05);
            opacity: 1;
          }
          
          &.tag-btn:hover {
            background: rgba(255, 107, 149, 0.1);
            color: #FF6B95;
          }
          
          &.export-btn:hover {
            background: rgba(70, 101, 238, 0.1);
            color: #4665ee;
          }
          
          &.delete-history-btn:hover {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
          }
        }
      }
    }
  }
  
  .sidebar-footer {
    padding: 12px;
    border-top: 1px solid rgba(0, 0, 0, 0.12); // åŠ æ·±è¾¹æ¡†é¢œè‰²
    background: rgba(0, 0, 0, 0.02); // è½»å¾®èƒŒæ™¯è‰²åŒºåˆ«
    
    .settings-btn,
    .profile-btn {
      width: 100%;
      display: flex;
      align-items: center;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.7); // è½»å¾®ç™½è‰²èƒŒæ™¯
      border: 1px solid rgba(0, 0, 0, 0.1); // åŠ æ·±è¾¹æ¡†
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--text-color, #333); // ä½¿ç”¨ä¸»é¢˜æ–‡æœ¬é¢œè‰²
      
      &:hover {
        background: rgba(0, 0, 0, 0.06); // åŠ æ·±æ‚¬åœæ•ˆæœ
        transform: translateY(-1px); // è½»å¾®æŠ¬èµ·æ•ˆæœ
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); // æ‚¬åœæ—¶æ·»åŠ é˜´å½±
      }
      
      .btn-icon {
        margin-right: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
    
    .settings-btn {
      margin-bottom: 8px;
    }
  }
}

/* ä¸»å†…å®¹åŒºæ ·å¼ */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  
  &.full-width {
    width: 100%;
  }
}

.chat-content {
  flex: 1;
  overflow-y: auto;
  padding: 0;
  scroll-behavior: smooth;
  display: flex;
  flex-direction: column;
  padding-bottom: 150px; // å¢åŠ åº•éƒ¨å†…è¾¹è·ï¼Œè®©èŠå¤©å†…å®¹å‡ºç°åœ¨æ›´ä¸Šæ–¹
  position: relative; // æ·»åŠ ç›¸å¯¹å®šä½ä½œä¸ºè¾“å…¥æ¡†çš„å®šä½åŸºå‡†
}

.welcome-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  margin-top: -100px;
  
  .bot-avatar {
    margin-bottom: 20px;
    width: 150px;
    height: 150px;
    background: linear-gradient(135deg, #FF9A8B, #FF6B95);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 20px rgba(255, 107, 149, 0.4);
    position: relative;
    overflow: hidden;
    
    img {
      width: 180px;
      height: 180px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -42%);
      filter: drop-shadow(0px 2px 5px rgba(0, 0, 0, 0.15));
    }
  }
  
  .welcome-title {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 16px;
    color: #333;
  }
  
  .welcome-subtitle {
    font-size: 1.1rem;
    color: #666;
    max-width: 600px;
    line-height: 1.5;
  }
}

.message-container {
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
  padding: 40px 20px 120px; // å¢åŠ åº•éƒ¨å†…è¾¹è·
  
  .message-item {
    display: flex;
    margin-bottom: 24px;
    
    &.user-message {
      flex-direction: row-reverse;
      justify-content: flex-start; // ä»å³ä¾§å¼€å§‹
      
      .message-avatar {
        margin-right: 0;
        margin-left: 12px;
      }
      
      .message-content {
        background-color: #e9efff;
        margin-right: 0;
        margin-left: auto; // é å³å¯¹é½
        
        .message-text {
          color: #333333;
        }
      }
    }
    
    &.bot-message {
      justify-content: flex-start; // ä»å·¦ä¾§å¼€å§‹
      
      .message-avatar {
        background: #f0f7ff;
      }
      
      .message-content {
        margin-left: 0;
        margin-right: auto; // é å·¦å¯¹é½
      }
    }
    
    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
      margin-right: 12px;
    }
    
    .message-content {
      flex: 0 1 auto; // ä¿®æ”¹ä¸ºè‡ªé€‚åº”å®½åº¦
      min-width: 60px; // è®¾ç½®æœ€å°å®½åº¦
      max-width: 80%; // æœ€å¤§å®½åº¦ä¸ºå®¹å™¨çš„80%
      width: fit-content; // æ ¹æ®å†…å®¹é€‚åº”å®½åº¦
      padding: 12px 16px;
      border-radius: 12px;
      background-color: #f0f0f3;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      align-self: flex-start; // ç¡®ä¿ä¸é¡¶éƒ¨å¯¹é½
      
      .message-time {
        font-size: 0.75rem;
        color: #888888;
        margin-top: 6px;
        text-align: right;
      }
      
      .message-text {
        font-size: 0.95rem;
        line-height: 1.5;
        color: #333333;
        word-break: break-word;
        white-space: pre-wrap;
        
        code {
          background-color: rgba(0, 0, 0, 0.05);
          padding: 2px 4px;
          border-radius: 4px;
          font-family: monospace;
        }
        
        pre {
          background-color: #f1f1f1;
          padding: 12px;
          border-radius: 8px;
          overflow-x: auto;
          margin: 10px 0;
          
          code {
            background-color: transparent;
            padding: 0;
          }
        }
      }
      
      /* æ€è€ƒå†…å®¹åŒºåŸŸæ ·å¼ */
      .message-thinking {
        margin-bottom: 12px;
        padding: 10px;
        background-color: #f9f5ff;
        border-radius: 8px;
        border-left: 3px solid #8b5cf6;
        font-size: 0.9rem;
        width: 100%; // ç¡®ä¿æ€è€ƒåŒºåŸŸå®½åº¦ä¸º100%
        box-sizing: border-box; // åŒ…å«paddingåœ¨å†…
        
        .thinking-header {
          display: flex;
          align-items: center;
          gap: 6px;
          margin-bottom: 8px;
          font-weight: 500;
          color: #8b5cf6;
          font-size: 0.85rem;
          
          svg {
            color: #8b5cf6;
          }
        }
        
        .thinking-content {
          color: #6b7280;
          line-height: 1.4;
        }
      }
    }
    
    &.user-message {
      flex-direction: row-reverse;
      
      .message-avatar {
        margin-right: 0;
        margin-left: 12px;
        background: #deeaff;
      }
      
      .message-content {
        background: linear-gradient(135deg, #FF9A8B, #FF6B95); // ä½¿ç”¨ä¸ä¸»é¢˜ç›¸åŒ¹é…çš„æ¸å˜ç²‰è‰²ç³»
        color: white;
        
        .message-time {
          color: rgba(255, 255, 255, 0.8);
        }
      }
    }
    
    &.bot-message {
      .message-avatar {
        background: #f0f7ff;
      }
    }
  }
  
  .typing-indicator {
    display: flex;
    padding: 12px 16px;
    background: white;
    border-radius: 12px;
    width: fit-content;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: #888;
      border-radius: 50%;
      margin: 0 2px;
      animation: typing-dot 1.4s infinite ease-in-out both;
      
      &:nth-child(1) {
        animation-delay: -0.32s;
      }
      
      &:nth-child(2) {
        animation-delay: -0.16s;
      }
    }
  }
}

.chat-input-wrapper {
  position: absolute; // ç›¸å¯¹äº.chat-contentç»å¯¹å®šä½
  left: 50%; 
  transform: translateX(-50%); // ä½¿ç”¨transformå±…ä¸­
  bottom: 20px;
  width: 100%;
  max-width: 700px; 
  margin: 0 auto; // ç¡®ä¿å±…ä¸­
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  background: transparent;
  z-index: 50; 
  
  // æ ¹æ®ä¾§è¾¹æ çŠ¶æ€è°ƒæ•´ä½ç½®
  &.sidebar-expanded {
    // ç§»é™¤ transform ä½ç§»ï¼Œä¾§è¾¹æ å±•å¼€æ—¶ä¹Ÿä¿æŒä¸­å¤®ä½ç½®
    margin-left: 0;
  }
  
  &.with-messages {
    position: absolute; // æ”¹ä¸ºç»å¯¹å®šä½
    bottom: 20px;
  }
  
  .chat-input-area {
    display: flex;
    position: relative;
    flex-direction: column;
    background: white;
    border-radius: 12px;
    padding: 14px 16px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    margin: 0 20px; // æ·»åŠ æ°´å¹³è¾¹è·
    
    .mode-selector-inner {
      display: flex;
      margin-bottom: 10px;
      gap: 8px;
      
      .mode-btn {
        display: flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        background-color: rgba(0, 0, 0, 0.05);
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        color: #333;
        
        svg {
          margin-right: 6px;
        }
        
        &.deep-think-btn {
          background-color: rgba(100, 80, 220, 0.1);
          color: #5140a7;
          
          svg {
            stroke: #5140a7;
          }
          
          &:hover {
            background-color: rgba(100, 80, 220, 0.2);
          }
        }
        
        &.web-search-btn {
          background-color: rgba(14, 165, 233, 0.1);
          color: #0284c7;
          
          svg {
            stroke: #0284c7;
          }
          
          &:hover {
            background-color: rgba(14, 165, 233, 0.2);
          }
        }
        &.prompt-library-btn {
          background-color: rgba(249, 115, 22, 0.1);
          color: #f97316;
          
          svg {
            stroke: #f97316;
          }
          
          &:hover {
            background-color: rgba(249, 115, 22, 0.2);
          }
        }
        &.cloud-model-btn {
          background-color: rgba(25, 118, 210, 0.1);
          color: #1976d2;
          
          svg {
            stroke: #1976d2;
          }
          
          &:hover {
            background-color: rgba(25, 118, 210, 0.2);
          }
          
          &.active {
            background-color: #1976d2;
            color: white;
            
            svg {
              stroke: white;
            }
          }
        }
      }
    }
    
    .input-row {
      display: flex;
      align-items: flex-end;
      
      .chat-input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 1.05rem;
        resize: none;
        outline: none;
        line-height: 1.5;
        max-height: 220px; // å¢åŠ æœ€å¤§é«˜åº¦
        min-height: 60px; // æ˜¾è‘—å¢åŠ æœ€å°é«˜åº¦
        padding: 15px 0 15px 10px; // å¢åŠ å†…è¾¹è·å¹¶æ·»åŠ å·¦ä¾§å†…è¾¹è·
        overflow-y: auto;
        text-align: left; // ç¡®ä¿æ–‡æœ¬å·¦å¯¹é½
      }
      
      .input-tools {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        align-self: flex-end;
        margin-left: 8px;
        
        .tool-btn {
          background: transparent;
          border: none;
          color: #666;
          padding: 6px 8px;
          margin-right: 6px;
          border-radius: 4px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          
          &:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
          }
        }
        
        .send-btn {
          color: #4665ee;
          background: transparent;
          border: none;
          cursor: pointer;
          padding: 6px 8px;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          
          &:hover {
            background: rgba(70, 101, 238, 0.1);
          }
          
          &:disabled {
            color: #ccc;
            cursor: not-allowed;
          }
          
          svg {
            stroke: currentColor;
          }
        }
      }
    }
  }
  
  // æ·»åŠ å…è´£å£°æ˜æ–‡æœ¬
  &::after {
    content: "å†…å®¹ç”± AI ç”Ÿæˆï¼Œè¯·ä»”ç»†ç”„åˆ«";
    display: block;
    text-align: center;
    font-size: 12px;
    color: #999;
    margin-top: 10px;
    width: 100%;
    padding: 0 20px;
  }
}

/* Toast æ ·å¼ */
.toast-container {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, rgba(255, 154, 139, 0.95), rgba(255, 107, 149, 0.95)); // ä½¿ç”¨ä¸ç”¨æˆ·æ¶ˆæ¯ç›¸åŒçš„æ¸å˜è‰²ï¼Œæ·»åŠ é€æ˜åº¦
  color: white;
  padding: 12px 24px;
  border-radius: 12px; // å¢åŠ åœ†è§’
  z-index: 9999;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
  box-shadow: 0 8px 20px rgba(255, 107, 149, 0.3); // æŸ”å’Œçš„é˜´å½±ï¼Œä¸ç²‰è‰²ç³»åŒ¹é…
  max-width: 90%;
  
  &.toast-show {
    opacity: 1;
  }
  
  .toast-message {
    font-size: 1rem;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 500; // ç¨å¾®åŠ ç²—å­—ä½“
  }
}

@keyframes typing-dot {
  0%, 80%, 100% { transform: scale(0.7); }
  40% { transform: scale(1); }
}

/* å¼¹å‡ºå±‚æ ·å¼ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(2px);
}

.modal-container {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  display: flex;
  flex-direction: column;
  animation: modal-appear 0.3s ease-out;
  
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    
    h3 {
      margin: 0;
      font-size: 1rem;
      color: #333;
      font-weight: 600;
    }
    
    .modal-close {
      background: transparent;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      color: #888;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      
      &:hover {
        color: #333;
        background: #f0f0f3;
      }
    }
  }
  
  .modal-body {
    padding: 16px;
    overflow-y: auto;
  }
  
  .modal-footer {
    padding: 10px 16px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    
    button {
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .cancel-btn {
      background: transparent;
      border: 1px solid #ddd;
      color: #666;
      
      &:hover {
        background: #f5f5f5;
      }
    }
    
    .confirm-btn {
      background: linear-gradient(135deg, #FF9A8B, #FF6B95); // ä½¿ç”¨ä¸æç¤ºæ¡†å’Œç”¨æˆ·æ¶ˆæ¯ç›¸åŒçš„æ¸å˜è‰²
      border: none;
      color: white;
      box-shadow: 0 2px 8px rgba(255, 107, 149, 0.3); // æ·»åŠ è½»å¾®é˜´å½±
      
      &:hover {
        background: linear-gradient(135deg, #FF8A7B, #FF5B85); // æ‚¬åœæ—¶ç¨å¾®æ·±ä¸€ç‚¹
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(255, 107, 149, 0.4);
      }
    }
  }
}

/* æ ‡ç­¾é€‰æ‹©å™¨æ ·å¼ */
.tag-selector {
  .tags-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 16px;
    
    .tag-item {
      display: flex;
      align-items: center;
      border: 1px solid #eee;
      border-left-width: 3px;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s;
      
      &:hover {
        background: #f9f9f9;
      }
      
      &.selected {
        background: #f5f8ff;
      }
      
      .tag-color {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }
      
      .tag-name {
        flex: 1;
        font-size: 0.9rem;
      }
      
      .tag-check {
        color: #4665ee;
        font-weight: bold;
      }
    }
  }
  
  /* æ ‡é¢˜è¾“å…¥æ¡†æ ·å¼ */
  .title-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background-color: #f9f9fb;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
    
    &:focus {
      outline: none;
      border-color: #4665ee;
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(70, 101, 238, 0.1);
    }
    
    &::placeholder {
      color: #aaa;
    }
  }
  
  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
}

/* å¯¼å‡ºèœå•æ ·å¼ */
.export-menu {
  .export-options {
    display: flex;
    flex-direction: column;
    
    .export-option {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 2px;
      
      &:hover {
        background: #f5f8ff;
      }
      
      .export-icon {
        margin-right: 12px;
        color: #4665ee;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .export-format {
        font-size: 0.95rem;
        color: #333;
      }
    }
  }
}

@keyframes modal-appear {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
  .chat-container {
    flex-direction: column;
  }
  
  .sidebar-toggle {
    top: 10px;
    left: 10px;
  }
  
  .sidebar {
    width: 100%;
    height: auto;
    max-height: 300px;
    border-right: none;
    border-bottom: 1px solid #e5e5e5;
    
    &.sidebar-collapsed {
      max-height: 0;
      padding: 0;
      margin: 0;
      border-bottom: none;
    }
  }
  
  .chat-input-wrapper {
    bottom: 20px;
    padding: 0 16px;
    
    &.with-messages {
      padding: 10px 16px;
    }
  }
}

@media (max-width: 992px) {
  .sidebar:not(.sidebar-collapsed) {
    width: 240px;
  }
}

@keyframes modal-appear {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* æ–‡ä»¶ç®¡ç†å™¨æ ·å¼ */
.file-manager {
  .file-manager-toolbar {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 16px;
    
    .file-search {
      flex: 1;
      min-width: 200px;
      position: relative;
      
      .file-search-input {
        width: 100%;
        padding: 8px 12px 8px 32px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        
        &:focus {
          outline: none;
          border-color: #4665ee;
        }
      }
      
      .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
      }
    }
    
    .file-filters {
      display: flex;
      gap: 4px;
      
      .filter-btn {
        padding: 6px 12px;
        background: #f0f0f3;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        color: #666;
        
        &:hover {
          background: #e5e5e5;
        }
        
        &.active {
          background: #4665ee;
          color: white;
        }
      }
    }
    
    .upload-file-btn {
      padding: 6px 12px;
      background: #4665ee;
      color: white;
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      
      &:hover {
        background: #3a56d4;
        transform: translateY(-1px);
      }
    }
  }
  
  .files-container {
    border: 1px solid #eee;
    border-radius: 6px;
    max-height: 400px;
    overflow-y: auto;
    
    .file-item {
      display: flex;
      align-items: flex-start;
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
      
      &:last-child {
        border-bottom: none;
      }
      
      &:hover {
        background: #f5f8ff;
      }
      
      &.selected {
        background: #e9efff;
      }
      
      .file-icon {
        margin-right: 12px;
        flex-shrink: 0;
        width: 24px;
        height: 24px;
        margin-top: 2px;
      }
      
      .file-details {
        flex: 1;
        min-width: 0;
        
        .file-name {
          font-weight: 500;
          margin-bottom: 4px;
          font-size: 0.95rem;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          padding-right: 60px;
          
          &.restricted {
            color: #888;
          }
          
          .restricted-badge {
            display: inline-block;
            font-size: 0.65rem;
            background: #EB5757;
            color: white;
            padding: 1px 5px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            position: relative;
            top: -1px;
          }
        }
        
        .file-meta {
          display: flex;
          gap: 12px;
          margin-bottom: 4px;
          font-size: 0.8rem;
          color: #888;
          
          .file-size, .file-date {
            white-space: nowrap;
          }
        }
        
        .file-description {
          font-size: 0.85rem;
          color: #666;
          overflow: hidden;
          text-overflow: ellipsis;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
        }
      }
      
      .file-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 4px;
        
        .file-action-btn {
          background: transparent;
          border: none;
          width: 26px;
          height: 26px;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          color: #888;
          transition: all 0.2s;
          
          &:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
          }
          
          &.toggle-access:hover {
            color: #4665ee;
          }
          
          &.delete-file:hover {
            color: #EB5757;
          }
        }
      }
    }
    
    .no-files {
      padding: 30px;
      text-align: center;
      color: #888;
      font-size: 0.9rem;
    }
  }
}

/* æ–‡ä»¶ä¸Šä¼ æ¨¡æ€æ¡†æ ·å¼ */
.file-upload-modal {
  max-width: 500px;
  
  .file-upload-area {
    .upload-dropzone {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.2s;
      
      &:hover {
        border-color: #4665ee;
        background: #f9f9ff;
      }
      
      svg {
        color: #888;
        margin-bottom: 10px;
      }
      
      p {
        font-size: 1rem;
        color: #333;
        margin: 0 0 8px;
      }
      
      .upload-formats {
        font-size: 0.8rem;
        color: #888;
      }
    }
    
    .upload-form {
      .form-group {
        margin-bottom: 14px;
        
        label {
          display: block;
          font-size: 0.9rem;
          margin-bottom: 6px;
          color: #555;
        }
        
        input[type="text"], textarea {
          width: 100%;
          padding: 8px 10px;
          border: 1px solid #ddd;
          border-radius: 6px;
          font-size: 0.9rem;
          
          &:focus {
            outline: none;
            border-color: #4665ee;
          }
        }
        
        textarea {
          resize: vertical;
        }
        
        .checkbox-label {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
          
          input[type="checkbox"] {
            margin-right: 8px;
          }
          
          .hint {
            font-size: 0.8rem;
            color: #888;
            margin-left: 22px;
          }
        }
      }
    }
  }
}

/* ä¸»é¢˜è®¾ç½®å¼¹å‡ºçª—å£æ ·å¼ */
.theme-settings {
  .settings-layout {
    display: flex;
    gap: 20px;
    
    .settings-column {
      flex: 1;
      min-width: 0;
      
      &:first-child {
        flex: 0 0 55%;
      }
      
      &:last-child {
        flex: 0 0 45%;
      }
    }
  }

  .theme-section {
    margin-bottom: 12px;
    
    /* éšè—å­—ä½“è®¾ç½®æ ‡é¢˜ */
    &:nth-child(3) .section-title {
      display: none;
    }
    
    .section-row {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .section-title {
      font-size: 0.95rem;
      font-weight: bold;
      width: 70px;
      margin-right: 8px;
      margin-bottom: 0;
    }
    
    .theme-options {
      display: flex;
      gap: 8px;
      flex: 1;
      
      .theme-option {
        flex: 1;
        padding: 5px;
        border: 2px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        
        &.selected {
          border-color: #4665ee;
        }
        
        .theme-preview {
          width: 100%;
          height: 30px;
          border-radius: 4px;
          margin-bottom: 4px;
        }
        
        .theme-name {
          font-size: 0.85rem;
          color: #333;
          text-align: center;
        }
      }
    }
    
    .mode-toggle {
      display: flex;
      gap: 8px;
      flex: 1;
      
      .mode-btn {
        flex: 1;
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        
        &.active {
          border-color: #4665ee;
        }
        
        svg {
          margin-right: 5px;
        }
      }
    }
    
    .setting-label {
      font-size: 0.85rem;
      font-weight: bold;
      width: 70px;
      margin-right: 8px;
    }
    
    .setting-options {
      display: flex;
      gap: 6px;
      flex: 1;
      
      .option-btn {
        flex: 1;
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
        
        &.active {
          border-color: #4665ee;
        }
      }
    }
  }
}

/* æç¤ºè¯åº“æ ·å¼ */
.prompt-library {
  .prompt-library-toolbar {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 16px;
    
    .prompt-search {
      flex: 1;
      min-width: 200px;
      position: relative;
      
      .prompt-search-input {
        width: 100%;
        padding: 8px 12px 8px 32px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        
        &:focus {
          outline: none;
          border-color: #4665ee;
        }
      }
      
      .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
      }
    }
    
    .prompt-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      
      .filter-btn {
        padding: 6px 12px;
        background: #f0f0f3;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        color: #666;
        
        &:hover {
          background: #e5e5e5;
        }
        
        &.active {
          background: #4665ee;
          color: white;
        }
      }
    }
    
    .add-prompt-btn {
      padding: 6px 12px;
      background: #4665ee;
      color: white;
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      
      &:hover {
        background: #3a56d4;
        transform: translateY(-1px);
      }
    }
  }
  
  .prompts-container {
    border: 1px solid #eee;
    border-radius: 6px;
    padding: 16px;
    
    .prompts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 16px;
    }
    
    .prompt-card {
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      border-radius: 8px;
      transition: all 0.2s;
      background-color: #fff;
      height: 100%;
      overflow: hidden;
      
      &:hover {
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }
      
      .prompt-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
        
        .prompt-name {
          font-weight: bold;
          font-size: 1rem;
          color: white;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .prompt-category-badge {
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 0.7rem;
          color: white;
          background: rgba(255, 255, 255, 0.25);
          backdrop-filter: blur(4px);
        }
      }
      
      .prompt-card-body {
        padding: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
        
        .prompt-description {
          font-size: 0.9rem;
          color: #555;
          margin-bottom: 12px;
          flex: 1;
        }
        
        .prompt-tags {
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
          margin-top: auto;
          
          .prompt-tag {
            font-size: 0.8rem;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            background: #f5f5f5;
          }
          
          .prompt-tag-more {
            font-size: 0.8rem;
            color: #888;
            padding: 4px 8px;
            background: #f0f0f0;
            border-radius: 4px;
          }
        }
      }
      
      .prompt-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: #f9f9f9;
        border-top: 1px solid #eee;
        
        .prompt-usage {
          display: flex;
          align-items: center;
          gap: 4px;
          font-size: 0.8rem;
          color: #888;
          
          svg {
            width: 14px;
            height: 14px;
            margin-right: 4px;
          }
        }
        
        .prompt-actions {
          display: flex;
          gap: 8px;
          
          .prompt-action-btn {
            background: transparent;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #888;
            transition: all 0.2s;
            
            &:hover {
              background: rgba(0, 0, 0, 0.05);
              color: #333;
              
              &.copy-btn {
                color: #4665ee;
              }
              
              &.edit-btn {
                color: #f97316;
              }
              
              &.delete-btn {
                color: #dc2626;
              }
            }
          }
        }
      }
    }
    
    .no-prompts {
      padding: 30px;
      text-align: center;
      color: #888;
      font-size: 0.9rem;
    }
  }
}

/* æç¤ºè¯é¢„è§ˆæç¤º */
.prompt-preview-tooltip {
  position: fixed;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
  padding: 0;
  z-index: 1000;
  pointer-events: none;
  overflow: hidden;
  border: 1px solid #eee;
  max-width: 600px;
  width: 600px;
  height: 500px; /* å›ºå®šæ€»é«˜åº¦ */
  display: flex;
  flex-direction: column;
  
  .preview-header {
    background: #f5f5f5;
    padding: 10px 14px;
    font-size: 0.9rem;
    color: #555;
    font-weight: bold;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    flex-shrink: 0; /* é˜²æ­¢æ ‡é¢˜è¢«å‹ç¼© */
    
    &::before {
      content: "";
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #f97316;
      margin-right: 8px;
    }
  }
  
  .preview-content {
    padding: 14px 16px;
    font-size: 0.9rem;
    color: #444;
    flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
    overflow-y: auto;
    white-space: pre-wrap;
    line-height: 1.6;
  }
  
  .dark-mode & {
    background: #2a2a2a;
    border-color: #444;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    
    .preview-header {
      background: #333;
      color: #eee;
      border-bottom-color: #444;
    }
    
    .preview-content {
      color: #ddd;
    }
  }
}

/* æ–°å¢/ç¼–è¾‘æç¤ºè¯å¼¹å‡ºå±‚ */
.prompt-modal {
  max-width: 500px;
  
  .prompt-form {
    .form-group {
      margin-bottom: 14px;
      
      label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 6px;
        color: #555;
      }
      
      input[type="text"], textarea {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        
        &:focus {
          outline: none;
          border-color: #4665ee;
        }
      }
      
      textarea {
        resize: vertical;
      }
    }
  }
}

.prompts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
}

.prompt-tag-more {
  color: #888;
  font-size: 0.8rem;
  margin-left: 4px;
}

.chat-input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 1.05rem;
  resize: none;
  outline: none;
  line-height: 1.5;
  max-height: 150px;
  min-height: 36px;
  padding: 8px 0;
}

.user-message .message-content {
  background: linear-gradient(135deg, #FF9A8B, #FF6B95); // ä¿æŒæ‰€æœ‰æ¨¡å¼ä¸‹ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡é¢œè‰²ä¸€è‡´
}

/* é¢„è§ˆå®¹å™¨æ ·å¼ */
.preview-container {
  border: 2px dashed #ddd;
  border-radius: 6px;
  padding: 10px;
  background: var(--background-color, #f9f9f9);
  color: var(--text-color, #333);
  transition: all 0.3s;
  overflow: hidden;
  
  &.dark-mode {
    background: #1a1a1a;
    color: #f0f0f0;
    border-color: #333;
    
    .preview-message {
      &.user {
        background: linear-gradient(135deg, #FF9A8B, #FF6B95); // ä½¿ç”¨ç›¸åŒçš„æ¸å˜ç²‰è‰²ç³»
        color: #f0f0f0;
      }
      
      &.bot {
        background: #2a2a2a;
        color: #f0f0f0;
      }
    }
  }
  
  &.font-size-small {
    font-size: 0.85rem;
    
    .preview-message {
      padding: 8px;
    }
  }
  
  &.font-size-medium {
    font-size: 0.9rem;
    
    .preview-message {
      padding: 10px;
    }
  }
  
  &.font-size-large {
    font-size: 1rem;
    
    .preview-message {
      padding: 12px;
    }
  }
  
  &.font-spacing-compact {
    .preview-message {
      margin-bottom: 6px;
      line-height: 1.4;
    }
  }
  
  &.font-spacing-normal {
    .preview-message {
      margin-bottom: 8px;
      line-height: 1.6;
    }
  }
  
  &.font-spacing-relaxed {
    .preview-message {
      margin-bottom: 10px;
      line-height: 1.8;
    }
  }
  
  &.font-family-default {
    font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
  }
  
  &.font-family-serif {
    font-family: 'Noto Serif SC', serif;
  }
  
  &.font-family-mono {
    font-family: 'Fira Code', 'Source Code Pro', monospace;
  }
  
  .preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 10px;
    
    .preview-logo {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--primary-color, #4665ee);
    }
  }
  
  .preview-message {
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    
    &.user {
      background: linear-gradient(135deg, #FF9A8B, #FF6B95); // ä½¿ç”¨ç›¸åŒçš„æ¸å˜ç²‰è‰²ç³»
      color: white;
      align-self: flex-end;
      margin-left: auto;
    }
    
    &.bot {
      background: white;
      color: #333;
      border: 1px solid #eee;
    }
  }
}

/* ä¾§è¾¹æ æ ·å¼ - ç¿¡ç¿ ç»¿ä¸»é¢˜ç‰¹åˆ«å¤„ç† */
.theme-emerald .sidebar {
  background: var(--secondary-color, #ecfdf5); // ä½¿ç”¨æ¬¡è¦é¢œè‰²
  border-right: 1px solid rgba(5, 150, 105, 0.2); // ç¿¡ç¿ ç»¿ç‰¹å®šè¾¹æ¡†
  box-shadow: 0 0 15px rgba(16, 185, 129, 0.08); // ç‰¹å®šé˜´å½±
  
  .sidebar-header {
    border-bottom: 1px solid rgba(5, 150, 105, 0.2);
    background: rgba(16, 185, 129, 0.05);
  }
  
  .history-item {
    border: 1px solid rgba(16, 185, 129, 0.1);
    
    &:hover {
      background: rgba(16, 185, 129, 0.08);
      border-color: rgba(16, 185, 129, 0.2);
    }
  }
  
  .sidebar-footer {
    border-top: 1px solid rgba(5, 150, 105, 0.2);
    background: rgba(16, 185, 129, 0.05);
    
    .settings-btn,
    .profile-btn {
      border: 1px solid rgba(16, 185, 129, 0.2);
      
      &:hover {
        background: rgba(16, 185, 129, 0.1);
      }
    }
  }
}

/* ä¾§è¾¹æ æ ·å¼ - æ™šéœæ©™ä¸»é¢˜ç‰¹åˆ«å¤„ç† */
.theme-sunset .sidebar {
  background: var(--secondary-color, #fff1e6); // ä½¿ç”¨æ¬¡è¦é¢œè‰²
  border-right: 1px solid rgba(234, 88, 12, 0.15); // æ©™è‰²ç³»è¾¹æ¡†
  box-shadow: 0 0 15px rgba(249, 115, 22, 0.07); // ç‰¹å®šé˜´å½±
  
  .sidebar-header {
    border-bottom: 1px solid rgba(234, 88, 12, 0.15);
    background: rgba(249, 115, 22, 0.05);
  }
  
  .history-item {
    border: 1px solid rgba(234, 88, 12, 0.1);
    
    &:hover {
      background: rgba(249, 115, 22, 0.07);
      border-color: rgba(234, 88, 12, 0.2);
    }
  }
  
  .sidebar-footer {
    border-top: 1px solid rgba(234, 88, 12, 0.15);
    background: rgba(249, 115, 22, 0.05);
    
    .settings-btn,
    .profile-btn {
      border: 1px solid rgba(234, 88, 12, 0.15);
      
      &:hover {
        background: rgba(249, 115, 22, 0.09);
      }
    }
  }
}

/* ä¾§è¾¹æ æ ·å¼ - çŸ³å¢¨é»‘ä¸»é¢˜ç‰¹åˆ«å¤„ç† */
.theme-graphite .sidebar {
  background: var(--secondary-color, #f1f5f9); // ä½¿ç”¨æ¬¡è¦é¢œè‰²
  border-right: 1px solid rgba(51, 65, 85, 0.15); // çŸ³å¢¨ç³»è¾¹æ¡†
  box-shadow: 0 0 15px rgba(51, 65, 85, 0.08); // ç‰¹å®šé˜´å½±
  
  .sidebar-header {
    border-bottom: 1px solid rgba(51, 65, 85, 0.15);
    background: rgba(51, 65, 85, 0.05);
  }
  
  .history-item {
    border: 1px solid rgba(51, 65, 85, 0.1);
    
    &:hover {
      background: rgba(51, 65, 85, 0.07);
      border-color: rgba(51, 65, 85, 0.2);
    }
  }
  
  .sidebar-footer {
    border-top: 1px solid rgba(51, 65, 85, 0.15);
    background: rgba(51, 65, 85, 0.05);
    
    .settings-btn,
    .profile-btn {
      border: 1px solid rgba(51, 65, 85, 0.15);
      
      &:hover {
        background: rgba(51, 65, 85, 0.09);
      }
    }
  }
}

/* Markdown æ ·å¼ */
.markdown-body {
  h1, h2, h3, h4, h5, h6 {
    margin-top: 16px;
    margin-bottom: 8px;
    font-weight: 600;
    line-height: 1.25;
  }
  
  h1 {
    font-size: 1.5em;
  }
  
  h2 {
    font-size: 1.25em;
  }
  
  h3 {
    font-size: 1.1em;
  }
  
  ul, ol {
    padding-left: 20px;
    margin: 8px 0;
  }
  
  li {
    margin: 4px 0;
  }
  
  p {
    margin: 8px 0;
  }
  
  a {
    color: #4665ee;
    text-decoration: none;
    
    &:hover {
      text-decoration: underline;
    }
  }
  
  blockquote {
    border-left: 3px solid #ddd;
    padding-left: 12px;
    color: #666;
    margin: 12px 0;
  }
  
  img {
    max-width: 100%;
    margin: 8px 0;
    border-radius: 6px;
  }
  
  table {
    border-collapse: collapse;
    width: 100%;
    margin: 12px 0;
    
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    
    th {
      background-color: #f5f5f5;
    }
    
    tr:nth-child(even) {
      background-color: #fafafa;
    }
  }
  
  code {
    background-color: rgba(0, 0, 0, 0.05);
    padding: 2px 4px;
    border-radius: 4px;
    font-family: monospace;
  }
  
  pre {
    background-color: #f1f1f1;
    padding: 12px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 10px 0;
    
    code {
      background-color: transparent;
      padding: 0;
    }
  }
}
</style> 
