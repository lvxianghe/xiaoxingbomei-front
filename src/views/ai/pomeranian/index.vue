<template>
  <div 
    class="chat-container"
    :class="[
      `theme-${currentTheme}`,
      isDarkMode ? 'dark-mode' : '',
      `font-size-${currentFontSettings.size}`,
      `font-spacing-${currentFontSettings.spacing}`,
      `font-family-${currentFontSettings.family}`
    ]"
  >
    <!-- ‰æßËæπÊ†èÂàáÊç¢ÊåâÈíÆ - ÂΩì‰æßËæπÊ†èÊäòÂè†Êó∂ÊòæÁ§∫ -->
    <div class="sidebar-toggle" v-if="sidebarCollapsed" @click="toggleSidebar" title="Â±ïÂºÄ‰æßËæπÊ†è">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 18l6-6-6-6"></path>
      </svg>
    </div>
    
    <!-- ‰æßËæπÊ†è -->
    <div class="sidebar" :class="{'sidebar-collapsed': sidebarCollapsed}">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">
            <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.000000 512.000000" preserveAspectRatio="xMidYMid meet">
              <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)" fill="#333333" stroke="none">
                <path d="M2330 5110 c-192 -19 -372 -56 -550 -112 -101 -32 -107 -33 -170 -21
                -147 28 -348 7 -490 -51 -264 -108 -459 -334 -531 -614 -10 -41 -19 -89 -19
                -106 0 -23 -18 -56 -66 -121 -643 -879 -672 -2055 -72 -2947 135 -202 343
                -428 533 -580 600 -480 1387 -662 2150 -498 228 50 562 179 584 226 16 35 14
                48 -10 78 -28 36 -58 34 -169 -15 -361 -156 -780 -224 -1165 -189 -470 44
                -875 200 -1254 483 -123 92 -366 335 -458 458 -196 262 -336 547 -412 841
                -165 638 -71 1296 266 1859 l77 130 26 -83 c34 -107 59 -154 107 -200 56 -55
                115 -78 199 -78 87 0 155 31 213 96 75 85 90 188 45 315 -21 60 -25 86 -21
                140 7 104 42 164 150 255 43 36 48 68 16 108 -27 34 -63 34 -120 -2 -165 -105
                -243 -352 -170 -542 26 -69 27 -116 1 -157 -27 -46 -72 -66 -132 -61 -69 7
                -99 39 -132 140 -117 352 30 722 353 892 119 62 199 81 346 81 117 0 139 -3
                219 -29 100 -33 140 -61 156 -112 17 -51 5 -99 -35 -139 -47 -46 -90 -53 -161
                -26 -70 26 -108 27 -134 1 -26 -26 -26 -81 -2 -103 10 -10 52 -29 93 -43 57
                -20 86 -25 126 -21 106 11 192 69 241 162 21 41 26 63 25 125 0 84 -16 130
                -64 185 -18 20 -30 37 -28 39 7 7 174 45 264 61 228 40 521 44 746 10 110 -17
                318 -61 327 -70 3 -3 -6 -18 -20 -33 -101 -108 -97 -291 10 -395 84 -82 207
                -104 329 -58 52 20 76 23 140 19 90 -5 143 -28 202 -87 88 -88 112 -211 67
                -340 -44 -125 -30 -227 40 -310 56 -65 113 -93 200 -99 166 -11 273 85 330
                294 l17 65 47 -73 c356 -561 467 -1246 305 -1888 -142 -564 -495 -1071 -976
                -1400 -48 -33 -89 -67 -93 -76 -19 -50 16 -104 68 -104 60 0 310 195 501 391
                203 209 338 400 465 661 415 849 326 1855 -234 2628 -55 77 -76 113 -76 136 0
                43 -33 169 -65 245 -62 147 -199 311 -337 399 -177 115 -433 166 -638 127 -63
                -12 -68 -12 -170 21 -124 40 -275 75 -420 97 -124 18 -469 27 -590 15z"/>
                <path d="M1735 2940 c-77 -40 -80 -48 -83 -282 -3 -230 0 -245 61 -292 49 -37
                102 -42 156 -14 83 43 86 51 89 286 3 203 3 208 -20 241 -51 76 -130 99 -203
                61z"/>
                <path d="M3245 2936 c-68 -42 -78 -70 -83 -233 -3 -78 -1 -172 3 -210 6 -62
                11 -71 49 -109 53 -53 105 -64 169 -36 24 11 55 35 68 53 24 33 24 38 24 246
                0 198 -1 213 -21 239 -54 73 -139 94 -209 50z"/>
                <path d="M2479 2295 c-25 -8 -66 -33 -91 -55 -144 -126 -116 -354 54 -441 21
                -11 38 -24 38 -29 0 -22 -43 -100 -76 -138 -19 -23 -60 -53 -92 -69 -48 -24
                -70 -28 -137 -28 -67 0 -89 4 -137 28 -96 47 -161 142 -174 254 -12 95 -75
                133 -129 78 -30 -29 -32 -73 -10 -160 56 -212 241 -355 461 -355 48 0 61 -4
                97 -34 165 -133 377 -137 546 -10 54 40 63 44 118 44 110 0 227 44 312 117 84
                71 149 207 152 318 2 52 -1 61 -25 82 -59 50 -110 13 -126 -91 -18 -114 -72
                -190 -173 -243 -71 -37 -187 -39 -262 -5 -63 29 -120 83 -151 144 -31 61 -30
                74 6 93 195 101 202 375 12 478 -62 34 -148 43 -213 22z m189 -817 c23 -18 42
                -35 42 -39 0 -15 -98 -44 -150 -44 -52 0 -150 29 -150 44 0 4 13 14 29 24 16
                9 51 41 78 70 l48 53 30 -37 c17 -21 49 -53 73 -71z"/>
              </g>
            </svg>
          </div>
          <span>Â∞èÂûãÂçöÁæé</span>
        </div>
        <div class="header-buttons">
          <button class="exit-btn" @click="goToHome" title="ËøîÂõûÈ¶ñÈ°µ">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </button>
          <button class="collapse-btn" @click="toggleSidebar" :title="sidebarCollapsed ? 'Â±ïÂºÄ‰æßËæπÊ†è' : 'Êî∂Ëµ∑‰æßËæπÊ†è'">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 18l-6-6 6-6" v-if="!sidebarCollapsed"></path>
              <path d="M9 18l6-6-6-6" v-else></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="sidebar-actions">
        <button class="new-chat-btn" @click="startNewChat">
          <span class="btn-icon">+</span> Êñ∞Âª∫ÂØπËØù
        </button>
      </div>
      <div class="history-list">
        <div class="history-item" v-for="(item, index) in chatHistory" :key="index" @click="loadConversation(index)">
          <div class="history-content">
            <div class="history-title">{{ item.title }}</div>
            <div class="history-meta">
              <span class="history-time">{{ item.time }}</span>
              <div class="history-tags" v-if="item.tags && item.tags.length > 0">
                <span 
                  v-for="(tag, tagIndex) in limitTags(item.tags)" 
                  :key="tagIndex" 
                  class="history-tag"
                  :style="{ backgroundColor: getTagColor(tag) }"
                >
                  {{ tag }}
                </span>
              </div>
            </div>
          </div>
          <div class="history-actions">
            <button class="history-action-btn tag-btn" @click.stop="openTagSelector(index)" title="ÁºñËæë‰ºöËØù">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
            <button class="history-action-btn export-btn" @click.stop="openExportMenu(index)" title="ÂØºÂá∫ÂØπËØù">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <button class="history-action-btn delete-history-btn" @click.stop="deleteHistory(index)" title="Âà†Èô§Ê≠§ÂØπËØù">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"></path>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="sidebar-footer">
        <button class="settings-btn" @click="openThemeSettings">
          <span class="btn-icon">‚öôÔ∏è</span> ‰∏™ÊÄßÂåñËÆæÁΩÆ
        </button>
        <button class="profile-btn" @click="showToast('‰∏™‰∫∫‰ø°ÊÅØÂäüËÉΩÂºÄÂèë‰∏≠')">
          <span class="btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          ‰∏™‰∫∫‰ø°ÊÅØ
        </button>
      </div>
    </div>
    
    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <div class="main-content" :class="{'full-width': !showSidebar}">
      <!-- ËÅäÂ§©ÂÜÖÂÆπÂÆπÂô® -->
      <div 
        class="chat-content" 
        ref="chatContentRef"
        @scroll="handleScroll"
      >
        <!-- Ê¨¢Ëøé‰ø°ÊÅØ -->
        <div v-if="messages.length === 0" class="welcome-container">
          <div class="bot-avatar">
            <img src="/icons/pomeranian.svg" alt="Â∞èÂûãÂçöÁæé" />
          </div>
          <div class="welcome-title">ÊàëÊòØ Â∞èÂûãÂçöÁæé, ÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†!</div>
          <div class="welcome-subtitle">ÊàëÂèØ‰ª•Â∏Æ‰Ω†ÂÜô‰ª£Á†Å„ÄÅËØªÊñá‰ª∂„ÄÅÂÜô‰ΩúÂêÑÁßçÂàõÊÑèÂÜÖÂÆπÔºåËØ∑Êää‰Ω†ÁöÑ‰ªªÂä°‰∫§ÁªôÊàëÂêß~</div>
        </div>
        
        <!-- Ê∂àÊÅØÂàóË°® -->
        <div class="message-container" v-else>
          <div v-for="(message, index) in messages" :key="index" 
               :class="['message-item', message.role === 'user' ? 'user-message' : 'bot-message']">
            <div class="message-avatar">
              {{ message.role === 'user' ? 'üë§' : 'ü§ñ' }}
            </div>
            <div class="message-content">
              <!-- ÊÄùËÄÉÂÜÖÂÆπÂå∫ -->
              <div v-if="message.thinking" class="message-thinking">
                <div class="thinking-header">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12" y2="16"></line>
                  </svg>
                  <span>ÊÄùËÄÉËøáÁ®ã</span>
                </div>
                <div class="thinking-content markdown-body" v-html="renderMarkdown(message.thinking)"></div>
              </div>
              <!-- Ê∂àÊÅØÂÜÖÂÆπÂå∫ -->
              <div class="message-text markdown-body" v-html="renderMarkdown(message.content)"></div>
              <div class="message-time">{{ message.time }}</div>
            </div>
          </div>
          <div class="typing-indicator" v-if="isTyping">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      </div>
      
      <!-- ÊøÄÊ¥ªÁöÑÁ≥ªÁªüÊèêÁ§∫ËØçÊòæÁ§∫Âå∫Âüü -->
      <div class="active-prompt-container" v-if="activeSystemPrompt">
        <div class="active-prompt-badge">
          <div class="active-prompt-header">
            <div class="active-prompt-info">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              <div class="prompt-title-wrapper">
                <div class="prompt-label-row">
                  <span class="prompt-title-label">Á≥ªÁªüÊèêÁ§∫ËØç</span>
                  <button class="active-prompt-close" @click="clearActiveSystemPrompt">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
                <span class="active-prompt-title" :title="activeSystemPrompt.name">{{ activeSystemPrompt.name }}</span>
                <div class="prompt-actions-row">
                  <div class="active-prompt-category" :style="{ backgroundColor: getPromptCategoryColor(activeSystemPrompt.category) }">
                    {{ getCategoryLabel(activeSystemPrompt.category) }}
                  </div>
                  <div v-if="activeSystemPrompt.functionToolId" class="active-prompt-tool-id" title="ÂäüËÉΩÂ∑•ÂÖ∑ID">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                    </svg>
                    <span>{{ activeSystemPrompt.functionToolId }}</span>
                  </div>
                  <button class="active-prompt-toggle" @click="showActivePromptBadge = !showActivePromptBadge">
                    <span>{{ showActivePromptBadge ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ' }}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="6 9 12 15 18 9" v-if="!showActivePromptBadge"></polyline>
                      <polyline points="18 15 12 9 6 15" v-else></polyline>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="active-prompt-content" v-if="showActivePromptBadge">
            <pre class="active-prompt-text">{{ activeSystemPrompt.content }}</pre>
          </div>
        </div>

      </div>
      <!-- ‰∏≠Â§ÆËæìÂÖ•Âå∫Âüü -->
      <div class="chat-input-wrapper" :class="{
        'with-messages': messages.length > 0,
        'sidebar-expanded': !sidebarCollapsed
      }">
        <div class="chat-input-area">
          <div class="mode-selector-inner">
            <button class="mode-btn deep-think-btn" @click="isDeepThinking = !isDeepThinking" :class="{ 'active': isDeepThinking }" title="ÊµÅÂºèËæìÂá∫">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 2a4.5 4.5 0 0 0 0 9 4.5 4.5 0 0 1 0 9 10 10 0 0 0 0-18z"></path>
                <path d="M12 8a2.5 2.5 0 1 0 0 5 2.5 2.5 0 1 0 0-5"></path>
              </svg>
              <span>ÊµÅÂºèËæìÂá∫</span>
            </button>
            <button class="mode-btn web-search-btn" @click="showToast('ËÅîÁΩëÊêúÁ¥¢ÂäüËÉΩÂºÄÂèë‰∏≠')" title="ËÅîÁΩëÊêúÁ¥¢">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
              </svg>
              <span>ËÅîÁΩëÊêúÁ¥¢</span>
            </button>
            <button class="mode-btn cloud-model-btn" @click="useCloudModel = !useCloudModel" :class="{ 'active': useCloudModel }" title="‰∫ëÁ´ØÂ§ßÊ®°Âûã">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
              </svg>
              <span>‰∫ëÁ´ØÂ§ßÊ®°Âûã</span>
            </button>
          </div>
          
          <div class="input-row">
            <!-- ÈÄâ‰∏≠ÁöÑÊñá‰ª∂Â±ïÁ§∫ -->
            <div class="selected-files" v-if="selectedFiles.length > 0">
              <div 
                v-for="(file, index) in selectedFiles" 
                :key="`file-${index}`"
                class="selected-file-item"
              >
                <div class="file-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                  </svg>
                </div>
                <span class="file-name">{{ file.name }}</span>
                <span class="file-size">({{ formatFileSize(file.size) }})</span>
                <button class="remove-file-btn" @click="removeSelectedFile(index)" title="ÁßªÈô§Êñá‰ª∂">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
            </div>
            
            <div 
              class="input-container"
              :class="{ 'dragging': isDragging }"
              @drop="handleFileDrop"
              @dragover.prevent
              @dragenter.prevent="isDragging = true"
              @dragleave.prevent="isDragging = false"
            >
              <textarea 
                v-model="userInput" 
                class="chat-input" 
                placeholder="Áªô Â∞èÂûãÂçöÁæé ÂèëÈÄÅÊ∂àÊÅØÔºàÊîØÊåÅÊãñÊãΩÊñá‰ª∂‰∏ä‰º†Ôºâ" 
                @keydown.enter.prevent="sendMessage"
                rows="1"
                ref="inputRef"
              ></textarea>
              
              <div class="input-tools">
              <!-- Ê®°ÂûãÂàáÊç¢ÊåâÈíÆ -->
              <button class="tool-btn model-switch-btn" @click="openModelSelector" title="Ê®°ÂûãÂàáÊç¢">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                  <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                  <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
              </button>
              <button class="tool-btn prompt-library-btn" @click="openPromptLibrary" title="ÊèêÁ§∫ËØçÂ∫ì">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
              </button>
              <button class="tool-btn upload-btn" @click="triggerFileUpload" title="‰∏ä‰º†Êñá‰ª∂">
                <input 
                  ref="fileInputRef" 
                  type="file" 
                  multiple 
                  accept="image/*,.pdf,.doc,.docx,.txt,.xlsx,.xls" 
                  @change="handleFileSelect" 
                  style="display: none;"
                />
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
              </button>
              <button class="tool-btn file-manager-btn" @click="openFileManager" title="ÁÆ°ÁêÜÊñá‰ª∂">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              </button>
              <button class="send-btn" @click="sendMessage" :disabled="!userInput.trim()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Toast Ê∂àÊÅØÊèêÁ§∫ -->
    <div class="toast-container" v-if="toast.show" :class="{ 'toast-show': toast.show }">
      <div class="toast-message">{{ toast.message }}</div>
    </div>
    
    <!-- Ê†áÁ≠æÈÄâÊã©Âô®ÂºπÂá∫Â±Ç -->
    <div class="modal-overlay" v-if="showTagSelector" @mousedown="handleModalOverlayMouseDown" @mouseup="handleModalOverlayMouseUp">
      <div class="modal-container tag-selector" @click.stop>
        <div class="modal-header">
          <h3>ÁºñËæë‰ºöËØù</h3>
          <button class="modal-close" @click="showTagSelector = false">√ó</button>
        </div>
        <div class="modal-body">
          <!-- Ê∑ªÂä†‰ºöËØùÊ†áÈ¢òÁºñËæë -->
          <div class="form-group mb-4">
            <label for="chatTitle" class="form-label mb-2 font-medium text-gray-700">‰ºöËØùÊ†áÈ¢ò</label>
            <input 
              type="text" 
              id="chatTitle" 
              v-model="editingChatTitle" 
              class="title-input" 
              placeholder="ËØ∑ËæìÂÖ•‰ºöËØùÊ†áÈ¢ò"
            />
          </div>
          
          <div class="form-group mb-4">
            <label class="form-label mb-2 font-medium text-gray-700">ÈÄâÊã©Ê†áÁ≠æ</label>
            <div class="tags-container">
              <div 
                v-for="tag in availableTags" 
                :key="tag.id" 
                class="tag-item"
                :class="{ selected: isTagSelected(tag.name) }"
                @click="toggleTag(tag.name)"
                :style="{ borderColor: tag.color }"
              >
                <span class="tag-color" :style="{ backgroundColor: tag.color }"></span>
                <span class="tag-name">{{ tag.name }}</span>
                <span class="tag-check" v-if="isTagSelected(tag.name)">‚úì</span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" @click="showTagSelector = false">ÂèñÊ∂à</button>
          <button class="confirm-btn" @click="saveTagsToChat">‰øùÂ≠ò</button>
        </div>
      </div>
    </div>
    
    <!-- ÂØºÂá∫ËèúÂçïÂºπÂá∫Â±Ç -->
    <div class="modal-overlay" v-if="showExportMenu" @mousedown="handleModalOverlayMouseDown" @mouseup="handleExportMenuOverlayMouseUp">
      <div class="modal-container export-menu" @click.stop>
        <div class="modal-header">
          <h3>ÂØºÂá∫ÂØπËØù</h3>
          <button class="modal-close" @click="showExportMenu = false">√ó</button>
        </div>
        <div class="modal-body">
          <div class="export-options">
            <div 
              v-for="format in exportFormats" 
              :key="format.id" 
              class="export-option"
              @click="exportConversation(format.id)"
            >
              <span class="export-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              </span>
              <span class="export-format">{{ format.name }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Êñá‰ª∂ÁÆ°ÁêÜÂô®ÂºπÂá∫Â±Ç -->
    <div class="modal-overlay" v-if="showFileManager" @mousedown="handleModalOverlayMouseDown" @mouseup="handleFileManagerOverlayMouseUp">
      <div class="modal-container file-manager" @click.stop style="max-width: 700px; width: 90%;">
        <div class="modal-header">
          <h3>Êñá‰ª∂ÁÆ°ÁêÜ</h3>
          <button class="modal-close" @click="showFileManager = false">√ó</button>
        </div>
        <div class="modal-body">
          <div class="file-manager-toolbar">
            <div class="file-search">
              <input 
                type="text" 
                v-model="fileSearchQuery" 
                placeholder="ÊêúÁ¥¢Êñá‰ª∂..." 
                class="file-search-input"
              />
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </div>
            <div class="file-filters">
              <button 
                :class="['filter-btn', currentFilter === 'all' ? 'active' : '']" 
                @click="currentFilter = 'all'"
              >
                ÂÖ®ÈÉ®
              </button>
              <button 
                :class="['filter-btn', currentFilter === 'accessible' ? 'active' : '']" 
                @click="currentFilter = 'accessible'"
              >
                AIÂèØËÆøÈóÆ
              </button>
              <button 
                :class="['filter-btn', currentFilter === 'restricted' ? 'active' : '']" 
                @click="currentFilter = 'restricted'"
              >
                AIÂèóÈôê
              </button>
            </div>
            <button class="upload-file-btn" @click="openUploadModal">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              ‰∏ä‰º†Êñá‰ª∂
            </button>
          </div>
          
          <div class="files-container">
            <div 
              v-for="file in filteredFiles" 
              :key="file.id" 
              :class="['file-item', selectedFile === file.id ? 'selected' : '']"
              @click="selectFile(file.id)"
            >
              <div class="file-icon">
                <svg v-if="file.type === 'pdf'" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <rect x="8" y="12" width="8" height="2" rx="1"></rect>
                  <rect x="8" y="16" width="8" height="2" rx="1"></rect>
                </svg>
                <svg v-else-if="file.type === 'docx'" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4285F4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                <svg v-else-if="file.type === 'xlsx'" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#34A853" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="9" y1="3" x2="9" y2="21"></line>
                  <line x1="3" y1="9" x2="21" y2="9"></line>
                </svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                  <polyline points="13 2 13 9 20 9"></polyline>
                </svg>
              </div>
              <div class="file-details">
                <div class="file-name" :class="{ 'restricted': !file.aiAccessible }">
                  {{ file.name }}
                  <span v-if="!file.aiAccessible" class="restricted-badge">AIÂèóÈôê</span>
                </div>
                <div class="file-meta">
                  <span class="file-size">{{ formatFileSize(file.size) }}</span>
                  <span class="file-date">{{ file.uploadTime }}</span>
                </div>
                <div class="file-description">{{ file.description || 'Êó†ÊèèËø∞' }}</div>
              </div>
              <div class="file-actions">
                <button class="file-action-btn toggle-access" @click.stop="toggleAccess(file.id)" :title="file.aiAccessible ? 'ËÆæ‰∏∫AIÂèóÈôê' : 'ÂÖÅËÆ∏AIËÆøÈóÆ'">
                  <svg v-if="file.aiAccessible" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  <svg v-else xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                    <line x1="2" y1="2" x2="22" y2="22"></line>
                  </svg>
                </button>
                <button class="file-action-btn delete-file" @click.stop="deleteFile(file.id)" title="Âà†Èô§Êñá‰ª∂">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div class="no-files" v-if="filteredFiles.length === 0">
              Ê≤°ÊúâÂåπÈÖçÁöÑÊñá‰ª∂
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" @click="showFileManager = false">ÂÖ≥Èó≠</button>
        </div>
      </div>
    </div>
    
    <!-- Êñá‰ª∂‰∏ä‰º†Ê®°ÊÄÅÊ°Ü -->
    <div class="modal-overlay" v-if="showFileUploadModal" @mousedown="handleModalOverlayMouseDown" @mouseup="handleFileUploadOverlayMouseUp">
      <div class="modal-container file-upload-modal" @click.stop>
        <div class="modal-header">
          <h3>‰∏ä‰º†Êñá‰ª∂</h3>
          <button class="modal-close" @click="showFileUploadModal = false">√ó</button>
        </div>
        <div class="modal-body">
          <div class="file-upload-area">
            <div class="upload-dropzone">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <p>ÁÇπÂáªÊàñÊãñÊãΩÊñá‰ª∂Ëá≥Ê≠§Â§Ñ‰∏ä‰º†</p>
              <span class="upload-formats">ÊîØÊåÅÁöÑÊ†ºÂºè: PDF, Word, Excel, TXT</span>
            </div>
            
            <div class="upload-form">
              <div class="form-group">
                <label for="file-name">Êñá‰ª∂ÂêçÁß∞</label>
                <input type="text" id="file-name" v-model="newFile.name" placeholder="ËØ∑ËæìÂÖ•Êñá‰ª∂ÂêçÁß∞" />
              </div>
              <div class="form-group">
                <label for="file-description">Êñá‰ª∂ÊèèËø∞</label>
                <textarea id="file-description" v-model="newFile.description" placeholder="ËØ∑ËæìÂÖ•Êñá‰ª∂ÊèèËø∞ÔºàÂèØÈÄâÔºâ" rows="3"></textarea>
              </div>
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" v-model="newFile.aiAccessible" />
                  ÂÖÅËÆ∏AIËÆøÈóÆËØ•Êñá‰ª∂ÂÜÖÂÆπ
                  <span class="hint">ÈÄâ‰∏≠ÂêéÔºåÂ∞èÂûãÂçöÁæéÂ∞ÜÂèØ‰ª•ËØªÂèñÂíåÂàÜÊûêËØ•Êñá‰ª∂ÂÜÖÂÆπ</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" @click="showFileUploadModal = false">ÂèñÊ∂à</button>
          <button class="confirm-btn" @click="uploadFile">‰∏ä‰º†</button>
        </div>
      </div>
    </div>
    
    <!-- ‰∏ªÈ¢òËÆæÁΩÆÂºπÂá∫Á™óÂè£ -->
    <div class="modal-overlay" v-if="showThemeSettings" @mousedown="handleModalOverlayMouseDown" @mouseup="handleThemeSettingsOverlayMouseUp">
      <div class="modal-container theme-settings" @click.stop style="max-width: 860px; width: 90%;">
        <div class="modal-header">
          <h3>‰∏™ÊÄßÂåñËÆæÁΩÆ</h3>
          <button class="modal-close" @click="showThemeSettings = false">√ó</button>
        </div>
        <div class="modal-body">
          <div class="settings-layout">
            <div class="settings-column">
              <div class="theme-section">
                <div class="section-row">
                  <h4 class="section-title">‰∏ªÈ¢òÈ£éÊ†º</h4>
                  <div class="theme-options">
                    <div 
                      v-for="theme in themeOptions" 
                      :key="theme.id"
                      :class="['theme-option', currentTheme === theme.id ? 'selected' : '']"
                      @click="setTheme(theme.id)"
                    >
                      <div class="theme-preview" :style="{ background: theme.preview }"></div>
                      <div class="theme-name">{{ theme.name }}</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="theme-section">
                <div class="section-row">
                  <h4 class="section-title">ÊòéÊöóÊ®°Âºè</h4>
                  <div class="mode-toggle">
                    <button 
                      :class="['mode-btn', !isDarkMode ? 'active' : '']" 
                      @click="setDarkMode(false)"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                      </svg>
                      <span>ÊµÖËâ≤</span>
                    </button>
                    <button 
                      :class="['mode-btn', isDarkMode ? 'active' : '']" 
                      @click="setDarkMode(true)"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                      </svg>
                      <span>Ê∑±Ëâ≤</span>
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="theme-section">
                <div class="font-settings">
                  <div class="font-setting section-row">
                    <span class="setting-label">Â≠ó‰ΩìÂ§ßÂ∞è</span>
                    <div class="setting-options">
                      <button 
                        :class="['option-btn', currentFontSettings.size === 'small' ? 'active' : '']"
                        @click="setFontSize('small')"
                      >
                        Â∞è
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.size === 'medium' ? 'active' : '']"
                        @click="setFontSize('medium')"
                      >
                        ‰∏≠
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.size === 'large' ? 'active' : '']"
                        @click="setFontSize('large')"
                      >
                        Â§ß
                      </button>
                    </div>
                  </div>
                  
                  <div class="font-setting section-row">
                    <span class="setting-label">Â≠ó‰ΩìÈó¥Ë∑ù</span>
                    <div class="setting-options">
                      <button 
                        :class="['option-btn', currentFontSettings.spacing === 'compact' ? 'active' : '']"
                        @click="setFontSpacing('compact')"
                      >
                        Á¥ßÂáë
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.spacing === 'normal' ? 'active' : '']"
                        @click="setFontSpacing('normal')"
                      >
                        Ê†áÂáÜ
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.spacing === 'relaxed' ? 'active' : '']"
                        @click="setFontSpacing('relaxed')"
                      >
                        ÂÆΩÊùæ
                      </button>
                    </div>
                  </div>
                  
                  <div class="font-setting section-row">
                    <span class="setting-label">Â≠ó‰ΩìÈ£éÊ†º</span>
                    <div class="setting-options">
                      <button 
                        :class="['option-btn', currentFontSettings.family === 'default' ? 'active' : '']"
                        @click="setFontFamily('default')"
                      >
                        ÈªòËÆ§
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.family === 'serif' ? 'active' : '']"
                        @click="setFontFamily('serif')"
                      >
                        Ë°¨Á∫ø
                      </button>
                      <button 
                        :class="['option-btn', currentFontSettings.family === 'mono' ? 'active' : '']"
                        @click="setFontFamily('mono')"
                      >
                        Á≠âÂÆΩ
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="settings-column">
              <div class="theme-preview-section">
                <h4 class="section-title">È¢ÑËßàÊïàÊûú</h4>
                <div 
                  class="preview-container"
                  :class="[
                    `theme-${currentTheme}`, 
                    isDarkMode ? 'dark-mode' : '',
                    `font-size-${currentFontSettings.size}`,
                    `font-spacing-${currentFontSettings.spacing}`,
                    `font-family-${currentFontSettings.family}`
                  ]"
                >
                  <div class="preview-header">
                    <div class="preview-logo">Â∞èÂûãÂçöÁæé</div>
                    <div class="preview-controls"></div>
                  </div>
                  <div class="preview-message user">ÊÇ®Â•ΩÔºåËØ∑ÈóÆÂ¶Ç‰Ωï‰ºòÂåñÊàëÁöÑÊèêÁ§∫ËØçÔºü</div>
                  <div class="preview-message bot">
                    Ë¶Å‰ºòÂåñÊèêÁ§∫ËØçÔºåÂèØ‰ª•ËÄÉËôë‰ª•‰∏ãÂá†ÁÇπÔºö‰ΩøÁî®Ê∏ÖÊô∞ÂÖ∑‰ΩìÁöÑÊåáÁ§∫„ÄÅÊèê‰æõ‰∏ä‰∏ãÊñá‰ø°ÊÅØ„ÄÅËÆæÂÆöÂêàÈÄÇÁöÑËßíËâ≤ÂíåÊ†ºÂºèË¶ÅÊ±Ç„ÄÅÂàÜÊ≠•È™§ÂºïÂØºÂõûÁ≠î„ÄÇ
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" @click="resetThemeSettings">ÈáçÁΩÆ</button>
          <button class="confirm-btn" @click="applyThemeSettings">Â∫îÁî®</button>
        </div>
      </div>
    </div>
    
    <!-- ÊèêÁ§∫ËØçÂ∫ìÂºπÂá∫Â±Ç -->
    <div class="modal-overlay" v-if="showPromptLibrary" @mousedown="handleModalOverlayMouseDown" @mouseup="handlePromptLibraryOverlayMouseUp">
      <div class="modal-container prompt-library" @click.stop style="max-width: 900px; width: 90%; max-height: 80vh;">
        <div class="modal-header">
          <h3>Á≥ªÁªüÊèêÁ§∫ËØçÂ∫ì</h3>
          <button class="modal-close" @click="showPromptLibrary = false">√ó</button>
        </div>
        <div class="modal-body" style="max-height: calc(80vh - 120px); overflow-y: auto;">
          <div class="prompt-library-toolbar">
            <div class="prompt-search">
              <input 
                type="text" 
                v-model="promptSearchQuery" 
                placeholder="ÊêúÁ¥¢ÊèêÁ§∫ËØç..." 
                class="prompt-search-input"
              />
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </div>
            <div class="prompt-filters">
              <button 
                :class="['filter-btn', currentPromptFilter === 'all' ? 'active' : '']" 
                @click="currentPromptFilter = 'all'"
              >
                ÂÖ®ÈÉ®
              </button>
              <button 
                :class="['filter-btn', currentPromptFilter === 'writing' ? 'active' : '']" 
                @click="currentPromptFilter = 'writing'"
              >
                ÂÜô‰Ωú
              </button>
              <button 
                :class="['filter-btn', currentPromptFilter === 'coding' ? 'active' : '']" 
                @click="currentPromptFilter = 'coding'"
              >
                ÁºñÁ®ã
              </button>
              <button 
                :class="['filter-btn', currentPromptFilter === 'analysis' ? 'active' : '']" 
                @click="currentPromptFilter = 'analysis'"
              >
                ÂàÜÊûê
              </button>
              <button 
                :class="['filter-btn', currentPromptFilter === 'creativity' ? 'active' : '']" 
                @click="currentPromptFilter = 'creativity'"
              >
                ÂàõÊÑè
              </button>
              <button 
                :class="['filter-btn', currentPromptFilter === 'education' ? 'active' : '']" 
                @click="currentPromptFilter = 'education'"
              >
                ÊïôËÇ≤
              </button>
            </div>
            <button class="add-prompt-btn" @click="openAddPromptModal">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Êñ∞Â¢ûÊèêÁ§∫ËØç
            </button>
          </div>
          
          <div class="prompts-container">
            <div class="prompts-grid">
              <div 
                v-for="prompt in filteredPrompts" 
                :key="prompt.id" 
                class="prompt-card"
                :style="{ borderColor: getPromptCategoryColor(prompt.category) }"
                @mouseover="(event) => showPromptPreview(prompt, event)"
                @mouseleave="hidePromptPreview()"
              >
                <div class="prompt-card-header" :style="{ backgroundColor: getPromptCategoryColor(prompt.category) }">
                  <span class="prompt-name">{{ prompt.name }}</span>
                  <div class="prompt-category-badge">{{ getCategoryLabel(prompt.category) }}</div>
                </div>
                <div class="prompt-card-body">
                  <div class="prompt-description">{{ prompt.description }}</div>
                  <div v-if="prompt.functionToolId" class="prompt-tool-id">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                    </svg>
                    <span>{{ prompt.functionToolId }}</span>
                  </div>
                  <div class="prompt-tags">
                    <span v-for="(tag, index) in prompt.tags.slice(0, 3)" :key="index" class="prompt-tag">
                      {{ tag }}
                    </span>
                    <span v-if="prompt.tags.length > 3" class="prompt-tag-more">+{{ prompt.tags.length - 3 }}</span>
                  </div>
                </div>
                <div class="prompt-card-footer">
                  <div class="prompt-actions">
                    <button class="prompt-action-btn copy-btn" @click.stop="copyPromptToInput(prompt)" title="ËÆæÁΩÆ‰∏∫Á≥ªÁªüÊèêÁ§∫ËØç">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                      </svg>
                    </button>
                    <button class="prompt-action-btn edit-btn" @click.stop="editPrompt(prompt)" title="ÁºñËæëÊèêÁ§∫ËØç">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </button>
                    <button class="prompt-action-btn delete-btn" @click.stop="deletePrompt(prompt.id)" title="Âà†Èô§ÊèêÁ§∫ËØç">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                        <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="no-prompts" v-if="filteredPrompts.length === 0">
              Ê≤°ÊúâÂåπÈÖçÁöÑÊèêÁ§∫ËØç
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ÊèêÁ§∫ËØçÈ¢ÑËßàÊèêÁ§∫ -->
    <div class="prompt-preview-tooltip" v-if="showPreview" :style="previewPosition">
      <div class="preview-header">ÂÜÖÂÆπÈ¢ÑËßà</div>
      <div class="preview-content">{{ previewContent }}</div>
    </div>
    
    <!-- Êñ∞Â¢û/ÁºñËæëÊèêÁ§∫ËØçÂºπÂá∫Â±Ç -->
    <div class="modal-overlay" v-if="showPromptModal" @mousedown="handleModalOverlayMouseDown" @mouseup="handlePromptModalOverlayMouseUp">
      <div class="modal-container prompt-modal" @click.stop>
        <div class="modal-header">
          <h3>{{ isEditingPrompt ? 'ÁºñËæëÊèêÁ§∫ËØç' : 'Êñ∞Â¢ûÊèêÁ§∫ËØç' }}</h3>
          <button class="modal-close" @click="showPromptModal = false">√ó</button>
        </div>
        <div class="modal-body">
          <div class="prompt-form">
            <div class="form-group">
              <label for="promptName">ÊèêÁ§∫ËØçÂêçÁß∞</label>
              <input type="text" id="promptName" v-model="editingPrompt.name" placeholder="ËæìÂÖ•ÊèêÁ§∫ËØçÂêçÁß∞">
            </div>
            
            <div class="form-group">
              <label for="promptCategory">Á±ªÂûã</label>
              <select id="promptCategory" v-model="editingPrompt.category">
                <option value="writing">ÂÜô‰Ωú</option>
                <option value="coding">ÁºñÁ®ã</option>
                <option value="analysis">ÂàÜÊûê</option>
                <option value="creativity">ÂàõÊÑè</option>
                <option value="education">ÊïôËÇ≤</option>
                <option value="other">ÂÖ∂‰ªñ</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="promptDescription">ÁÆÄÁü≠ÊèèËø∞</label>
              <input type="text" id="promptDescription" v-model="editingPrompt.description" placeholder="ÁÆÄÁü≠ÊèèËø∞Ê≠§ÊèêÁ§∫ËØçÁöÑÁî®ÈÄî">
            </div>
            
            <div class="form-group">
              <label for="promptTags">Ê†áÁ≠æ (Áî®ÈÄóÂè∑ÂàÜÈöî)</label>
              <input type="text" id="promptTags" v-model="promptTagsInput" placeholder="‰æãÂ¶Ç: ‰∏ì‰∏ö,Êä•Âëä,Â∑•‰Ωú">
            </div>
            
            <div class="form-group">
              <label for="functionToolId">ÂäüËÉΩÂ∑•ÂÖ∑ID</label>
              <input type="text" id="functionToolId" v-model="editingPrompt.functionToolId" placeholder="ËæìÂÖ•ÂäüËÉΩÂ∑•ÂÖ∑IDÔºàÂèØÈÄâÔºâ">
              <div class="field-hint">Áî®‰∫éÂÖ≥ËÅîÁâπÂÆöÁöÑÂäüËÉΩÂ∑•ÂÖ∑ÔºåÂ¶ÇÊûú‰∏çÈúÄË¶ÅÂèØ‰ª•ÁïôÁ©∫</div>
            </div>
            
            <div class="form-group">
              <label for="promptContent">ÊèêÁ§∫ËØçÂÜÖÂÆπ</label>
              
              <textarea 
                id="promptContent" 
                v-model="editingPrompt.content" 
                placeholder="ËæìÂÖ•ÊèêÁ§∫ËØçÂÜÖÂÆπ..." 
                rows="8"
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" @click="showPromptModal = false">ÂèñÊ∂à</button>
          <button class="confirm-btn" @click="savePrompt">‰øùÂ≠ò</button>
        </div>
      </div>
    </div>
    
    <!-- Ê®°ÂûãÈÄâÊã©Âô®ÂºπÂá∫Â±Ç -->
    <div class="modal-overlay" v-if="showModelSelector" @mousedown="handleModalOverlayMouseDown" @mouseup="handleModelSelectorOverlayMouseUp">
      <div class="modal-container model-selector" @click.stop style="max-width: 600px; width: 90%;">
        <div class="modal-header">
          <h3>ÈÄâÊã©Ê®°Âûã</h3>
          <button class="modal-close" @click="showModelSelector = false">√ó</button>
        </div>
        <div class="modal-body">
          <div class="models-container">
            <div 
              v-for="model in availableModels" 
              :key="model.id" 
              :class="['model-item', tempSelectedModel === model.id ? 'selected' : '']"
              @click="selectModel(model.id)"
            >
              <div class="model-icon" :style="{ backgroundColor: model.color }">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                  <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                  <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
              </div>
              <div class="model-details">
                <div class="model-name">{{ model.name }}</div>
                <div class="model-provider" v-if="model.provider">Êèê‰æõÂïÜ: {{ model.provider }}</div>
                <div class="model-description">{{ model.description }}</div>
                <div class="model-tags">
                  <span 
                    v-for="(tag, tagIndex) in model.tags" 
                    :key="tagIndex" 
                    class="model-tag"
                  >
                    {{ tag }}
                  </span>
                </div>
              </div>
              <div class="model-select-indicator" v-if="tempSelectedModel === model.id">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </div>

            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" @click="showModelSelector = false">ÂèñÊ∂à</button>
          <button class="confirm-btn" @click="applyModelSelection">Á°ÆËÆ§ÈÄâÊã©</button>
        </div>
      </div>
    </div>
    

    

  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, watch, nextTick, computed } from 'vue';
import { marked } from 'marked';

// ÈÖçÁΩÆ marked
marked.setOptions({
  breaks: true, // ÂÖÅËÆ∏Êç¢Ë°å
  gfm: true,    // ÂêØÁî®GFM
  headerIds: false // Á¶ÅÁî®Ëá™Âä®Ê∑ªÂä†id
});

// APIÂü∫Á°ÄURL
const API_BASE_URL = import.meta.env.VITE_APP_AI_API_URL || 'http://localhost:28928';

// ËÅäÂ§©Ê∂àÊÅØ
interface Message {
  role: 'user' | 'bot';
  content: string;
  time: string;
  thinking?: string; // Ê∑ªÂä†ÊÄùËÄÉÂÜÖÂÆπÂ≠óÊÆµ
}

// ÂéÜÂè≤ËÆ∞ÂΩï
interface HistoryItem {
  id: number;
  title: string;
  time: string;
  tags?: string[]; // Ê∑ªÂä†Ê†áÁ≠æÂ≠óÊÆµ
  exportedFormats?: string[]; // Ê∑ªÂä†ÂØºÂá∫Ê†ºÂºèËÆ∞ÂΩï
}

// Ê†áÁ≠æÁ±ªÂûã
interface Tag {
  id: number;
  name: string;
  color: string;
}

// Êñá‰ª∂Á±ªÂûã
interface FileItem {
  id: number;
  name: string;
  type: string;
  size: number;
  uploadTime: string;
  aiAccessible: boolean; // ÊòØÂê¶ÂÖÅËÆ∏AIËÆøÈóÆËØ•Êñá‰ª∂
  description?: string;
}

// ‰∏ªÈ¢òËÆæÁΩÆ
interface ThemeOption {
  id: string;
  name: string;
  primaryColor: string;
  secondaryColor: string;
  backgroundColor: string;
  textColor: string;
  accentColor: string;
  preview: string; // CSS gradient for preview
}

// ÊèêÁ§∫ËØçÊ®°Êùø
interface PromptTemplate {
  id: number;
  name: string;
  description: string;
  content: string;
  category: string;
  tags: string[];
  usageCount: number;
  functionToolId?: string; // Êñ∞Â¢ûÂäüËÉΩÂ∑•ÂÖ∑IDÂ≠óÊÆµ
}

// ÊèêÁ§∫ËØçËØÑÂàÜ
interface PromptEvaluation {
  clarity: number; // Ê∏ÖÊô∞Â∫¶
  specificity: number; // ÂÖ∑‰ΩìÂ∫¶
  context: number; // ‰∏ä‰∏ãÊñá
  conciseness: number; // ÁÆÄÊ¥ÅÂ∫¶
  structure: number; // ÁªìÊûÑÊÄß
  overall: number; // ÊÄª‰ΩìËØÑÂàÜ
  suggestions: string[]; // ÊîπËøõÂª∫ËÆÆ
}

// Â≠ó‰ΩìËÆæÁΩÆ
interface FontSetting {
  size: 'small' | 'medium' | 'large';
  spacing: 'compact' | 'normal' | 'relaxed';
  family: 'default' | 'serif' | 'mono';
}

const userInput = ref('');
const messages = ref<Message[]>([]);
const isTyping = ref(false);
const chatContentRef = ref<HTMLElement | null>(null);
const inputRef = ref<HTMLTextAreaElement | null>(null);
const fileInputRef = ref<HTMLInputElement | null>(null);
const sidebarCollapsed = ref(false);
const useCloudModel = ref(false); // ÊòØÂê¶‰ΩøÁî®‰∫ëÁ´ØÂ§ßÊ®°Âûã
const streamController = ref<AbortController | null>(null); // Áî®‰∫éÊéßÂà∂ÊµÅÂºèËØ∑Ê±Ç
const isDeepThinking = ref(false); // ÊòØÂê¶ÂºÄÂêØÊµÅÂºèËæìÂá∫Ê®°Âºè

// Êñá‰ª∂‰∏ä‰º†Áõ∏ÂÖ≥Áä∂ÊÄÅ
const selectedFiles = ref<File[]>([]);
const isDragging = ref(false);

// ÂêéÁ´ØÊúçÂä°Âô®ÈÖçÁΩÆ

// ‰∏ªÈ¢òËÆæÁΩÆÁõ∏ÂÖ≥Áä∂ÊÄÅ
const showThemeSettings = ref(false);
const isDarkMode = ref(false);
const currentTheme = ref('default');
const currentFontSettings = ref<FontSetting>({
  size: 'medium',
  spacing: 'normal',
  family: 'default'
});

// ÊèêÁ§∫ËØçÂ∑•Á®ãÂ∑•ÂÖ∑Áõ∏ÂÖ≥Áä∂ÊÄÅ
const showPromptEngineer = ref(false);
const currentPrompt = ref('');
const promptName = ref('');
const promptCategory = ref('general');
const promptTags = ref<string[]>([]);
const currentTemplateId = ref<number | null>(null);
const isEvaluating = ref(false);
const promptEvaluation = ref<PromptEvaluation>({
  clarity: 0,
  specificity: 0,
  context: 0,
  conciseness: 0,
  structure: 0,
  overall: 0,
  suggestions: []
});

// È¢ÑÂÆö‰πâÁöÑ‰∏ªÈ¢ò
const themeOptions = ref<ThemeOption[]>([
  {
    id: 'default',
    name: 'ÈªòËÆ§Ëìù',
    primaryColor: '#4665ee',
    secondaryColor: '#f0f0f3',
    backgroundColor: '#f7f7f9',
    textColor: '#333333',
    accentColor: '#FF6B95',
    preview: 'linear-gradient(to right, #4665ee, #6B8CFF)'
  },
  {
    id: 'emerald',
    name: 'Áø°Áø†Áªø',
    primaryColor: '#10b981',
    secondaryColor: '#ecfdf5',
    backgroundColor: '#f8fafc',
    textColor: '#1e293b',
    accentColor: '#8b5cf6',
    preview: 'linear-gradient(to right, #10b981, #34d399)'
  },
  {
    id: 'sunset',
    name: 'ÊôöÈúûÊ©ô',
    primaryColor: '#f97316',
    secondaryColor: '#fff7ed',
    backgroundColor: '#fffbf5',
    textColor: '#431407',
    accentColor: '#3b82f6',
    preview: 'linear-gradient(to right, #f97316, #fb923c)'
  },
  {
    id: 'lavender',
    name: 'Ëñ∞Ë°£Ëçâ',
    primaryColor: '#8b5cf6',
    secondaryColor: '#f5f3ff',
    backgroundColor: '#faf5ff',
    textColor: '#581c87',
    accentColor: '#ec4899',
    preview: 'linear-gradient(to right, #8b5cf6, #a78bfa)'
  },
  {
    id: 'graphite',
    name: 'Áü≥Â¢®Èªë',
    primaryColor: '#334155',
    secondaryColor: '#f1f5f9',
    backgroundColor: '#f8fafc',
    textColor: '#0f172a',
    accentColor: '#6366f1',
    preview: 'linear-gradient(to right, #334155, #475569)'
  }
]);

// Êñá‰ª∂ÁÆ°ÁêÜÁõ∏ÂÖ≥Áä∂ÊÄÅ
const showFileManager = ref(false);
const userFiles = ref<FileItem[]>([
  { 
    id: 1, 
    name: '‰∫ßÂìÅËØ¥Êòé‰π¶.pdf', 
    type: 'pdf', 
    size: 2560000, 
    uploadTime: '2023-06-15', 
    aiAccessible: true,
    description: 'ÂåÖÂê´ÂÖ¨Âè∏ÊúÄÊñ∞‰∫ßÂìÅÁöÑËØ¶ÁªÜËØ¥ÊòéÂíå‰ΩøÁî®ÊåáÂçó'
  },
  { 
    id: 2, 
    name: 'ÂëòÂ∑•ÊâãÂÜå.docx', 
    type: 'docx', 
    size: 1280000, 
    uploadTime: '2023-05-20', 
    aiAccessible: true,
    description: 'ÂÖ¨Âè∏ÂëòÂ∑•ÊâãÂÜåÔºåÂåÖÂê´ÂÖ¨Âè∏ÊîøÁ≠ñÂíåËßÑÁ´†Âà∂Â∫¶'
  },
  { 
    id: 3, 
    name: 'Ë¥¢Âä°Êä•Ë°®.xlsx', 
    type: 'xlsx', 
    size: 856000, 
    uploadTime: '2023-06-01', 
    aiAccessible: false,
    description: 'ÂÖ¨Âè∏2023Âπ¥Q2Ë¥¢Âä°Êä•Ë°®ÔºàÊïèÊÑüËµÑÊñôÔºâ'
  }
]);
const selectedFile = ref<number | null>(null);
const currentFilter = ref('all'); // 'all', 'accessible', 'restricted'
const fileSearchQuery = ref('');
const showFileUploadModal = ref(false);
const newFile = ref<FileItem>({
  id: 0,
  name: '',
  type: '',
  size: 0,
  uploadTime: '',
  aiAccessible: true,
  description: ''
});

// Ê†áÁ≠æÂäüËÉΩÁõ∏ÂÖ≥Áä∂ÊÄÅ
const availableTags = ref<Tag[]>([
  { id: 1, name: 'ÈáçË¶Å', color: '#FF6B95' },
  { id: 2, name: 'Â∑•‰Ωú', color: '#4665ee' },
  { id: 3, name: 'Â≠¶‰π†', color: '#42b983' },
  { id: 4, name: 'ÂèÇËÄÉ', color: '#f39c12' },
]);
const showTagSelector = ref(false);
const selectedHistoryItem = ref<number | null>(null);
const newTagName = ref('');
const selectedTags = ref<string[]>([]);
const editingChatTitle = ref(''); // Ê∑ªÂä†‰ºöËØùÊ†áÈ¢òÁºñËæëÂèòÈáè

// ÂØºÂá∫ÂäüËÉΩÁõ∏ÂÖ≥Áä∂ÊÄÅ
const exportFormats = [
  { id: 'pdf', name: 'PDF Êñá‰ª∂' },
  { id: 'markdown', name: 'Markdown Êñá‰ª∂' },
  { id: 'txt', name: 'ÊñáÊú¨Êñá‰ª∂' },
];
const showExportMenu = ref(false);

// ÁúüÂÆûÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆ
const chatHistory = ref<HistoryItem[]>([]);

// Toast Ê∂àÊÅØÁä∂ÊÄÅ
const toast = ref({
  show: false,
  message: ''
});

// ÂäüËÉΩÁâπÁÇπÂ±ïÁ§∫
const features = [
  {
    icon: 'üîç',
    title: 'Áü•ËØÜÂ∫ìÊ£ÄÁ¥¢',
    description: 'Á≤æÂáÜÊ£ÄÁ¥¢‰ºÅ‰∏öÁü•ËØÜÂ∫ìÔºåÂõûÁ≠î‰∏ì‰∏öÈóÆÈ¢ò'
  },
  {
    icon: 'üí¨',
    title: 'Â§öËΩÆÂØπËØù',
    description: 'ÊîØÊåÅ‰∏ä‰∏ãÊñáÁêÜËß£‰∏éÁä∂ÊÄÅ‰øùÊåÅ'
  },
  {
    icon: 'üìÑ',
    title: 'ÊñáÊ°£Â§ÑÁêÜ',
    description: 'Ëá™Âä®Ëß£ÊûêÂ§öÁßçÊ†ºÂºèÊñáÊ°£Âπ∂ÂêëÈáèÂåñ'
  },
  {
    icon: '‚ö°',
    title: 'ÊµÅÂºèÂìçÂ∫î',
    description: 'ÂÆûÊó∂ÊâìÂ≠óÊïàÊûúÔºåÊèêÂçáÁî®Êà∑‰ΩìÈ™å'
  }
];

// ÊòæÁ§∫ Toast Ê∂àÊÅØ
const showToast = (message: string) => {
  toast.value.message = message;
  toast.value.show = true;
  
  // 3ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
  setTimeout(() => {
    toast.value.show = false;
  }, 3000);
};

// Ëá™Âä®Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
const adjustTextareaHeight = () => {
  if (!inputRef.value) return;
  
  // ÈáçÁΩÆÈ´òÂ∫¶‰ª•‰æøÈáçÊñ∞ËÆ°ÁÆó
  inputRef.value.style.height = 'auto';
  
  // ËÆ°ÁÆóÊñ∞ÁöÑÈ´òÂ∫¶ÔºàÊúÄÂ§ßÈ´òÂ∫¶‰∏∫150pxÔºâ
  const newHeight = Math.min(150, inputRef.value.scrollHeight);
  
  // ËÆæÁΩÆÊñ∞È´òÂ∫¶
  inputRef.value.style.height = `${newHeight}px`;
};

// ÁõëÂê¨ËæìÂÖ•ÂÜÖÂÆπÂèòÂåñÔºåËá™Âä®Ë∞ÉÊï¥È´òÂ∫¶
watch(userInput, () => {
  nextTick(adjustTextareaHeight);
});

// ÁõëÂê¨ÊµÅÂºèËæìÂá∫Áä∂ÊÄÅÂèòÂåñ
watch(isDeepThinking, (newValue) => {
  // ‰∏çÈúÄË¶ÅÂºπÁ™óÊèêÁ§∫
});

// ÂàáÊç¢‰æßËæπÊ†è
const toggleSidebar = () => {
  sidebarCollapsed.value = !sidebarCollapsed.value;
  // Êú¨Âú∞Â≠òÂÇ®Áî®Êà∑ÂÅèÂ•Ω
  localStorage.setItem('sidebarCollapsed', String(sidebarCollapsed.value));
};

// Âà†Èô§ÂéÜÂè≤ËÆ∞ÂΩï
const deleteHistory = async (index: number) => {
  try {
    const selectedChatId = chatHistory.value[index].id;
    
    // ÂêëÂêéÁ´ØÂèëÈÄÅÂà†Èô§ËØ∑Ê±Ç
    const response = await fetch(`${API_BASE_URL}/ai/chat/deleteChatHistoryList`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        chatId: selectedChatId.toString()
      })
    });
    
    const result = await response.json();
    
    // Âè™ÊúâËØ∑Ê±ÇÊàêÂäüÊó∂Êâç‰ªéÊú¨Âú∞Âà†Èô§
    if (result.code === "200") {
      // ‰ªéÊú¨Âú∞Âà†Èô§
      chatHistory.value.splice(index, 1);
      
      // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®ÊòæÁ§∫Ë¢´Âà†Èô§ÁöÑÂØπËØùÔºåÂàôÊ∏ÖÁ©∫Ê∂àÊÅØ
      if (messages.value.length > 0) {
        messages.value = [];
      }
      
      showToast('Â∑≤Âà†Èô§ËØ•ÂØπËØù');
    } else {
      // ËØ∑Ê±ÇÂ§±Ë¥•
      showToast('Âà†Èô§Â§±Ë¥•: ' + (result.userMessage || result.message || 'ËØ∑Ê±ÇÈîôËØØ'));
      console.warn('Âà†Èô§‰ºöËØùËØ∑Ê±ÇÂ§±Ë¥•:', result);
    }
  } catch (error) {
    console.error('Âà†Èô§‰ºöËØùËØ∑Ê±ÇÈîôËØØ:', error);
    showToast('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
  }
};

// ÂºÄÂßãÊñ∞ÂØπËØù
const startNewChat = async () => {
  // Á´ãÂç≥Ê∏ÖÁ©∫ÂΩìÂâçÊ∂àÊÅØÔºåÊèê‰æõËâØÂ•ΩÁöÑÁî®Êà∑‰ΩìÈ™å
  messages.value = [];
  
  // ÁîüÊàêchatId
  const newChatId = Date.now().toString();
  console.log('ÁîüÊàêÊñ∞‰ºöËØùchatId:', newChatId);
  
  // ÁîüÊàêÂΩìÂâçÊó∂Èó¥
  const currentDate = new Date();
  
  // ÂàõÂª∫Êñ∞‰ºöËØùÁöÑÊï∞ÊçÆ
  const newChatData = {
    chatId: newChatId,
    chatTittle: "Êñ∞Âª∫‰ºöËØù", // ÈªòËÆ§Ê†áÈ¢òÔºå‰ΩøÁî®chatTittleËÄå‰∏çÊòØtitle
    chatTag: [], // ÈªòËÆ§Êó†Ê†áÁ≠æ
    createTime: formatDateToFriendly(currentDate),
    updateTime: formatDateToFriendly(currentDate)
  };
  
  // ÂÖàÂú®Êú¨Âú∞Ê∑ªÂä†‰∏Ä‰∏™‰∏¥Êó∂ËÆ∞ÂΩïÔºåÊèê‰æõÂç≥Êó∂ÂèçÈ¶à
  const tempHistoryItem: HistoryItem = {
    id: parseInt(newChatId),
    title: newChatData.chatTittle, // ‰ΩøÁî®chatTittle
    time: newChatData.updateTime,
    tags: []
  };
  
  chatHistory.value = [tempHistoryItem, ...chatHistory.value];
  selectedHistoryItem.value = 0; // ÈÄâ‰∏≠Êñ∞ÂàõÂª∫ÁöÑ‰ºöËØù
  
  // ÊòæÁ§∫Êñ∞Âª∫ÊàêÂäüÊèêÁ§∫
  showToast('Â∑≤ÂàõÂª∫Êñ∞ÂØπËØù');
  
  // Âú®ÂêéÂè∞ÂèëÈÄÅËØ∑Ê±ÇÂàõÂª∫‰ºöËØù
  try {
    const response = await fetch(`${API_BASE_URL}/ai/chat/insertChatHistoryList`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(newChatData)
    });
    
    const result = await response.json();
    
    if (result.code === "200" && result.data) {
      console.log('Êñ∞Âª∫‰ºöËØùÊàêÂäüÔºåchatId:', newChatId);
      // ‰∏çË¶ÅË∞ÉÁî®fetchAllChatHistoryÔºåËøôÂèØËÉΩÂØºËá¥chatIdÂèòÂåñ
      // fetchAllChatHistory();
    } else {
      console.warn('Êñ∞Âª∫‰ºöËØùËØ∑Ê±ÇÂ§±Ë¥•Ôºå‰ΩÜÁî®Êà∑ÁïåÈù¢Â∑≤Êõ¥Êñ∞:', result.message);
    }
  } catch (error) {
    console.error('Êñ∞Âª∫‰ºöËØùËØ∑Ê±ÇÈîôËØØ:', error);
    // Âç≥‰ΩøËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁî®Êà∑‰ªçÁÑ∂ÂèØ‰ª•ÁªßÁª≠‰ΩøÁî®Êñ∞‰ºöËØùÔºåÂè™ÊòØÊú™‰øùÂ≠òÂà∞ÊúçÂä°Âô®
  }
};

// Â∞ÜÊó•ÊúüËΩ¨Êç¢‰∏∫ÂèãÂ•ΩÊ†ºÂºèÔºà‰ªäÂ§©„ÄÅÊò®Â§©„ÄÅxÂ§©ÂâçÔºâ
const formatDateToFriendly = (date: Date): string => {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const dateDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  
  // ËÆ°ÁÆóÂ§©Êï∞Â∑ÆÂºÇ
  const diffInDays = Math.floor((today.getTime() - dateDay.getTime()) / (1000 * 60 * 60 * 24));
  
  if (diffInDays === 0) {
    return '‰ªäÂ§©';
  } else if (diffInDays === 1) {
    return 'Êò®Â§©';
  } else if (diffInDays < 7) {
    return `${diffInDays}Â§©Ââç`;
  } else {
    // Ë∂ÖËøá7Â§©ÂàôËøîÂõûÂÖ∑‰ΩìÊó•ÊúüÔºåÊ†ºÂºèÔºöYYYY-MM-DD
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  }
};

// Â∞ÜÂèãÂ•ΩÊ†ºÂºèÁöÑÊó•ÊúüËΩ¨ÂõûÂÆûÈôÖÊó•ÊúüÂ≠óÁ¨¶‰∏≤ÔºàÁî®‰∫éÂèëÈÄÅÂà∞ÊúçÂä°Âô®Ôºâ
const friendlyToActualDate = (friendlyDate: string): string => {
  const now = new Date();
  
  if (friendlyDate === '‰ªäÂ§©') {
    return now.toISOString().split('T')[0];
  } else if (friendlyDate === 'Êò®Â§©') {
    const yesterday = new Date(now);
    yesterday.setDate(now.getDate() - 1);
    return yesterday.toISOString().split('T')[0];
  } else if (friendlyDate.endsWith('Â§©Ââç')) {
    const days = parseInt(friendlyDate.replace('Â§©Ââç', ''), 10);
    const pastDate = new Date(now);
    pastDate.setDate(now.getDate() - days);
    return pastDate.toISOString().split('T')[0];
  }
  
  // Â¶ÇÊûúÊòØÊó•ÊúüÊ†ºÂºèÔºåÁõ¥Êé•ËøîÂõû
  return friendlyDate;
};

// Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥
const getCurrentTime = () => {
  const now = new Date();
  return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
};

// ÂèëÈÄÅÊ∂àÊÅØÂπ∂Ëé∑ÂèñÂõûÂ§ç
const sendMessage = async () => {
  if (!userInput.value.trim()) return;
  
  const userMessage = userInput.value.trim();
  const hasFiles = selectedFiles.value.length > 0;
  userInput.value = '';
  
  // Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
  nextTick(adjustTextareaHeight);
  
  // Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥
  const now = new Date();
  const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  
  // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÈÄâÊã©‰ºöËØù
  if (selectedHistoryItem.value === null) {
    // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©‰ºöËØùÔºåÂÖàÂàõÂª∫‰∏Ä‰∏™Êñ∞‰ºöËØù
    await startNewChat();
  }
  
  // ÊûÑÂª∫Áî®Êà∑Ê∂àÊÅØÂÜÖÂÆπÔºàÂåÖÂê´Êñá‰ª∂‰ø°ÊÅØÔºâ
  let userMessageContent = userMessage;
  if (hasFiles) {
    const fileNames = selectedFiles.value.map(file => file.name).join(', ');
    userMessageContent += `\n\nüìé ‰∏ä‰º†‰∫Ü ${selectedFiles.value.length} ‰∏™Êñá‰ª∂: ${fileNames}`;
  }
  
  // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞Ê∂àÊÅØÂàóË°®
  messages.value.push({
    role: 'user',
    content: userMessageContent,
    time: timeStr
  });
  
  // ËÆæÁΩÆAIÊ≠£Âú®ËæìÂÖ•Áä∂ÊÄÅ
  isTyping.value = true;
  
  // ÊªöÂä®Âà∞Â∫ïÈÉ®
  nextTick(scrollToBottom);
  
  try {
    if (useCloudModel.value) {
      // ‰ΩøÁî®‰∫ëÁ´ØÊ®°Âûã
      await chatWithServer(userMessage);
    } else {
      // ‰ΩøÁî®Êú¨Âú∞Ê®°ÊãüÂõûÂ§ç
      await simulateResponse(userMessage);
    }
  } catch (error) {
    console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
    messages.value.push({
      role: 'bot',
      content: 'Êä±Ê≠âÔºåÂèëÁîü‰∫ÜÈîôËØØÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ',
      time: timeStr
    });
  } finally {
    // Á°Æ‰øù‰∏çÂÜçÊòæÁ§∫ÊâìÂ≠ó‰∏≠Áä∂ÊÄÅ
    isTyping.value = false;
    nextTick(scrollToBottom);
  }
};

// ‰∏éÊúçÂä°Âô®ÈÄö‰ø°
const chatWithServer = async (prompt: string) => {
  try {
    // ÂáÜÂ§áFormData‰ª•ÊîØÊåÅÊñá‰ª∂‰∏ä‰º†
    const formData = new FormData();
    formData.append('prompt', prompt);
    formData.append('isStream', isDeepThinking.value ? 'true' : 'false');
    
    // Ê∑ªÂä†Ê®°Âûã‰ø°ÊÅØ
    if (selectedModel.value) {
      const modelInfo = availableModels.value.find(m => m.id === selectedModel.value);
      if (modelInfo) {
        formData.append('modelProvider', modelInfo.provider);
        formData.append('modelName', modelInfo.name);
      }
    }
    
    // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØçID
    if (activeSystemPrompt.value) {
      formData.append('systemPromptId', activeSystemPrompt.value.id.toString());
    }
    
    // Ê∑ªÂä†‰ºöËØùID
    if (selectedHistoryItem.value !== null) {
      const currentChatId = chatHistory.value[selectedHistoryItem.value].id.toString();
      formData.append('chatId', currentChatId);
      console.log('‰ΩøÁî®‰ºöËØùID:', currentChatId, 'Á±ªÂûã:', typeof chatHistory.value[selectedHistoryItem.value].id);
      
      // Ë∞ÉËØïchatHistory
      console.log('ÂΩìÂâçchatHistory:', JSON.stringify(chatHistory.value));
      console.log('selectedHistoryItemÁ¥¢Âºï:', selectedHistoryItem.value);
    } else {
      console.error('Êú™ÈÄâÊã©‰ºöËØùÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ');
      throw new Error('Êú™ÈÄâÊã©‰ºöËØù');
    }
    
    // Ê∑ªÂä†Êñá‰ª∂Âà∞FormData
    if (selectedFiles.value.length > 0) {
      selectedFiles.value.forEach(file => {
        formData.append('files', file);
      });
      console.log('Ê∑ªÂä†‰∫Ü', selectedFiles.value.length, '‰∏™Êñá‰ª∂Âà∞ËØ∑Ê±Ç‰∏≠');
    }
    
    // ÂàõÂª∫AbortController‰ª•‰æøÈúÄË¶ÅÊó∂ÂèØ‰ª•‰∏≠Ê≠¢ËØ∑Ê±Ç
    if (streamController.value) {
      streamController.value.abort();
    }
    streamController.value = new AbortController();
    
    // Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥
    const now = new Date();
    const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    
    // ÂÖàÊ∑ªÂä†‰∏Ä‰∏™Á©∫ÁöÑÂõûÂ§çÊ∂àÊÅØÔºåÂêéÁª≠‰ºöÊõ¥Êñ∞ÂÆÉ
    const messageIndex = messages.value.length;
    messages.value.push({
      role: 'bot',
      content: '',
      thinking: '',
      time: timeStr
    });
    
    // ÂèëÈÄÅPOSTËØ∑Ê±ÇÂπ∂Â§ÑÁêÜÊµÅÂºèÂìçÂ∫î
    const response = await fetch(`${API_BASE_URL}/ai/chat`, {
      method: 'POST',
      body: formData,
      headers: {
        'Accept': 'text/html, text/plain, */*'
      },
      signal: streamController.value.signal
    });
    
    // Ê£ÄÊü•ÂìçÂ∫îÁä∂ÊÄÅ
    if (!response.ok) {
      // Ê£ÄÊü•ÊòØÂê¶‰∏∫JSONÈîôËØØÂìçÂ∫î
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const errorData = await response.json();
        if (errorData && errorData.code === "999") {
          throw new Error(errorData.userMessage || "ÂΩìÂâçÂäüËÉΩ‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÂÜçËØï");
        }
      }
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    // Áõ¥Êé•‰ªéÊµÅ‰∏≠ËØªÂèñÊï∞ÊçÆ
    try {
      const reader = response.body?.getReader();
      const decoder = new TextDecoder('utf-8');
      let responseText = '';
      
      // Â¶ÇÊûúÊ≤°ÊúâreaderÔºåË°®Á§∫ÊµèËßàÂô®‰∏çÊîØÊåÅÊµÅÂºèÂìçÂ∫î
      if (!reader) {
        const text = await response.text();
        
        // Ê£ÄÊü•ÊòØÂê¶ÊòØJSONÈîôËØØÂìçÂ∫î
        try {
          const errorData = JSON.parse(text);
          if (errorData && errorData.code === "999") {
            throw new Error(errorData.userMessage || "ÂΩìÂâçÂäüËÉΩ‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÂÜçËØï");
          }
        } catch (jsonError) {
          // Ëß£ÊûêJSONÂá∫ÈîôÔºåÊåâÊñáÊú¨Â§ÑÁêÜ
        }
        
        const parsedResponse = parseResponse(text);
        
        // Êõ¥Êñ∞Ê∂àÊÅØÂÜÖÂÆπ
        messages.value[messageIndex].content = parsedResponse.response;
        messages.value[messageIndex].thinking = parsedResponse.thinking;
        
        isTyping.value = false;
        return;
      }
      
      // Â§ÑÁêÜÊµÅÂºèÂìçÂ∫î
      try {
        while (true) {
          const { done, value } = await reader.read();
          
          if (done) {
            break;
          }
          
          // Ëß£Á†ÅÂπ∂Ê∑ªÂä†Âà∞ÂìçÂ∫îÊñáÊú¨
          const chunk = decoder.decode(value, { stream: true });
          responseText += chunk;
          
          console.log('Êî∂Âà∞Êï∞ÊçÆÂùó:', chunk); // Ë∞ÉËØï‰ø°ÊÅØ
          
          // Ê£ÄÊü•ÊòØÂê¶ÊòØJSONÈîôËØØÂìçÂ∫î
          if (responseText.trim().startsWith('{"code":"999"')) {
            try {
              const errorData = JSON.parse(responseText);
              if (errorData && errorData.code === "999") {
                throw new Error(errorData.userMessage || "ÂΩìÂâçÂäüËÉΩ‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÂÜçËØï");
              }
            } catch (jsonError) {
              // Ëß£ÊûêÈîôËØØÔºåÁªßÁª≠Â§ÑÁêÜ
            }
          }
          
          // Ëß£ÊûêÂΩìÂâçÁ¥ØÁßØÁöÑÂìçÂ∫î
          const parsedResponse = parseResponse(responseText);
          
          // Êõ¥Êñ∞Ê∂àÊÅØÂÜÖÂÆπ
          messages.value[messageIndex].content = parsedResponse.response;
          messages.value[messageIndex].thinking = parsedResponse.thinking;
          
          // Â¶ÇÊûúÊúâÂÜÖÂÆπ‰∫ÜÔºå‰∏î‰∏çÊòØÂú®ÊÄùËÄÉ‰∏≠ÔºåÂàôÈöêËóèÊâìÂ≠óÊåáÁ§∫Âô®
          // Â¶ÇÊûúÂè™ÊúâÊÄùËÄÉÂÜÖÂÆπÔºå‰øùÊåÅÊâìÂ≠óÊåáÁ§∫Âô®ÊòæÁ§∫
          const hasThinkingOnly = parsedResponse.thinking && !parsedResponse.response;
          if ((parsedResponse.response && !hasThinkingOnly) || 
              (parsedResponse.thinking && parsedResponse.thinking.includes('</think>'))) {
            isTyping.value = false;
          }
          
          // ÊªöÂä®Âà∞Â∫ïÈÉ®
          scrollToBottom();
        }
      } catch (error) {
        if (error.name === 'AbortError') {
          console.log('ËØ∑Ê±ÇË¢´‰∏≠Ê≠¢');
        } else {
          throw error;
        }
      } finally {
        // Á°Æ‰øùÊúÄÂêéÁöÑËß£Á†Å
        const finalChunk = decoder.decode();
        if (finalChunk) {
          responseText += finalChunk;
          
          const parsedResponse = parseResponse(responseText);
          messages.value[messageIndex].content = parsedResponse.response;
          messages.value[messageIndex].thinking = parsedResponse.thinking;
        }
        
        isTyping.value = false;
      }
    } catch (error) {
      if (error.name !== 'AbortError') {
        console.error('Â§ÑÁêÜÊµÅÂìçÂ∫îÂ§±Ë¥•:', error);
        showToast('ËøûÊé•ÊúçÂä°Âô®Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï');
        
        // Â¶ÇÊûúÂ∑≤ÁªèÊ∑ªÂä†‰∫ÜÊ∂àÊÅØÔºåÂàôÊõ¥Êñ∞‰∏∫ÈîôËØØÊ∂àÊÅØ
        if (messages.value.length > 0 && messages.value[messages.value.length - 1].role === 'bot') {
          messages.value[messages.value.length - 1].content = 'Êä±Ê≠âÔºå‰∏éÊúçÂä°Âô®ÈÄö‰ø°Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ';
        }
      }
      isTyping.value = false;
    }
  } catch (error) {
    if (error.name !== 'AbortError') {
      console.error('‰∏éÊúçÂä°Âô®ÈÄö‰ø°Â§±Ë¥•:', error);
      
      // ÊèêÂèñÈîôËØØÊ∂àÊÅØ
      let errorMessage = 'ËøûÊé•ÊúçÂä°Âô®Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï';
      
      // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Áî®Êà∑ÂèãÂ•ΩÁöÑÈîôËØØÊ∂àÊÅØ
      if (error.message && 
         (error.message.includes('ÂΩìÂâçÂäüËÉΩ‰∏çÂèØÁî®') || 
          error.message.includes('Exception'))) {
        errorMessage = error.message;
      }
      
      // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
      showToast(errorMessage);
      
      // Â¶ÇÊûúÂ∑≤ÁªèÊ∑ªÂä†‰∫ÜÊ∂àÊÅØÔºåÂàôÊõ¥Êñ∞‰∏∫ÈîôËØØÊ∂àÊÅØ
      if (messages.value.length > 0 && messages.value[messages.value.length - 1].role === 'bot') {
        messages.value[messages.value.length - 1].content = `Êä±Ê≠âÔºå${errorMessage}`;
      }
    }
    isTyping.value = false;
  }
};

// Ê®°ÊãüÊú¨Âú∞ÂõûÂ§çÔºàÁé∞ÊúâÂäüËÉΩÔºâ
const simulateResponse = async (input: string) => {
  // Âª∂Ëøü‰ª•Ê®°Êãü API ÂìçÂ∫îÊó∂Èó¥
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  const now = new Date();
  const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  
  let botResponse = '';
  let thinking = '';
  
  // Ê®°ÊãüÂõûÂ§çÈÄªËæë
  if (input.includes('‰Ω†Â•Ω') || input.includes('Âó®') || input.includes('hi') || input.includes('hello')) {
    thinking = 'Áî®Êà∑ÊâìÊãõÂëº‰∫ÜÔºåÊàëÂ∫îËØ•Á§ºË≤åÂú∞ÂõûÂ∫îÂπ∂Ë°®Á§∫ÊÑøÊÑèÊèê‰æõÂ∏ÆÂä©„ÄÇ';
    botResponse = '‰Ω†Â•ΩÔºÅÊàëÊòØÂ∞èÂûãÂçöÁæéÔºåÂæàÈ´òÂÖ¥‰∏∫‰Ω†ÊúçÂä°„ÄÇ‰Ω†Êúâ‰ªÄ‰πàÈúÄË¶ÅÂ∏ÆÂä©ÁöÑÂêóÔºü';
  } else if (input.includes('ÂäüËÉΩ') || input.includes('ËÉΩÂÅö‰ªÄ‰πà')) {
    thinking = 'Áî®Êà∑ÊÉ≥‰∫ÜËß£ÊàëÁöÑÂäüËÉΩÔºåÊàëÂ∫îËØ•ËØ¶ÁªÜÂàóÂá∫ÊàëËÉΩÂÅöÁöÑ‰∫ãÊÉÖ„ÄÇ';
    botResponse = 'ÊàëÂèØ‰ª•Â∏Æ‰Ω†ÂÜô‰ª£Á†Å„ÄÅËØªÊñá‰ª∂„ÄÅÂõûÁ≠îÈóÆÈ¢ò„ÄÅÂÜô‰ΩúÂêÑÁßçÂàõÊÑèÂÜÖÂÆπÔºåËøòÂèØ‰ª•ËøûÊé•Âà∞‰Ω†ÁöÑÁü•ËØÜÂ∫ìÂõûÁ≠î‰∏ì‰∏öÈóÆÈ¢ò„ÄÇËØ∑ÂëäËØâÊàë‰Ω†ÈúÄË¶Å‰ªÄ‰πàÂ∏ÆÂä©Ôºü';
  } else if (input.includes('Áü•ËØÜÂ∫ì')) {
    thinking = 'Áî®Êà∑ËØ¢ÈóÆÁü•ËØÜÂ∫ìÂäüËÉΩÔºåÊàëÂ∫îËØ•Ëß£ÈáäËøô‰∏™ÁâπÊÄßÁöÑÂ∑•‰ΩúÂéüÁêÜÂíå‰ºòÂäø„ÄÇ';
    botResponse = 'Êàë‰ª¨ÁöÑÁü•ËØÜÂ∫ìÂäüËÉΩÂÖÅËÆ∏ÊÇ®‰∏ä‰º†ÂíåÁ¥¢ÂºïÂÖ¨Âè∏ÊñáÊ°£ÔºåÁÑ∂ÂêéAIÂä©ÊâãÂèØ‰ª•Âü∫‰∫éËøô‰∫õÊñáÊ°£ÂõûÁ≠îÈóÆÈ¢ò„ÄÇÊîØÊåÅÂ§öÁßçÊ†ºÂºèÂ¶ÇPDF„ÄÅWordÂíåExcelÔºåÂπ∂‰∏î‰ºöËá™Âä®ÊèêÂèñÂíåÂêëÈáèÂåñÂÜÖÂÆπ‰ª•ÂÆûÁé∞ËØ≠‰πâÊêúÁ¥¢„ÄÇ';
  } else if (input.includes('markdown')) {
    thinking = 'Áî®Êà∑ÊèêÂà∞‰∫ÜMarkdownÔºåÊàëÂ∫îËØ•Â±ïÁ§∫‰∏Ä‰∫õMarkdownÊ†ºÂºèÁöÑÁ§∫‰æã„ÄÇ';
    botResponse = 'ËøôÊòØMarkdownÊ†ºÂºèÁöÑÁ§∫‰æãÔºö\n\n# Ê†áÈ¢ò1\n## Ê†áÈ¢ò2\n### Ê†áÈ¢ò3\n\n- ÂàóË°®È°π1\n- ÂàóË°®È°π2\n\n```javascript\n// ‰ª£Á†ÅÁ§∫‰æã\nfunction hello() {\n  console.log("Hello world!");\n}\n```\n\n**Á≤ó‰ΩìÊñáÊú¨** Âíå *Êñú‰ΩìÊñáÊú¨*';
  } else {
    thinking = 'ËøôÊòØ‰∏Ä‰∏™‰∏ÄËà¨ÊÄßÁöÑÈóÆÈ¢òÔºåÊàëÂ∞ÜÁªôÂá∫ÂèãÂ•ΩÁöÑÂõûÂ∫îÔºåÂπ∂ÂëäÁü•Áî®Êà∑ËøôÊòØÊºîÁ§∫Ê®°Âºè„ÄÇ';
    botResponse = 'ÊÑüË∞¢‰Ω†ÁöÑÊèêÈóÆ„ÄÇÂú®ÁúüÂÆûÁéØÂ¢É‰∏≠ÔºåÊàë‰ºöÊ†πÊçÆ‰Ω†ÁöÑÈóÆÈ¢òÁªôÂá∫ËØ¶ÁªÜÁöÑÂõûÁ≠î„ÄÇÁé∞Âú®Á≥ªÁªüÂ§Ñ‰∫éÊºîÁ§∫Ê®°ÂºèÔºåÂ¶ÇÈúÄÊõ¥Â§öÂ∏ÆÂä©ÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëòÂºÄÈÄöÂÆåÊï¥ÂäüËÉΩ„ÄÇ';
  }
  
  // Ê∑ªÂä†AIÂõûÂ§ç
  messages.value.push({
    role: 'bot',
    content: botResponse,
    thinking: thinking,
    time: timeStr
  });
  
  // Â¶ÇÊûúÊòØÊñ∞ÂØπËØùÔºåÂèØËÉΩÈúÄË¶ÅÂàõÂª∫‰ºöËØù
  if (selectedHistoryItem.value === null && messages.value.length === 2) {
    // Á¨¨‰∏ÄÊ¨°ÂØπËØùÊó∂ÂàõÂª∫Êñ∞‰ºöËØù
    const title = input.length > 20 ? input.substring(0, 20) + '...' : input;
    
    // Êõ¥Êñ∞‰æßËæπÊ†èÊòæÁ§∫
    const tempItem: HistoryItem = {
      id: Date.now(),
      title: title,
      time: 'ÂàöÂàö',
      tags: []
    };
    
    chatHistory.value = [tempItem, ...chatHistory.value];
    selectedHistoryItem.value = 0;
  }
};

// Áî®Êà∑ÊéßÂà∂ÊªöÂä®ÁöÑÊ†áÂøó
const userScrolling = ref(false);
const lastScrollTop = ref(0);

// ÊªöÂä®Âà∞Â∫ïÈÉ®
const scrollToBottom = () => {
  // Â¶ÇÊûúÁî®Êà∑Ê≠£Âú®ÊâãÂä®ÊªöÂä®ÔºåÂàô‰∏çÊâßË°åËá™Âä®ÊªöÂä®
  if (userScrolling.value) return;
  
  if (chatContentRef.value) {
    chatContentRef.value.scrollTop = chatContentRef.value.scrollHeight;
  }
};

// Ê£ÄÊµãÁî®Êà∑ÊªöÂä®Ë°å‰∏∫
const handleScroll = () => {
  if (!chatContentRef.value) return;
  
  // Ëé∑ÂèñÂΩìÂâçÊªöÂä®‰ΩçÁΩÆ
  const currentScrollTop = chatContentRef.value.scrollTop;
  const maxScrollTop = chatContentRef.value.scrollHeight - chatContentRef.value.clientHeight;
  
  // Â¶ÇÊûúÁî®Êà∑Âêë‰∏äÊªöÂä®ÊàñË∑ùÁ¶ªÂ∫ïÈÉ®Ë∂ÖËøá100pxÔºåÊ†áËÆ∞‰∏∫Áî®Êà∑ÊªöÂä®
  if (currentScrollTop < lastScrollTop.value || (maxScrollTop - currentScrollTop) > 100) {
    userScrolling.value = true;
  }
  
  // Â¶ÇÊûúÁî®Êà∑ÊªöÂä®Âà∞Êé•ËøëÂ∫ïÈÉ®ÔºåÊÅ¢Â§çËá™Âä®ÊªöÂä®
  if ((maxScrollTop - currentScrollTop) < 30) {
    userScrolling.value = false;
  }
  
  // Êõ¥Êñ∞ÊúÄÂêéÊªöÂä®‰ΩçÁΩÆ
  lastScrollTop.value = currentScrollTop;
};

// ÁõëÂê¨Ê∂àÊÅØÂèòÂåñÔºåËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
watch(messages, () => {
  nextTick(() => {
    scrollToBottom();
  });
});

// ËøîÂõûÈ¶ñÈ°µ
const goToHome = () => {
  // ‰ΩøÁî®Vue RouterÂØºËà™Âà∞È¶ñÈ°µ
  window.location.href = '/ai';
  // ‰πüÂèØ‰ª•‰ΩøÁî®router.push('/ai') Â¶ÇÊûúÊúâÂºïÂÖ•router
};

// Ëé∑ÂèñÊ†áÁ≠æÈ¢úËâ≤
const getTagColor = (tagName: string) => {
  const tag = availableTags.value.find(t => t.name === tagName);
  return tag ? tag.color : '#999';
};

// Êõ¥Êñ∞‰ºöËØù
const updateChatHistory = async (chatId: number, updates: any) => {
  try {
    // ÊûÑÂª∫Êõ¥Êñ∞ËØ∑Ê±ÇÊï∞ÊçÆ
    const updateData = {
      chatId: chatId.toString(),
      ...updates
    };
    
    // ÂèëÈÄÅÊõ¥Êñ∞ËØ∑Ê±Ç
    const response = await fetch(`${API_BASE_URL}/ai/chat/updateChatHistoryList`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updateData)
    });
    
    const result = await response.json();
    
    if (result.code === "200") {
      // Êõ¥Êñ∞ÊàêÂäü
      showToast('‰ºöËØùÂ∑≤Êõ¥Êñ∞');
      // Âà∑Êñ∞‰ºöËØùÂàóË°®
      fetchAllChatHistory();
      return true;
    } else {
      // ËØ∑Ê±ÇÂ§±Ë¥•
      showToast('Êõ¥Êñ∞Â§±Ë¥•: ' + (result.userMessage || result.message || 'ËØ∑Ê±ÇÈîôËØØ'));
      console.warn('Êõ¥Êñ∞‰ºöËØùÂ§±Ë¥•:', result);
      return false;
    }
  } catch (error) {
    console.error('Êõ¥Êñ∞‰ºöËØùËØ∑Ê±ÇÈîôËØØ:', error);
    showToast('Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
    return false;
  }
};

// ‰øùÂ≠òÊ†áÁ≠æÂà∞‰ºöËØù
const saveTagsToChat = async () => {
  if (selectedHistoryItem.value === null) return;
  
  const chatId = chatHistory.value[selectedHistoryItem.value].id;
  const tags = selectedTags.value;
  const title = editingChatTitle.value.trim();
  
  // Ê£ÄÊü•Ê†áÈ¢òÊòØÂê¶‰∏∫Á©∫
  if (!title) {
    showToast('‰ºöËØùÊ†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫');
    return;
  }
  
  // ÂáÜÂ§áÊõ¥Êñ∞Êï∞ÊçÆ
  const updateData = {
    chatTittle: title,
    chatTag: tags,
    updateTime: formatDateToFriendly(new Date())
  };
  
  // ÊòæÁ§∫Êõ¥Êñ∞‰∏≠ÊèêÁ§∫
  showToast('Ê≠£Âú®Êõ¥Êñ∞‰ºöËØù...');
  
  // Ë∞ÉÁî®ÈÄöÁî®Êõ¥Êñ∞ÂáΩÊï∞
  const success = await updateChatHistory(chatId, updateData);
  
  if (success) {
    // ÂÖ≥Èó≠ÈÄâÊã©Âô®
    showTagSelector.value = false;
  }
};

// ÊâìÂºÄÊ†áÁ≠æÈÄâÊã©Âô®
const openTagSelector = (index: number) => {
  selectedHistoryItem.value = index;
  
  // ÂàùÂßãÂåñÂ∑≤ÈÄâÊ†áÁ≠æ
  if (chatHistory.value[index].tags) {
    selectedTags.value = [...chatHistory.value[index].tags];
  } else {
    selectedTags.value = [];
  }
  
  // ÂàùÂßãÂåñ‰ºöËØùÊ†áÈ¢ò
  editingChatTitle.value = chatHistory.value[index].title;
  
  showTagSelector.value = true;
};

// Ê£ÄÊü•Ê†áÁ≠æÊòØÂê¶Â∑≤Ë¢´ÈÄâ‰∏≠
const isTagSelected = (tagName: string) => {
  return selectedTags.value.includes(tagName);
};

// ÂàáÊç¢Ê†áÁ≠æÈÄâÊã©Áä∂ÊÄÅ
const toggleTag = (tagName: string) => {
  if (isTagSelected(tagName)) {
    selectedTags.value = selectedTags.value.filter(t => t !== tagName);
  } else {
    selectedTags.value.push(tagName);
  }
};

// Ê∑ªÂä†Ëá™ÂÆö‰πâÊ†áÁ≠æ
const addCustomTag = () => {
  if (!newTagName.value.trim()) return;
  
  // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçÊ†áÁ≠æ
  if (!availableTags.value.some(t => t.name === newTagName.value)) {
    // ÈöèÊú∫ÁîüÊàêÊ†áÁ≠æÈ¢úËâ≤
    const colors = ['#FF6B95', '#4665ee', '#42b983', '#f39c12', '#e74c3c', '#9b59b6', '#3498db'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    // Ê∑ªÂä†Âà∞ÂèØÁî®Ê†áÁ≠æÂàóË°®
    availableTags.value.push({
      id: availableTags.value.length + 1,
      name: newTagName.value,
      color: randomColor
    });
  }
  
  // Â¶ÇÊûúÊ≤°ÊúâË¢´ÈÄâ‰∏≠ÔºåÂàôÈÄâ‰∏≠ËØ•Ê†áÁ≠æ
  if (!isTagSelected(newTagName.value)) {
    selectedTags.value.push(newTagName.value);
  }
  
  // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
  newTagName.value = '';
};

// ÊâìÂºÄÂØºÂá∫ËèúÂçï
const openExportMenu = (index: number) => {
  selectedHistoryItem.value = index;
  showExportMenu.value = true;
};

// ÂØºÂá∫ÂØπËØù
const exportConversation = (format: string) => {
  if (selectedHistoryItem.value === null) return;
  
  // ËøôÈáåÊòØÊ®°ÊãüÂØºÂá∫ÂäüËÉΩÔºåÂÆûÈôÖÂ∫îÁî®‰∏≠ÈúÄË¶ÅÂÆûÁé∞ÁúüÊ≠£ÁöÑÂØºÂá∫ÈÄªËæë
  const item = chatHistory.value[selectedHistoryItem.value];
  
  // ËÆ∞ÂΩïÂØºÂá∫Ê†ºÂºè
  if (!item.exportedFormats) {
    item.exportedFormats = [];
  }
  if (!item.exportedFormats.includes(format)) {
    item.exportedFormats.push(format);
  }
  
  // ÊòæÁ§∫ÂØºÂá∫ÊàêÂäüÊèêÁ§∫
  showToast(`ÂØπËØùÂ∑≤ÂØºÂá∫‰∏∫${format.toUpperCase()}Ê†ºÂºè`);
  showExportMenu.value = false;
  
  // ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÂ∫îËØ•ÁîüÊàêÂπ∂‰∏ãËΩΩÂØπÂ∫îÊ†ºÂºèÁöÑÊñá‰ª∂
  // ‰æãÂ¶Ç‰ΩøÁî® html2pdf Â∫ìÁîüÊàê PDFÔºåÊàñËÄÖÁîüÊàê markdown ÊñáÊú¨Âπ∂‰∏ãËΩΩ
};

// Âä†ËΩΩÂØπËØù
const loadConversation = async (index: number) => {
  try {
    const chatId = chatHistory.value[index].id;
    selectedHistoryItem.value = index;
    
    // Ê∏ÖÁ©∫ÂΩìÂâçÊ∂àÊÅØ
    messages.value = [];
    
    // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
    showToast(`Ê≠£Âú®Âä†ËΩΩÂØπËØù: ${chatHistory.value[index].title}`);
    
    // ÂèëÈÄÅËØ∑Ê±ÇËé∑ÂèñËÅäÂ§©ËÆ∞ÂΩï
    const response = await fetch(`${API_BASE_URL}/ai/chat/getChatHistoryById?chatId=${chatId}`);
    const result = await response.json();
    
    if (Array.isArray(result)) {
      // Â∞ÜÊé•Âè£ËøîÂõûÁöÑÊï∞ÊçÆËΩ¨Êç¢‰∏∫Ê∂àÊÅØÊ†ºÂºè
      result.forEach(item => {
        const now = new Date();
        const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        
        // Ëß£ÊûêassistantÊ∂àÊÅØ‰∏≠ÁöÑÊÄùËÄÉÂÜÖÂÆπ
        let thinking = '';
        let content = item.chatContent;
        
        if (item.chatRole === 'assistant') {
          const parsedResponse = parseResponse(item.chatContent);
          content = parsedResponse.response;
          thinking = parsedResponse.thinking;
        }
        
        messages.value.push({
          role: item.chatRole === 'user' ? 'user' : 'bot',
          content: content,
          thinking: thinking,
          time: timeStr
        });
      });
      
      // ÊªöÂä®Âà∞Â∫ïÈÉ®
      nextTick(scrollToBottom);
    } else {
      showToast('Êó†Ê≥ïÂä†ËΩΩÂØπËØùËÆ∞ÂΩï');
      console.error('Ëé∑ÂèñËÅäÂ§©ËÆ∞ÂΩïËøîÂõûÊ†ºÂºèÈîôËØØ:', result);
    }
  } catch (error) {
    console.error('Âä†ËΩΩÂØπËØùËÆ∞ÂΩïÂ§±Ë¥•:', error);
    showToast('Âä†ËΩΩÂØπËØùËÆ∞ÂΩïÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï');
  }
};

// ÈôêÂà∂Ê†áÁ≠æÊòæÁ§∫Êï∞ÈáèÔºåÈÅøÂÖçÊç¢Ë°å
const limitTags = (tags: string[]) => {
  // ÊúÄÂ§öÊòæÁ§∫4‰∏™Ê†áÁ≠æÔºåÁ°Æ‰øùÂú®Âêå‰∏ÄË°åÂÜÖÂ±ïÁ§∫
  return tags.slice(0, 4);
};

// ÊâìÂºÄÊñá‰ª∂ÁÆ°ÁêÜÂô®
const openFileManager = () => {
  showFileManager.value = true;
};

// ËøáÊª§Êñá‰ª∂
const filteredFiles = computed(() => {
  let result = userFiles.value;
  
  // Â∫îÁî®ËøáÊª§Âô®
  if (currentFilter.value === 'accessible') {
    result = result.filter(file => file.aiAccessible);
  } else if (currentFilter.value === 'restricted') {
    result = result.filter(file => !file.aiAccessible);
  }
  
  // Â∫îÁî®ÊêúÁ¥¢
  if (fileSearchQuery.value) {
    const query = fileSearchQuery.value.toLowerCase();
    result = result.filter(file => 
      file.name.toLowerCase().includes(query) ||
      (file.description && file.description.toLowerCase().includes(query))
    );
  }
  
  return result;
});

// Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
const formatFileSize = (size: number) => {
  if (size < 1024) {
    return `${size} B`;
  } else if (size < 1024 * 1024) {
    return `${(size / 1024).toFixed(1)} KB`;
  } else {
    return `${(size / (1024 * 1024)).toFixed(1)} MB`;
  }
};

// ÈÄâÊã©Êñá‰ª∂
const selectFile = (id: number) => {
  selectedFile.value = id;
};

// ÂàáÊç¢Êñá‰ª∂AIËÆøÈóÆÊùÉÈôê
const toggleAccess = (id: number) => {
  const fileIndex = userFiles.value.findIndex(file => file.id === id);
  if (fileIndex !== -1) {
    userFiles.value[fileIndex].aiAccessible = !userFiles.value[fileIndex].aiAccessible;
    showToast(`${userFiles.value[fileIndex].name} ${userFiles.value[fileIndex].aiAccessible ? 'Áé∞Âú®ÂèØË¢´AIËÆøÈóÆ' : 'Áé∞Âú®ÂØπAIÂèóÈôê'}`);
  }
};

// Âà†Èô§Êñá‰ª∂
const deleteFile = (id: number) => {
  const fileIndex = userFiles.value.findIndex(file => file.id === id);
  if (fileIndex !== -1) {
    const fileName = userFiles.value[fileIndex].name;
    userFiles.value = userFiles.value.filter(file => file.id !== id);
    showToast(`Êñá‰ª∂ ${fileName} Â∑≤Âà†Èô§`);
    
    if (selectedFile.value === id) {
      selectedFile.value = null;
    }
  }
};

// ÊâìÂºÄ‰∏ä‰º†Êñá‰ª∂Ê®°ÊÄÅÊ°Ü
const openUploadModal = () => {
  // ÈáçÁΩÆÊñ∞Êñá‰ª∂Ë°®Âçï
  newFile.value = {
    id: Date.now(),
    name: '',
    type: '',
    size: 0,
    uploadTime: '',
    aiAccessible: true,
    description: ''
  };
  showFileUploadModal.value = true;
};

// Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©
const triggerFileUpload = () => {
  if (fileInputRef.value) {
    fileInputRef.value.click();
  }
};

// Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
const handleFileSelect = (event: Event) => {
  const target = event.target as HTMLInputElement;
  if (target.files && target.files.length > 0) {
    const files = Array.from(target.files);
    
    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂Âçï‰∏™Êñá‰ª∂ÊúÄÂ§ß10MBÔºâ
    const maxFileSize = 10 * 1024 * 1024; // 10MB
    const validFiles = files.filter(file => {
      if (file.size > maxFileSize) {
        showToast(`Êñá‰ª∂ ${file.name} Ë∂ÖËøá10MBÈôêÂà∂ÔºåÂ∑≤Ë∑≥Ëøá`);
        return false;
      }
      return true;
    });
    
    if (validFiles.length > 0) {
      selectedFiles.value.push(...validFiles);
      showToast(`Â∑≤ÈÄâÊã© ${validFiles.length} ‰∏™Êñá‰ª∂`);
    }
    
    // Ê∏ÖÁ©∫inputÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Âêå‰∏ÄÊñá‰ª∂
    target.value = '';
  }
};

// Â§ÑÁêÜÊñá‰ª∂ÊãñÊãΩ
const handleFileDrop = (event: DragEvent) => {
  event.preventDefault();
  isDragging.value = false;
  
  if (event.dataTransfer && event.dataTransfer.files.length > 0) {
    const files = Array.from(event.dataTransfer.files);
    
    // ËøáÊª§ÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûãÂíåÂ§ßÂ∞è
    const maxFileSize = 10 * 1024 * 1024; // 10MB
    const validFiles = files.filter(file => {
      const extension = file.name.toLowerCase().split('.').pop();
      const isSupported = ['pdf', 'doc', 'docx', 'txt', 'xlsx', 'xls', 'jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension || '');
      
      if (!isSupported) {
        return false;
      }
      
      if (file.size > maxFileSize) {
        showToast(`Êñá‰ª∂ ${file.name} Ë∂ÖËøá10MBÈôêÂà∂ÔºåÂ∑≤Ë∑≥Ëøá`);
        return false;
      }
      
      return true;
    });
    
    if (validFiles.length > 0) {
      selectedFiles.value.push(...validFiles);
      showToast(`Â∑≤Ê∑ªÂä† ${validFiles.length} ‰∏™Êñá‰ª∂`);
    }
    
    if (files.length > validFiles.length) {
      showToast('ÈÉ®ÂàÜÊñá‰ª∂Ê†ºÂºè‰∏çÊîØÊåÅÊàñÊñá‰ª∂ËøáÂ§ßÔºåÂ∑≤Ë∑≥Ëøá');
    }
  }
};

// ÁßªÈô§ÈÄâ‰∏≠ÁöÑÊñá‰ª∂
const removeSelectedFile = (index: number) => {
  selectedFiles.value.splice(index, 1);
  showToast('Â∑≤ÁßªÈô§Êñá‰ª∂');
};

// ‰∏ä‰º†Êñá‰ª∂ÔºàÊ®°ÊãüÔºâ
const uploadFile = () => {
  if (!newFile.value.name) {
    showToast('ËØ∑ËæìÂÖ•Êñá‰ª∂ÂêçÁß∞');
    return;
  }
  
  // Á°ÆÂÆöÊñá‰ª∂Á±ªÂûãÔºàÊ®°ÊãüÔºâ
  if (newFile.value.name.endsWith('.pdf')) {
    newFile.value.type = 'pdf';
  } else if (newFile.value.name.endsWith('.docx') || newFile.value.name.endsWith('.doc')) {
    newFile.value.type = 'docx';
  } else if (newFile.value.name.endsWith('.xlsx') || newFile.value.name.endsWith('.xls')) {
    newFile.value.type = 'xlsx';
  } else {
    // Â¶ÇÊûúÊ≤°ÊúâÊâ©Â±ïÂêçÔºåÊ∑ªÂä†ÈªòËÆ§Êâ©Â±ïÂêç
    if (!newFile.value.name.includes('.')) {
      newFile.value.name += '.pdf';
      newFile.value.type = 'pdf';
    } else {
      newFile.value.type = 'other';
    }
  }
  
  // Ê®°ÊãüÈöèÊú∫Êñá‰ª∂Â§ßÂ∞è (100KB - 5MB)
  newFile.value.size = Math.floor(Math.random() * 5 * 1024 * 1024) + 100 * 1024;
  
  // Ê∑ªÂä†Âà∞Êñá‰ª∂ÂàóË°®
  userFiles.value.push({...newFile.value});
  
  showToast(`Êñá‰ª∂ ${newFile.value.name} ‰∏ä‰º†ÊàêÂäü`);
  showFileUploadModal.value = false;
};

onMounted(() => {
  // Ëá™Âä®ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
  if (inputRef.value) {
    inputRef.value.focus();
  }
  
  // ÊÅ¢Â§ç‰æßËæπÊ†èÁä∂ÊÄÅ
  const savedState = localStorage.getItem('sidebarCollapsed');
  if (savedState) {
    sidebarCollapsed.value = savedState === 'true';
  }
  
  // Âä†ËΩΩ‰øùÂ≠òÁöÑ‰∏ªÈ¢òËÆæÁΩÆ
  loadSavedThemeSettings();
  
  // ÁõëÂê¨ÂÖ®Â±ÄÁÇπÂáª‰∫ã‰ª∂
  document.body.addEventListener('click', () => {
    showPreview.value = false;
  });
  
  // ÂàùÂßãÂåñËæìÂÖ•Ê°ÜÈ´òÂ∫¶
  nextTick(adjustTextareaHeight);
  
  // Ê∑ªÂä†ËæìÂÖ•‰∫ã‰ª∂ÁõëÂê¨ÔºåÂÆûÊó∂Ë∞ÉÊï¥È´òÂ∫¶
  if (inputRef.value) {
    inputRef.value.addEventListener('input', adjustTextareaHeight);
  }
  // Ëé∑ÂèñÊâÄÊúâËÅäÂ§©ÂéÜÂè≤
  fetchAllChatHistory();
  
  // Ëé∑ÂèñÊâÄÊúâÂèØÁî®Ê®°Âûã
  fetchAllModels();
  
  // Ëé∑ÂèñÊâÄÊúâÊèêÁ§∫ËØç
  fetchAllPrompts();
});

// ÊâìÂºÄ‰∏ªÈ¢òËÆæÁΩÆ
const openThemeSettings = () => {
  showThemeSettings.value = true;
};

// ËÆæÁΩÆ‰∏ªÈ¢ò
const setTheme = (themeId: string) => {
  currentTheme.value = themeId;
};

// ËÆæÁΩÆÊòéÊöóÊ®°Âºè
const setDarkMode = (isDark: boolean) => {
  isDarkMode.value = isDark;
};

// ËÆæÁΩÆÂ≠ó‰ΩìÂ§ßÂ∞è
const setFontSize = (size: 'small' | 'medium' | 'large') => {
  currentFontSettings.value.size = size;
};

// ËÆæÁΩÆÂ≠ó‰ΩìÈó¥Ë∑ù
const setFontSpacing = (spacing: 'compact' | 'normal' | 'relaxed') => {
  currentFontSettings.value.spacing = spacing;
};

// ËÆæÁΩÆÂ≠ó‰ΩìÈ£éÊ†º
const setFontFamily = (family: 'default' | 'serif' | 'mono') => {
  currentFontSettings.value.family = family;
};

// ÈáçÁΩÆ‰∏ªÈ¢òËÆæÁΩÆ
const resetThemeSettings = () => {
  currentTheme.value = 'default';
  isDarkMode.value = false;
  currentFontSettings.value = {
    size: 'medium',
    spacing: 'normal',
    family: 'default'
  };
};

// Â∫îÁî®‰∏ªÈ¢òËÆæÁΩÆ
const applyThemeSettings = () => {
  // ‰øùÂ≠òËÆæÁΩÆÂà∞Êú¨Âú∞Â≠òÂÇ®
  localStorage.setItem('pomeranian_theme', currentTheme.value);
  localStorage.setItem('pomeranian_darkMode', isDarkMode.value.toString());
  localStorage.setItem('pomeranian_fontSettings', JSON.stringify(currentFontSettings.value));
  
  showToast('‰∏™ÊÄßÂåñËÆæÁΩÆÂ∑≤Â∫îÁî®');
  showThemeSettings.value = false;
};

// Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑ‰∏ªÈ¢òËÆæÁΩÆ
const loadSavedThemeSettings = () => {
  const savedTheme = localStorage.getItem('pomeranian_theme');
  const savedDarkMode = localStorage.getItem('pomeranian_darkMode');
  const savedFontSettings = localStorage.getItem('pomeranian_fontSettings');
  
  if (savedTheme) {
    currentTheme.value = savedTheme;
  }
  
  if (savedDarkMode) {
    isDarkMode.value = savedDarkMode === 'true';
  }
  
  if (savedFontSettings) {
    try {
      const parsedSettings = JSON.parse(savedFontSettings);
      currentFontSettings.value = {
        size: parsedSettings.size || 'medium',
        spacing: parsedSettings.spacing || 'normal',
        family: parsedSettings.family || 'default'
      };
    } catch (error) {
      console.error('Failed to parse saved font settings:', error);
    }
  }
};

// È¢ÑÂÆö‰πâÁöÑÊèêÁ§∫ËØçÊ®°Êùø
const promptTemplates = ref<PromptTemplate[]>([]);

// ÊèêÁ§∫ËØçÂ∫ìÁõ∏ÂÖ≥Áä∂ÊÄÅ
const showPromptLibrary = ref(false);
const currentPromptFilter = ref('all');
const promptSearchQuery = ref('');
const showPromptModal = ref(false);
const isEditingPrompt = ref(false);
const showPreview = ref(false);
const previewContent = ref('');
const previewPosition = ref({ top: '50%', left: '50%' });
const promptTagsInput = ref('');
const editingPrompt = ref<PromptTemplate>({
  id: 0,
  name: '',
  description: '',
  content: '',
  category: 'general',
  tags: [],
  usageCount: 0,
  functionToolId: ''
});

// ÂΩìÂâçÊøÄÊ¥ªÁöÑÁ≥ªÁªüÊèêÁ§∫ËØç
const activeSystemPrompt = ref<PromptTemplate | null>(null);
const showActivePromptBadge = ref(true);

// Ê®°ÂûãÈÄâÊã©Âô®Áõ∏ÂÖ≥Áä∂ÊÄÅ
// Ê®°ÂûãÈÄâÊã©Âô®Áõ∏ÂÖ≥Áä∂ÊÄÅ
const showModelSelector = ref(false);
const selectedModel = ref('');
const tempSelectedModel = ref(''); // ‰∏¥Êó∂Â≠òÂÇ®ÈÄâÊã©ÁöÑÊ®°ÂûãÔºåÁ°ÆËÆ§ÂêéÊâçÂ∫îÁî®
const availableModels = ref([]);

// Ê∑ªÂä†Ê®°ÊÄÅËíôÂ±ÇÁöÑÈº†Ê†á‰∫ã‰ª∂Â§ÑÁêÜ
const modalMouseDownTarget = ref(null);

// Â§ÑÁêÜÊ®°ÊÄÅËíôÂ±ÇÁöÑÈº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂
const handleModalOverlayMouseDown = (event) => {
  // ËÆ∞ÂΩïÈº†Ê†áÊåâ‰∏ãÁöÑÁõÆÊ†áÂÖÉÁ¥†
  modalMouseDownTarget.value = event.target;
};

// Â§ÑÁêÜÊ®°ÊÄÅËíôÂ±ÇÁöÑÈº†Ê†áÊùæÂºÄ‰∫ã‰ª∂
const handleModalOverlayMouseUp = (event) => {
  // Âè™ÊúâÂΩìÈº†Ê†áÊåâ‰∏ãÂíåÊùæÂºÄÁöÑÊòØÂêå‰∏Ä‰∏™ÂÖÉÁ¥†Ôºå‰∏îÊòØËíôÂ±ÇÊú¨Ë∫´Êó∂ÔºåÊâçÂÖ≥Èó≠ÂºπÁ™ó
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showTagSelector.value = false;
  }
  // ÈáçÁΩÆÈº†Ê†áÊåâ‰∏ãÁöÑÁõÆÊ†á
  modalMouseDownTarget.value = null;
};

// Â§ÑÁêÜÂØºÂá∫ËèúÂçïÊ®°ÊÄÅËíôÂ±ÇÁöÑÈº†Ê†áÊùæÂºÄ‰∫ã‰ª∂
const handleExportMenuOverlayMouseUp = (event) => {
  // Âè™ÊúâÂΩìÈº†Ê†áÊåâ‰∏ãÂíåÊùæÂºÄÁöÑÊòØÂêå‰∏Ä‰∏™ÂÖÉÁ¥†Ôºå‰∏îÊòØËíôÂ±ÇÊú¨Ë∫´Êó∂ÔºåÊâçÂÖ≥Èó≠ÂºπÁ™ó
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showExportMenu.value = false;
  }
  // ÈáçÁΩÆÈº†Ê†áÊåâ‰∏ãÁöÑÁõÆÊ†á
  modalMouseDownTarget.value = null;
};

// Â§ÑÁêÜÊñá‰ª∂ÁÆ°ÁêÜÂô®Ê®°ÊÄÅËíôÂ±ÇÁöÑÈº†Ê†áÊùæÂºÄ‰∫ã‰ª∂
const handleFileManagerOverlayMouseUp = (event) => {
  // Âè™ÊúâÂΩìÈº†Ê†áÊåâ‰∏ãÂíåÊùæÂºÄÁöÑÊòØÂêå‰∏Ä‰∏™ÂÖÉÁ¥†Ôºå‰∏îÊòØËíôÂ±ÇÊú¨Ë∫´Êó∂ÔºåÊâçÂÖ≥Èó≠ÂºπÁ™ó
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showFileManager.value = false;
  }
  // ÈáçÁΩÆÈº†Ê†áÊåâ‰∏ãÁöÑÁõÆÊ†á
  modalMouseDownTarget.value = null;
};

// Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†Ê®°ÊÄÅËíôÂ±ÇÁöÑÈº†Ê†áÊùæÂºÄ‰∫ã‰ª∂
const handleFileUploadOverlayMouseUp = (event) => {
  // Âè™ÊúâÂΩìÈº†Ê†áÊåâ‰∏ãÂíåÊùæÂºÄÁöÑÊòØÂêå‰∏Ä‰∏™ÂÖÉÁ¥†Ôºå‰∏îÊòØËíôÂ±ÇÊú¨Ë∫´Êó∂ÔºåÊâçÂÖ≥Èó≠ÂºπÁ™ó
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showFileUploadModal.value = false;
  }
  // ÈáçÁΩÆÈº†Ê†áÊåâ‰∏ãÁöÑÁõÆÊ†á
  modalMouseDownTarget.value = null;
};

// Â§ÑÁêÜ‰∏ªÈ¢òËÆæÁΩÆÊ®°ÊÄÅËíôÂ±ÇÁöÑÈº†Ê†áÊùæÂºÄ‰∫ã‰ª∂
const handleThemeSettingsOverlayMouseUp = (event) => {
  // Âè™ÊúâÂΩìÈº†Ê†áÊåâ‰∏ãÂíåÊùæÂºÄÁöÑÊòØÂêå‰∏Ä‰∏™ÂÖÉÁ¥†Ôºå‰∏îÊòØËíôÂ±ÇÊú¨Ë∫´Êó∂ÔºåÊâçÂÖ≥Èó≠ÂºπÁ™ó
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showThemeSettings.value = false;
  }
  // ÈáçÁΩÆÈº†Ê†áÊåâ‰∏ãÁöÑÁõÆÊ†á
  modalMouseDownTarget.value = null;
};

// Â§ÑÁêÜÊèêÁ§∫ËØçÂ∫ìÊ®°ÊÄÅËíôÂ±ÇÁöÑÈº†Ê†áÊùæÂºÄ‰∫ã‰ª∂
const handlePromptLibraryOverlayMouseUp = (event) => {
  // Âè™ÊúâÂΩìÈº†Ê†áÊåâ‰∏ãÂíåÊùæÂºÄÁöÑÊòØÂêå‰∏Ä‰∏™ÂÖÉÁ¥†Ôºå‰∏îÊòØËíôÂ±ÇÊú¨Ë∫´Êó∂ÔºåÊâçÂÖ≥Èó≠ÂºπÁ™ó
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showPromptLibrary.value = false;
  }
  // ÈáçÁΩÆÈº†Ê†áÊåâ‰∏ãÁöÑÁõÆÊ†á
  modalMouseDownTarget.value = null;
};

// Â§ÑÁêÜÊèêÁ§∫ËØçÁºñËæëÊ®°ÊÄÅËíôÂ±ÇÁöÑÈº†Ê†áÊùæÂºÄ‰∫ã‰ª∂
const handlePromptModalOverlayMouseUp = (event) => {
  // Âè™ÊúâÂΩìÈº†Ê†áÊåâ‰∏ãÂíåÊùæÂºÄÁöÑÊòØÂêå‰∏Ä‰∏™ÂÖÉÁ¥†Ôºå‰∏îÊòØËíôÂ±ÇÊú¨Ë∫´Êó∂ÔºåÊâçÂÖ≥Èó≠ÂºπÁ™ó
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showPromptModal.value = false;
  }
  // ÈáçÁΩÆÈº†Ê†áÊåâ‰∏ãÁöÑÁõÆÊ†á
  modalMouseDownTarget.value = null;
};

// ÊâìÂºÄÊèêÁ§∫ËØçÂ∫ì
const openPromptLibrary = () => {
  showPromptLibrary.value = true;
};

// ËøáÊª§ÊèêÁ§∫ËØçÂ∫ì‰∏≠ÁöÑÊèêÁ§∫ËØç
const filteredPrompts = computed(() => {
  let result = [...promptTemplates.value];
  
  // ÊåâÁ±ªÂà´ËøáÊª§
  if (currentPromptFilter.value !== 'all') {
    result = result.filter(prompt => prompt.category === currentPromptFilter.value);
  }
  
  // ÊåâÊêúÁ¥¢ÂÖ≥ÈîÆÂ≠óËøáÊª§
  if (promptSearchQuery.value.trim()) {
    const query = promptSearchQuery.value.toLowerCase();
    result = result.filter(prompt => 
      prompt.name.toLowerCase().includes(query) || 
      prompt.description.toLowerCase().includes(query) || 
      prompt.content.toLowerCase().includes(query) ||
      prompt.tags.some(tag => tag.toLowerCase().includes(query))
    );
  }
  
  return result;
});

// Ëé∑ÂèñÊèêÁ§∫ËØçÁ±ªÂà´ÁöÑÈ¢úËâ≤
const getPromptCategoryColor = (category: string) => {
  const colorMap: {[key: string]: string} = {
    writing: '#FF6B95',
    coding: '#4665ee',
    analysis: '#42b983',
    creativity: '#f39c12',
    education: '#9b59b6',
    other: '#3498db'
  };
  
  return colorMap[category] || '#3498db';
};

// Ëé∑ÂèñÊèêÁ§∫ËØçÁ±ªÂà´ÁöÑÊ†áÁ≠æ
const getCategoryLabel = (category: string) => {
  const labelMap: {[key: string]: string} = {
    writing: 'ÂÜô‰Ωú',
    coding: 'ÁºñÁ®ã',
    analysis: 'ÂàÜÊûê',
    creativity: 'ÂàõÊÑè',
    education: 'ÊïôËÇ≤',
    other: 'ÂÖ∂‰ªñ'
  };
  
  return labelMap[category] || 'ÂÖ∂‰ªñ';
};

// ÊòæÁ§∫ÊèêÁ§∫ËØçÂÜÖÂÆπÈ¢ÑËßà
const showPromptPreview = (prompt: PromptTemplate, event: MouseEvent) => {
  previewContent.value = prompt.content;
  
  // ËÆ°ÁÆóÈ¢ÑËßàÊ°ÜÁöÑ‰ΩçÁΩÆ
  const target = event.currentTarget as HTMLElement;
  const rect = target.getBoundingClientRect();
  
  // ËÆ°ÁÆóËßÜÁ™óÂ§ßÂ∞è
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  // ÈªòËÆ§ÂÆΩÈ´ò
  const previewWidth = 600;
  // Ê†πÊçÆÂÜÖÂÆπÈïøÂ∫¶ÂÜ≥ÂÆöÈ¢ÑËßàÈ´òÂ∫¶Ôºå‰ΩÜËá≥Â∞ë200pxÔºåÊúÄÂ§ö500px
  const previewHeight = 500; // ‰ΩøÁî®Âõ∫ÂÆöÊúÄÂ§ßÈ´òÂ∫¶ÔºåÂÜÖÈÉ®ÊªöÂä®
  
  // Á°ÆÂÆöÂ∑¶Âè≥‰ΩçÁΩÆ - Â¶ÇÊûúÂè≥‰æßÁ©∫Èó¥‰∏çË∂≥ÂàôÊòæÁ§∫Âú®Â∑¶‰æß
  let left;
  if (rect.right + previewWidth + 20 < viewportWidth) {
    // ÊòæÁ§∫Âú®Âè≥‰æß
    left = `${rect.right + 10}px`;
  } else {
    // ÊòæÁ§∫Âú®Â∑¶‰æß
    left = `${Math.max(10, rect.left - previewWidth - 10)}px`;
  }
  
  // Á°ÆÂÆö‰∏ä‰∏ã‰ΩçÁΩÆ - Â∞ΩÈáèÂ±Ö‰∏≠ÂØπÈΩêÔºå‰ΩÜ‰∏çË∂ÖÂá∫ËßÜÁ™ó
  let top = rect.top - 100; // Âú®Âç°Áâá‰∏äÊñπÊòæÁ§∫ÔºåÁïôÂá∫Á©∫Èó¥
  top = Math.max(10, Math.min(viewportHeight - previewHeight - 10, top));
  
  // ËÆæÁΩÆÈ¢ÑËßàÊ°Ü‰ΩçÁΩÆ
  previewPosition.value = {
    top: `${top}px`,
    left: left,
    maxWidth: `${previewWidth}px`,
    height: `${previewHeight}px`
  };
  
  showPreview.value = true;
};

// ÈöêËóèÊèêÁ§∫ËØçÂÜÖÂÆπÈ¢ÑËßà
const hidePromptPreview = () => {
  showPreview.value = false;
};

// Â§çÂà∂ÊèêÁ§∫ËØçÂà∞ËæìÂÖ•Ê°Ü
const copyPromptToInput = (prompt: PromptTemplate) => {
  // ËÆæÁΩÆÂΩìÂâçÊøÄÊ¥ªÁöÑÁ≥ªÁªüÊèêÁ§∫ËØç
  activeSystemPrompt.value = { ...prompt };
  showActivePromptBadge.value = true;
  showPromptLibrary.value = false;
  showPreview.value = false; // Á°Æ‰øùÂÖ≥Èó≠È¢ÑËßà
  
  // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
  showToast(`Â∑≤ËÆæÁΩÆ"${prompt.name}"‰∏∫ÂΩìÂâçÁ≥ªÁªüÊèêÁ§∫ËØç`);
};

// Ê∏ÖÈô§ÂΩìÂâçÊøÄÊ¥ªÁöÑÁ≥ªÁªüÊèêÁ§∫ËØç
const clearActiveSystemPrompt = () => {
  activeSystemPrompt.value = null;
  showActivePromptBadge.value = false;
  showToast('Â∑≤Ê∏ÖÈô§Á≥ªÁªüÊèêÁ§∫ËØç');
};

// ÊâìÂºÄÊñ∞Â¢ûÊèêÁ§∫ËØçÊ®°ÊÄÅÊ°Ü
const openAddPromptModal = () => {
  isEditingPrompt.value = false;
  editingPrompt.value = {
    id: Date.now(),
    name: '',
    description: '',
    content: '',
    category: 'writing',
    tags: [],
    usageCount: 0,
    functionToolId: ''
  };
  promptTagsInput.value = '';
  showPromptModal.value = true;
};

// ÁºñËæëÊèêÁ§∫ËØç
const editPrompt = (prompt: PromptTemplate) => {
  isEditingPrompt.value = true;
  editingPrompt.value = { ...prompt };
  promptTagsInput.value = prompt.tags.join(',');
  showPromptModal.value = true;
};

// ‰øùÂ≠òÊèêÁ§∫ËØç
const savePrompt = async () => {
  // È™åËØÅË°®Âçï
  if (!editingPrompt.value.name.trim()) {
    showToast('ËØ∑ËæìÂÖ•ÊèêÁ§∫ËØçÂêçÁß∞');
    return;
  }
  
  if (!editingPrompt.value.content.trim()) {
    showToast('ËØ∑ËæìÂÖ•ÊèêÁ§∫ËØçÂÜÖÂÆπ');
    return;
  }
  
  // Â§ÑÁêÜÊ†áÁ≠æ
  if (promptTagsInput.value.trim()) {
    editingPrompt.value.tags = promptTagsInput.value.split(',')
      .map(tag => tag.trim())
      .filter(tag => tag.length > 0);
  } else {
    editingPrompt.value.tags = [];
  }
  
  // ÊòæÁ§∫‰øùÂ≠ò‰∏≠ÊèêÁ§∫
  showToast(isEditingPrompt.value ? 'Ê≠£Âú®Êõ¥Êñ∞ÊèêÁ§∫ËØç...' : 'Ê≠£Âú®Ê∑ªÂä†ÊèêÁ§∫ËØç...');
  
  // ‰øùÂ≠òÂà∞ÊúçÂä°Âô®
  const success = await savePromptToServer(editingPrompt.value);
  
  if (success) {
    if (isEditingPrompt.value) {
      // Êõ¥Êñ∞Áé∞ÊúâÊèêÁ§∫ËØç
      const index = promptTemplates.value.findIndex(p => p.id === editingPrompt.value.id);
      if (index !== -1) {
        promptTemplates.value[index] = { ...editingPrompt.value };
      }
    } else {
      // Ê∑ªÂä†Êñ∞ÊèêÁ§∫ËØç
      promptTemplates.value.push({ ...editingPrompt.value });
    }
    
    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
    showPromptModal.value = false;
  }
};

// Âà†Èô§ÊèêÁ§∫ËØç
// Âà†Èô§ÊèêÁ§∫ËØç
const deletePrompt = async (id: number | string) => {
  if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊèêÁ§∫ËØçÂêóÔºü')) {
    try {
      // ÂèëÈÄÅÂà†Èô§ËØ∑Ê±ÇÂà∞ÂêéÁ´ØAPI
      const response = await fetch(`${API_BASE_URL}/ai/prompt/deleteSystemPrompt`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          promptId: id.toString()
        })
      });
      
      const result = await response.json();
      
      if (result.code === "200") {
        // Âà†Èô§ÊàêÂäüÔºå‰ªéÊú¨Âú∞ÂàóË°®ÁßªÈô§
        const index = promptTemplates.value.findIndex(p => p.id === id);
        if (index !== -1) {
          const promptName = promptTemplates.value[index].name;
          promptTemplates.value.splice(index, 1);
          showToast(`ÊèêÁ§∫ËØç"${promptName}"Â∑≤Âà†Èô§`);
        }
      } else {
        // Âà†Èô§Â§±Ë¥•
        console.warn('Âà†Èô§ÊèêÁ§∫ËØçÂ§±Ë¥•:', result);
        showToast('Âà†Èô§ÊèêÁ§∫ËØçÂ§±Ë¥•: ' + (result.userMessage || result.message || 'ËØ∑Ê±ÇÈîôËØØ'));
      }
    } catch (error) {
      console.error('Âà†Èô§ÊèêÁ§∫ËØçËØ∑Ê±ÇÈîôËØØ:', error);
      showToast('Âà†Èô§ÊèêÁ§∫ËØçÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
    }
  }
};

// ÁõëÂê¨ÊèêÁ§∫ËØçÂ∫ìÊòæÁ§∫Áä∂ÊÄÅ
watch(showPromptLibrary, (newValue) => {
  if (!newValue) {
    // ÂΩìÊèêÁ§∫ËØçÂ∫ìÂÖ≥Èó≠Êó∂ÔºåÁ°Æ‰øùÈ¢ÑËßà‰πüÂÖ≥Èó≠
    showPreview.value = false;
  }
});

// ÁõëÂê¨ÂÖ®Â±ÄÁÇπÂáª‰∫ã‰ª∂
onMounted(() => {
  document.body.addEventListener('click', () => {
    showPreview.value = false;
  });
});

// Ëé∑ÂèñÊâÄÊúâËÅäÂ§©ÂéÜÂè≤
const fetchAllChatHistory = async () => {
  try {
    const response = await fetch(`${API_BASE_URL}/ai/chat/getAllChatHistoryList`);
    const result = await response.json();
    
    if (result.code === "200" && result.data) {
      // Â§ÑÁêÜÊñ∞ÁöÑJSONÊï∞ÁªÑÊ†ºÂºèÊï∞ÊçÆ
      const historyList = result.data;
      
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÊï∞ÊçÆ
      if (!historyList || historyList.length === 0) {
        chatHistory.value = [];
        return;
      }
      
      // Áõ¥Êé•Â§ÑÁêÜJSONÊï∞ÁªÑÊ†ºÂºèÁöÑÊï∞ÊçÆ
      const parsedItems: HistoryItem[] = historyList.map(item => {
        try {
          // Ëß£ÊûêÊ†áÁ≠æÊï∞ÁªÑ
          let tags: string[] = [];
          try {
            if (typeof item.chatTag === 'string') {
              tags = JSON.parse(item.chatTag);
            } else if (Array.isArray(item.chatTag)) {
              tags = item.chatTag;
            }
          } catch (e) {
            console.warn('Êó†Ê≥ïËß£ÊûêÊ†áÁ≠æ:', item.chatTag);
            tags = [];
          }
          
          return {
            id: parseInt(item.chatId, 10),
            title: item.chatTittle || 'Êñ∞Âª∫‰ºöËØù',
            time: item.updateTime || item.createTime || '‰ªäÂ§©',
            tags: tags
          };
        } catch (err) {
          console.error('Ëß£ÊûêÂçï‰∏™ÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', err);
          return null;
        }
      }).filter(item => item !== null); // ËøáÊª§ÊéâËß£ÊûêÂ§±Ë¥•ÁöÑÈ°π
      
      chatHistory.value = parsedItems;
      console.log('ÊàêÂäüÂä†ËΩΩËÅäÂ§©ÂéÜÂè≤:', parsedItems.length, 'Êù°ËÆ∞ÂΩï');
    } else {
      console.warn('Ëé∑ÂèñËÅäÂ§©ÂéÜÂè≤Â§±Ë¥•:', result.message);
      chatHistory.value = [];
    }
  } catch (error) {
    console.error('Ëé∑ÂèñËÅäÂ§©ÂéÜÂè≤Êé•Âè£ÈîôËØØ:', error);
    chatHistory.value = [];
  }
};

// Ëß£ÊûêÊ∂àÊÅØÂÜÖÂÆπÔºåÂàÜÁ¶ªÊÄùËÄÉÂíåÂõûÂ§ç
const parseResponse = (content: string) => {
  let thinking = '';
  let response = content;
  
  // Â§ÑÁêÜÊÄùËÄÉÈÉ®ÂàÜ
  const thinkOpenTagIndex = content.indexOf('<think>');
  
  if (thinkOpenTagIndex !== -1) {
    // ÊâæÂà∞ÂºÄÂßãÊ†áÁ≠æ
    const afterOpenTag = content.substring(thinkOpenTagIndex + 7); // <think> ÈïøÂ∫¶‰∏∫7
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÁªìÊùüÊ†áÁ≠æ
    const thinkCloseTagIndex = afterOpenTag.indexOf('</think>');
    
    if (thinkCloseTagIndex !== -1) {
      // ÂÆåÊï¥ÁöÑÊÄùËÄÉÂÜÖÂÆπ
      thinking = afterOpenTag.substring(0, thinkCloseTagIndex).trim();
      // ÁßªÈô§Êï¥‰∏™ÊÄùËÄÉÈÉ®ÂàÜ‰ªéÂìçÂ∫î‰∏≠ÔºåÂåÖÊã¨Ê†áÁ≠æ
      response = content.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
    } else {
      // Âè™ÊúâÂºÄÂßãÊ†áÁ≠æÔºåËøòÊ≤°ÊúâÁªìÊùüÊ†áÁ≠æ
      thinking = afterOpenTag.trim();
      // ÁßªÈô§‰ªéÂºÄÂßãÊ†áÁ≠æÂà∞ÂÜÖÂÆπÁªìÊùüÁöÑÈÉ®ÂàÜ
      response = content.substring(0, thinkOpenTagIndex).trim();
    }
  }
  
  return {
    thinking,
    response
  };
};

// Ê∏≤ÊüìMarkdownÂÜÖÂÆπ
const renderMarkdown = (content: string) => {
  return marked(content);
};

// ‰ªéÂìçÂ∫î‰∏≠ÊèêÂèñchatId
const extractChatIdFromResponse = (responseText: string): string | null => {
  // Â∞ùËØï‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÂåπÈÖçchatId
  const chatIdRegex = /chatId[=:]\s*["']?(\d+)["']?/i;
  const match = responseText.match(chatIdRegex);
  
  if (match && match[1]) {
    console.log('‰ªéÂìçÂ∫î‰∏≠ÊèêÂèñÂà∞Êñ∞ÁöÑchatId:', match[1]);
    return match[1];
  }
  
  // Â∞ùËØïÊ£ÄÊü•ÊòØÂê¶ÂåÖÂê´JSONÊ†ºÂºèÁöÑÊï∞ÊçÆ
  try {
    // ÂØªÊâæÂèØËÉΩÁöÑJSONÈÉ®ÂàÜ
    const jsonStart = responseText.indexOf('{');
    if (jsonStart !== -1) {
      // Â∞ùËØïËß£ÊûêJSON
      const possibleJson = responseText.substring(jsonStart);
      const jsonObj = JSON.parse(possibleJson);
      
      // Ê£ÄÊü•Â∏∏ËßÅÁöÑchatIdÂ≠óÊÆµ‰ΩçÁΩÆ
      if (jsonObj.chatId) return jsonObj.chatId.toString();
      if (jsonObj.data && jsonObj.data.chatId) return jsonObj.data.chatId.toString();
    }
  } catch (error) {
    // JSONËß£ÊûêÂ§±Ë¥•ÔºåÁªßÁª≠ÂÖ∂‰ªñÂ∞ùËØï
  }
  
  return null;
};

// ÂàõÂª∫Êñ∞ÁöÑËÅäÂ§©‰ºöËØù
const createNewChatSession = (prompt: string, chatId: string) => {
  // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÈÄöËøátempChatIdÂàõÂª∫‰∫Ü‰ºöËØù
  if (selectedHistoryItem.value !== null) {
    // Â∑≤ÁªèÊúâÈÄâ‰∏≠ÁöÑ‰ºöËØù‰∫ÜÔºå‰∏çÈúÄË¶ÅÂÜçÂàõÂª∫
    console.log('Â∑≤ÊúâÈÄâ‰∏≠‰ºöËØùÔºå‰∏çÂàõÂª∫Êñ∞‰ºöËØù');
    return;
  }
  
  // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®Ëøô‰∏™chatIdÁöÑ‰ºöËØù
  const existingSession = chatHistory.value.find(item => item.id === parseInt(chatId, 10));
  if (existingSession) {
    console.log('Â∑≤Â≠òÂú®chatId‰∏∫', chatId, 'ÁöÑ‰ºöËØùÔºå‰∏çÈáçÂ§çÂàõÂª∫');
    return;
  }
  
  // Á¨¨‰∏ÄÊ¨°ÂØπËØùÊó∂ÂàõÂª∫Êñ∞‰ºöËØù
  const title = prompt.length > 20 ? prompt.substring(0, 20) + '...' : prompt;
  
  // Êõ¥Êñ∞‰æßËæπÊ†èÊòæÁ§∫
  const tempItem: HistoryItem = {
    id: parseInt(chatId, 10),
    title: title,
    time: 'ÂàöÂàö',
    tags: []
  };
  
  chatHistory.value = [tempItem, ...chatHistory.value];
  selectedHistoryItem.value = 0;
  
  console.log('ÂàõÂª∫Êñ∞‰ºöËØùÊàêÂäüÔºåchatId:', chatId);
};

// ÂàõÂª∫Êñ∞ÁöÑËÅäÂ§©ÂéÜÂè≤ËÆ∞ÂΩï
const insertChatHistory = async (title: string, chatId: string) => {
  try {
    // Ê†ºÂºèÂåñÊ†áÈ¢ò
    const formattedTitle = title.length > 20 ? title.substring(0, 20) + '...' : title;
    
    // ÁîüÊàêÂΩìÂâçÊó∂Èó¥
    const currentDate = new Date();
    
    // ÊûÑÂª∫ËØ∑Ê±ÇÊï∞ÊçÆ
    const chatData = {
      chatId: chatId,
      chatTittle: formattedTitle, // Ê≥®ÊÑèÂêéÁ´Ø‰ΩøÁî®ÁöÑÊòØchatTittleËÄå‰∏çÊòØtitle
      chatTag: [], // ÈªòËÆ§Êó†Ê†áÁ≠æ
      createTime: formatDateToFriendly(currentDate),
      updateTime: formatDateToFriendly(currentDate)
    };
    
    // ÂèëÈÄÅËØ∑Ê±ÇÂàõÂª∫ËÅäÂ§©ÂéÜÂè≤
    const response = await fetch(`${API_BASE_URL}/ai/chat/insertChatHistoryList`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(chatData)
    });
    
    const result = await response.json();
    
    if (result.code === "200") {
      // ÂàõÂª∫ÊàêÂäüÔºåÊõ¥Êñ∞Êú¨Âú∞‰ºöËØùÂàóË°®
      const tempItem: HistoryItem = {
        id: parseInt(chatId),
        title: formattedTitle,
        time: 'ÂàöÂàö',
        tags: []
      };
      
      chatHistory.value = [tempItem, ...chatHistory.value];
      selectedHistoryItem.value = 0;
      
      console.log('ÂàõÂª∫‰ºöËØùÊàêÂäüÔºåchatId:', chatId);
      return true;
    } else {
      // ËØ∑Ê±ÇÂ§±Ë¥•
      console.warn('ÂàõÂª∫‰ºöËØùÂ§±Ë¥•:', result);
      showToast('ÂàõÂª∫‰ºöËØùÂ§±Ë¥•: ' + (result.userMessage || result.message || 'ËØ∑Ê±ÇÈîôËØØ'));
      return false;
    }
  } catch (error) {
    console.error('ÂàõÂª∫‰ºöËØùËØ∑Ê±ÇÈîôËØØ:', error);
    showToast('ÂàõÂª∫‰ºöËØùÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
    return false;
  }
};

// Ê†πÊçÆÊ®°ÂûãÊèê‰æõÂïÜËé∑ÂèñÈ¢úËâ≤
const getModelProviderColor = (provider: string) => {
  const colorMap: {[key: string]: string} = {
    openai: '#10b981', // ÁªøËâ≤
    ollama: '#8b5cf6', // Á¥´Ëâ≤
    default: '#64748b' // ÈªòËÆ§ÁÅ∞Ëâ≤
  };
  
  return colorMap[provider.toLowerCase()] || colorMap.default;
};

// ‰ªéAPIËé∑ÂèñÊ®°ÂûãÂàóË°®
const fetchAllModels = async () => {
  try {
    const response = await fetch(`${API_BASE_URL}/ai/model/getAllModels`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    });
    
    const result = await response.json();
    
    if (result.code === "200" && result.data) {
      // Â§ÑÁêÜËøîÂõûÁöÑÊ®°ÂûãÊï∞ÊçÆ
      const modelList = result.data;
      
      // ËΩ¨Êç¢Ê†ºÂºèÂπ∂ËÆæÁΩÆÈ¢úËâ≤
      availableModels.value = modelList.map((model: any) => {
        // ‰ªéÊ†áÁ≠æÂ≠óÁ¨¶‰∏≤‰∏≠ÂàÜÂâ≤Âá∫Ê†áÁ≠æÊï∞ÁªÑ
        const tags = model.modelTag ? model.modelTag.split(',') : [];
        
        return {
          id: model.modelName,
          name: model.modelName,
          description: model.modelDescription,
          color: getModelProviderColor(model.modelProvider),
          provider: model.modelProvider,
          tags: tags
        };
      });
      
      console.log('Ëé∑ÂèñÊ®°ÂûãÂàóË°®ÊàêÂäü:', availableModels.value);
      
      // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©Ê®°ÂûãÔºåÂàôÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™
      if (!selectedModel.value && availableModels.value.length > 0) {
        selectedModel.value = availableModels.value[0].id;
      }
    } else {
      // ËØ∑Ê±ÇÂ§±Ë¥•
      console.warn('Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•:', result);
      showToast('Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•Ôºö' + (result.userMessage || result.message || 'ËØ∑Ê±ÇÈîôËØØ'));
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÊ®°ÂûãÂàóË°®ËØ∑Ê±ÇÈîôËØØ:', error);
    showToast('Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
  }
};

// ÊâìÂºÄÊ®°ÂûãÈÄâÊã©Âô®
const openModelSelector = () => {
  tempSelectedModel.value = selectedModel.value; // ÂàùÂßãÂåñ‰∏¥Êó∂ÈÄâÊã©‰∏∫ÂΩìÂâçÈÄâÊã©
  showModelSelector.value = true;
};

// ÈÄâÊã©Ê®°Âûã
const selectModel = (modelId: string) => {
  tempSelectedModel.value = modelId;
};

// Â∫îÁî®Ê®°ÂûãÈÄâÊã©
const applyModelSelection = () => {
  selectedModel.value = tempSelectedModel.value;
  showToast(`Â∑≤ÂàáÊç¢Âà∞ ${availableModels.value.find(m => m.id === selectedModel.value)?.name} Ê®°Âûã`);
  showModelSelector.value = false;
};

// Â§ÑÁêÜÊ®°ÂûãÈÄâÊã©Âô®Ê®°ÊÄÅËíôÂ±ÇÁöÑÈº†Ê†áÊùæÂºÄ‰∫ã‰ª∂
const handleModelSelectorOverlayMouseUp = (event) => {
  // Âè™ÊúâÂΩìÈº†Ê†áÊåâ‰∏ãÂíåÊùæÂºÄÁöÑÊòØÂêå‰∏Ä‰∏™ÂÖÉÁ¥†Ôºå‰∏îÊòØËíôÂ±ÇÊú¨Ë∫´Êó∂ÔºåÊâçÂÖ≥Èó≠ÂºπÁ™ó
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showModelSelector.value = false;
  }
  // ÈáçÁΩÆÈº†Ê†áÊåâ‰∏ãÁöÑÁõÆÊ†á
  modalMouseDownTarget.value = null;
};

// ‰ªéAPIËé∑ÂèñÊâÄÊúâÊèêÁ§∫ËØç
const fetchAllPrompts = async () => {
  try {
    // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
    showToast('Ê≠£Âú®Âä†ËΩΩÊèêÁ§∫ËØçÂ∫ì...');
    
    // ÂèëÈÄÅËØ∑Ê±ÇËé∑ÂèñÊâÄÊúâÊèêÁ§∫ËØç
    const response = await fetch(`${API_BASE_URL}/ai/prompt/getAllSystemPrompt`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    });
    
    const result = await response.json();
    
    if (result.code === "200" && result.data) {
      // Ê∏ÖÁ©∫ÂΩìÂâçÊèêÁ§∫ËØçÂàóË°®
      promptTemplates.value = [];
      
      // Â§ÑÁêÜËøîÂõûÁöÑÊèêÁ§∫ËØçÊï∞ÊçÆ
result.data.forEach((item: any) => {
  // Â∞ÜÊ†áÁ≠æÂ≠óÁ¨¶‰∏≤ËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
  const tags = item.promptTag ? item.promptTag.split(',').map((tag: string) => tag.trim()) : [];
  
  // Á±ªÂûãÊò†Â∞ÑÂ§ÑÁêÜ
  let category = 'other';
  const promptType = item.promptType || '';
  
  // Ê†πÊçÆpromptTypeÊò†Â∞Ñ‰∏∫ÂâçÁ´ØÁ±ªÂà´
  if (promptType.includes('ÂÜô‰Ωú') || promptType.includes('ÊñáÁ´†')) {
    category = 'writing';
  } else if (promptType.includes('ÁºñÁ®ã') || promptType.includes('‰ª£Á†Å')) {
    category = 'coding';
  } else if (promptType.includes('ÂàÜÊûê') || promptType.includes('Êï∞ÊçÆ')) {
    category = 'analysis';
  } else if (promptType.includes('ÂàõÊÑè') || promptType.includes('Âàõ‰Ωú')) {
    category = 'creativity';
  } else if (promptType.includes('ÊïôËÇ≤') || promptType.includes('Â≠¶‰π†')) {
    category = 'education';
  }
  
  // ËΩ¨Êç¢‰∏∫Â∫îÁî®ÂÜÖÁöÑÊèêÁ§∫ËØçÊ†ºÂºèÂπ∂Ê∑ªÂä†Âà∞ÂàóË°®
  promptTemplates.value.push({
    id: item.promptId, // ‰ΩøÁî®ÂêéÁ´ØËøîÂõûÁöÑID
    name: item.promptName,
    description: item.promptDescription,
    content: item.promptContent,
    category: category, // ‰ΩøÁî®Êò†Â∞ÑÂêéÁöÑÁ±ªÂà´
    tags: tags,
    usageCount: 0, // ÈªòËÆ§‰∏∫0
    functionToolId: item.functionToolId // Êñ∞Â¢ûÂäüËÉΩÂ∑•ÂÖ∑IDÂ≠óÊÆµ
  });
});
      
      console.log('ÊàêÂäüÂä†ËΩΩÊèêÁ§∫ËØçÂ∫ì:', promptTemplates.value);
    } else {
      console.warn('Ëé∑ÂèñÊèêÁ§∫ËØçÂ§±Ë¥•:', result);
      showToast('Ëé∑ÂèñÊèêÁ§∫ËØçÂ§±Ë¥•: ' + (result.userMessage || result.message || 'ËØ∑Ê±ÇÈîôËØØ'));
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÊèêÁ§∫ËØçËØ∑Ê±ÇÈîôËØØ:', error);
    showToast('Ëé∑ÂèñÊèêÁ§∫ËØçÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
  }
};

// Ê†πÊçÆIDËé∑ÂèñÂçï‰∏™ÊèêÁ§∫ËØç
const getSystemPromptById = async (promptId: string): Promise<PromptTemplate | null> => {
  try {
    // ÂèëÈÄÅËØ∑Ê±ÇËé∑ÂèñÊèêÁ§∫ËØçËØ¶ÊÉÖ
    const response = await fetch(`${API_BASE_URL}/ai/prompt/getSystemPromptById`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        promptId: promptId
      })
    });
    
    const result = await response.json();
    
    if (result.code === "200" && result.data) {
      const item = result.data;
      // Â∞ÜÊ†áÁ≠æÂ≠óÁ¨¶‰∏≤ËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
      const tags = item.promptTag ? item.promptTag.split(',').map((tag: string) => tag.trim()) : [];
      
      // Á±ªÂûãÊò†Â∞ÑÂ§ÑÁêÜ
      let category = 'other';
      const promptType = item.promptType || '';
      
      // Ê†πÊçÆpromptTypeÊò†Â∞Ñ‰∏∫ÂâçÁ´ØÁ±ªÂà´
      if (promptType.includes('ÂÜô‰Ωú') || promptType.includes('ÊñáÁ´†')) {
        category = 'writing';
      } else if (promptType.includes('ÁºñÁ®ã') || promptType.includes('‰ª£Á†Å')) {
        category = 'coding';
      } else if (promptType.includes('ÂàÜÊûê') || promptType.includes('Êï∞ÊçÆ')) {
        category = 'analysis';
      } else if (promptType.includes('ÂàõÊÑè') || promptType.includes('Âàõ‰Ωú')) {
        category = 'creativity';
      } else if (promptType.includes('ÊïôËÇ≤') || promptType.includes('Â≠¶‰π†')) {
        category = 'education';
      }
      
      // ËΩ¨Êç¢‰∏∫Â∫îÁî®ÂÜÖÁöÑÊèêÁ§∫ËØçÊ†ºÂºè
      return {
        id: item.promptId,
        name: item.promptName,
        description: item.promptDescription,
        content: item.promptContent,
        category: category,
        tags: tags,
        usageCount: 0,
        functionToolId: item.functionToolId // Êñ∞Â¢ûÂäüËÉΩÂ∑•ÂÖ∑IDÂ≠óÊÆµ
      };
    } else {
      console.warn('Ëé∑ÂèñÊèêÁ§∫ËØçËØ¶ÊÉÖÂ§±Ë¥•:', result);
      showToast('Ëé∑ÂèñÊèêÁ§∫ËØçËØ¶ÊÉÖÂ§±Ë¥•: ' + (result.userMessage || result.message || 'ËØ∑Ê±ÇÈîôËØØ'));
      return null;
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÊèêÁ§∫ËØçËØ¶ÊÉÖËØ∑Ê±ÇÈîôËØØ:', error);
    showToast('Ëé∑ÂèñÊèêÁ§∫ËØçËØ¶ÊÉÖÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
    return null;
  }
};

// Â∞ÜÂêéÁ´ØÊèêÁ§∫ËØçÁ±ªÂûãÊò†Â∞ÑÂà∞ÂâçÁ´ØÁ±ªÂà´
const mapPromptTypeToCategory = (promptType: string): string => {
  const typeMap: {[key: string]: string} = {
    'ÂÜô‰Ωú': 'writing',
    'ÊñáÁ´†': 'writing',
    'ÁºñÁ®ã': 'coding',
    '‰ª£Á†Å': 'coding',
    'ÂàÜÊûê': 'analysis',
    'Êï∞ÊçÆ': 'analysis',
    'ÂàõÊÑè': 'creativity',
    'Âàõ‰Ωú': 'creativity',
    'ÊïôËÇ≤': 'education',
    'Â≠¶‰π†': 'education',
    'ÂÆ¢Êúç': 'other',
    'ÂØπËØù': 'other',
    'ÊóÖÊ∏∏': 'other'
  };
  
  // Â¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÈ°πÔºåËøîÂõûother
  return typeMap[promptType] || 'other';
};

// Â∞ÜÂâçÁ´ØÁ±ªÂà´Êò†Â∞ÑÂõûÂêéÁ´ØÊèêÁ§∫ËØçÁ±ªÂûã
const mapCategoryToPromptType = (category: string): string => {
  const categoryMap: {[key: string]: string} = {
    'writing': 'ÂÜô‰Ωú',
    'coding': 'ÁºñÁ®ã',
    'analysis': 'ÂàÜÊûê',
    'creativity': 'ÂàõÊÑè',
    'education': 'ÊïôËÇ≤',
    'other': 'ÂÖ∂‰ªñ'
  };
  
  // Â¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÈ°πÔºåËøîÂõû"ÂÖ∂‰ªñ"
  return categoryMap[category] || 'ÂÖ∂‰ªñ';
};

// Ê∑ªÂä†ÊàñÊõ¥Êñ∞ÊèêÁ§∫ËØçÂà∞ÂêéÁ´Ø
const savePromptToServer = async (prompt: PromptTemplate): Promise<boolean> => {
  try {
    
    // ÊûÑÂª∫Êèê‰∫§Êï∞ÊçÆ
let promptType = 'ÂÖ∂‰ªñ'; // ÈªòËÆ§Á±ªÂûã
const category = prompt.category;

// ‰ªéÂâçÁ´ØÁ±ªÂà´Êò†Â∞ÑÂõûÂêéÁ´ØÁ±ªÂûã
if (category === 'writing') {
  promptType = 'ÂÜô‰Ωú';
} else if (category === 'coding') {
  promptType = 'ÁºñÁ®ã';
} else if (category === 'analysis') {
  promptType = 'ÂàÜÊûê';
} else if (category === 'creativity') {
  promptType = 'ÂàõÊÑè';
} else if (category === 'education') {
  promptType = 'ÊïôËÇ≤';
}

// Âà§Êñ≠ÊòØÊñ∞Â¢ûËøòÊòØÁºñËæë
const isUpdate = isEditingPrompt.value && prompt.id;
let apiUrl = `${API_BASE_URL}/ai/prompt/addSystemPrompt`;
let promptData: any = {
  promptName: prompt.name,
  promptType: promptType,
  promptDescription: prompt.description,
  promptTag: prompt.tags.join(','),
  promptContent: prompt.content,
  functionToolId: prompt.functionToolId || '' // Ê∑ªÂä†ÂäüËÉΩÂ∑•ÂÖ∑IDÂ≠óÊÆµ
};
    
// Â¶ÇÊûúÊòØÁºñËæëÊ®°ÂºèÔºå‰ΩøÁî®Êõ¥Êñ∞Êé•Âè£Âπ∂Ê∑ªÂä†promptId
if (isUpdate) {
  apiUrl = `${API_BASE_URL}/ai/prompt/updateSystemPrompt`;
  promptData.promptId = prompt.id.toString();
}
    
    // ÂèëÈÄÅËØ∑Ê±Ç
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(promptData)
    });
    
    const result = await response.json();
    
    // Ê£ÄÊü•ÂìçÂ∫îÁ†ÅÔºàÊñ∞Â¢ûÊé•Âè£ÂèØËÉΩËøîÂõû"200"ÔºåÊõ¥Êñ∞Êé•Âè£ËøîÂõû"0"Ôºâ
    if ((result.code === "0" || result.code === "200") && result.data) {
      // ÊàêÂäüÔºåÊõ¥Êñ∞Êú¨Âú∞ÊèêÁ§∫ËØçÁöÑIDÔºàÊñ∞Â¢ûÊó∂ÈúÄË¶ÅÔºâ
      if (!isUpdate) {
      prompt.id = result.data.promptId;
      }
      console.log('ÊèêÁ§∫ËØç‰øùÂ≠òÊàêÂäü:', result.data);
      showToast(result.message || (isUpdate ? 'ÊèêÁ§∫ËØçÊõ¥Êñ∞ÊàêÂäü' : 'ÊèêÁ§∫ËØçÊ∑ªÂä†ÊàêÂäü'));
      return true;
    } else {
      console.warn('‰øùÂ≠òÊèêÁ§∫ËØçÂ§±Ë¥•:', result);
      showToast('‰øùÂ≠òÊèêÁ§∫ËØçÂ§±Ë¥•: ' + (result.message || 'ËØ∑Ê±ÇÈîôËØØ'));
      return false;
    }
  } catch (error) {
    console.error('‰øùÂ≠òÊèêÁ§∫ËØçËØ∑Ê±ÇÈîôËØØ:', error);
    showToast('‰øùÂ≠òÊèêÁ§∫ËØçÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
    return false;
  }
};

// Ê∑ªÂä†Ê®°ÂûãÁõ∏ÂÖ≥Áä∂ÊÄÅ
const showAddModelModal = ref(false);
const newModel = ref({
  modelName: '',
  modelProvider: '',
  modelDescription: '',
  modelTag: ''
});
const modelTagsInput = ref('');
const isEditingModel = ref(false); // ÊòØÂê¶Â§Ñ‰∫éÁºñËæëÊ®°Âºè

// Â§ÑÁêÜÊ∑ªÂä†Ê®°ÂûãÂºπÁ™óËíôÂ±ÇÁöÑÈº†Ê†áÊùæÂºÄ‰∫ã‰ª∂
const handleAddModelModalOverlayMouseUp = (event) => {
  // Âè™ÊúâÂΩìÈº†Ê†áÊåâ‰∏ãÂíåÊùæÂºÄÁöÑÊòØÂêå‰∏Ä‰∏™ÂÖÉÁ¥†Ôºå‰∏îÊòØËíôÂ±ÇÊú¨Ë∫´Êó∂ÔºåÊâçÂÖ≥Èó≠ÂºπÁ™ó
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    showAddModelModal.value = false;
  }
  // ÈáçÁΩÆÈº†Ê†áÊåâ‰∏ãÁöÑÁõÆÊ†á
  modalMouseDownTarget.value = null;
};

// ÊâìÂºÄÊ∑ªÂä†Ê®°ÂûãÂºπÁ™ó
const openAddModelModal = () => {
  // ÈáçÁΩÆË°®ÂçïÊï∞ÊçÆÔºåËÆæÁΩÆ‰∏∫Êñ∞Â¢ûÊ®°Âºè
  isEditingModel.value = false;
  newModel.value = {
    modelName: '',
    modelProvider: '',
    modelDescription: '',
    modelTag: ''
  };
  modelTagsInput.value = '';
  showAddModelModal.value = true;
  showModelSelector.value = false; // ÂÖ≥Èó≠Ê®°ÂûãÈÄâÊã©Âô®
};

// ÁºñËæëÊ®°Âûã
const editModel = (model, event) => {
  // ËÆæÁΩÆ‰∏∫ÁºñËæëÊ®°Âºè
  isEditingModel.value = true;
  // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
  newModel.value = {
    modelName: model.name,
    modelProvider: model.provider,
    modelDescription: model.description,
    modelTag: model.tags.join(',')
  };
  modelTagsInput.value = model.tags.join(',');
  // ÊâìÂºÄÂºπÁ™ó
  showAddModelModal.value = true;
  // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëÊ®°ÂûãÈÄâÊã©
  if (event) event.stopPropagation();
};

// ‰øùÂ≠òÊñ∞Ê®°ÂûãÊàñÊõ¥Êñ∞Áé∞ÊúâÊ®°Âûã
const saveNewModel = async () => {
  try {
    // È™åËØÅË°®Âçï
    if (!newModel.value.modelName) {
      showToast('ËØ∑ËæìÂÖ•Ê®°ÂûãÂêçÁß∞');
      return;
    }
    
    // Â§ÑÁêÜÊ†áÁ≠æ
    newModel.value.modelTag = modelTagsInput.value;
    
    // Ê†πÊçÆÊòØÂê¶‰∏∫ÁºñËæëÊ®°ÂºèÔºåÈÄâÊã©‰∏çÂêåÁöÑAPIÊé•Âè£
    const apiUrl = isEditingModel.value ? 
      `${API_BASE_URL}/ai/model/updateModel` : 
      `${API_BASE_URL}/ai/model/addModel`;
    
    // ÂèëÈÄÅËØ∑Ê±ÇÊ∑ªÂä†ÊàñÊõ¥Êñ∞Ê®°Âûã
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(newModel.value)
    });
    
    const result = await response.json();
    
    if (result.code === "200" && result.data) {
      console.log(isEditingModel.value ? 'Ê®°ÂûãÊõ¥Êñ∞ÊàêÂäü:' : 'Ê®°ÂûãÊ∑ªÂä†ÊàêÂäü:', result.data);
      showToast(isEditingModel.value ? 'Ê®°ÂûãÊõ¥Êñ∞ÊàêÂäü' : 'Ê®°ÂûãÊ∑ªÂä†ÊàêÂäü');
      
      // ÂÖ≥Èó≠ÂºπÁ™óÂπ∂Âà∑Êñ∞Ê®°ÂûãÂàóË°®
      showAddModelModal.value = false;
      await fetchAllModels();
    } else {
      console.warn(isEditingModel.value ? 'Êõ¥Êñ∞Ê®°ÂûãÂ§±Ë¥•:' : 'Ê∑ªÂä†Ê®°ÂûãÂ§±Ë¥•:', result);
      showToast((isEditingModel.value ? 'Êõ¥Êñ∞Ê®°ÂûãÂ§±Ë¥•: ' : 'Ê∑ªÂä†Ê®°ÂûãÂ§±Ë¥•: ') + 
                (result.userMessage || result.message || 'ËØ∑Ê±ÇÈîôËØØ'));
    }
  } catch (error) {
    console.error(isEditingModel.value ? 'Êõ¥Êñ∞Ê®°ÂûãËØ∑Ê±ÇÈîôËØØ:' : 'Ê∑ªÂä†Ê®°ÂûãËØ∑Ê±ÇÈîôËØØ:', error);
    showToast((isEditingModel.value ? 'Êõ¥Êñ∞Ê®°ÂûãÂ§±Ë¥•' : 'Ê∑ªÂä†Ê®°ÂûãÂ§±Ë¥•') + 'ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
  }
};

// Êñ∞Â¢ûÁ°ÆËÆ§Âà†Èô§Ê®°ÂûãÁöÑÂºπÁ™ó
const showDeleteModelConfirm = ref(false);
const modelToDelete = ref<any>(null);

// ÊòæÁ§∫Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó
const confirmDeleteModel = (model: any, event: Event) => {
  modelToDelete.value = {
    modelProvider: model.provider,
    modelName: model.name
  };
  showDeleteModelConfirm.value = true;
  if (event) event.stopPropagation();
};

// Âà†Èô§Ê®°Âûã
const deleteModel = async () => {
  try {
    if (!modelToDelete.value) return;

    // ÂèëÈÄÅËØ∑Ê±ÇÂà†Èô§Ê®°Âûã
    const response = await fetch(`${API_BASE_URL}/ai/model/deleteModel`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        modelProvider: modelToDelete.value.modelProvider,
        modelName: modelToDelete.value.modelName
      })
    });

    const result = await response.json();

    if (result.code === "200") {
      console.log('Ê®°ÂûãÂà†Èô§ÊàêÂäü');
      showToast('Ê®°ÂûãÂà†Èô§ÊàêÂäü');
      
      // ÂÖ≥Èó≠Á°ÆËÆ§ÂºπÁ™óÂπ∂Âà∑Êñ∞Ê®°ÂûãÂàóË°®
      showDeleteModelConfirm.value = false;
      await fetchAllModels();
      
      // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ®°ÂûãÔºåÈáçÁΩÆÈÄâÊã©
      if (selectedModel.value === modelToDelete.value.modelName) {
        if (availableModels.value.length > 0) {
          selectedModel.value = availableModels.value[0].id;
        } else {
          selectedModel.value = '';
        }
      }
    } else {
      console.warn('Âà†Èô§Ê®°ÂûãÂ§±Ë¥•:', result);
      showToast('Âà†Èô§Ê®°ÂûãÂ§±Ë¥•: ' + (result.userMessage || result.message || 'ËØ∑Ê±ÇÈîôËØØ'));
    }
  } catch (error) {
    console.error('Âà†Èô§Ê®°ÂûãËØ∑Ê±ÇÈîôËØØ:', error);
    showToast('Âà†Èô§Ê®°ÂûãÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
  }
};

// ÂèñÊ∂àÂà†Èô§
const cancelDeleteModel = () => {
  showDeleteModelConfirm.value = false;
  modelToDelete.value = null;
};

// Â§ÑÁêÜÂà†Èô§Ê®°ÂûãÁ°ÆËÆ§ÂºπÁ™óËíôÂ±ÇÁöÑÈº†Ê†áÊùæÂºÄ‰∫ã‰ª∂
const handleDeleteModelConfirmOverlayMouseUp = (event) => {
  // Âè™ÊúâÂΩìÈº†Ê†áÊåâ‰∏ãÂíåÊùæÂºÄÁöÑÊòØÂêå‰∏Ä‰∏™ÂÖÉÁ¥†Ôºå‰∏îÊòØËíôÂ±ÇÊú¨Ë∫´Êó∂ÔºåÊâçÂÖ≥Èó≠ÂºπÁ™ó
  if (modalMouseDownTarget.value === event.target && event.target.classList.contains('modal-overlay')) {
    cancelDeleteModel();
  }
  // ÈáçÁΩÆÈº†Ê†áÊåâ‰∏ãÁöÑÁõÆÊ†á
  modalMouseDownTarget.value = null;
};

</script>

<style lang="less" scoped>
.chat-container {
  display: flex;
  height: 100vh;
  overflow: hidden;
  font-family: var(--font-family, 'PingFang SC', 'Microsoft YaHei', sans-serif);
  color: var(--text-color, #333);
  background-color: var(--background-color, #f7f7f9);
  
  // ÈªòËÆ§‰∏ªÈ¢òÂèòÈáè
  --primary-color: #4665ee;
  --secondary-color: #f7f7f9;
  --background-color: #f7f7f9;
  --text-color: #333333;
  --accent-color: #FF6B95;

  // Ê∑ªÂä†‰∏ªÈ¢òÂèòÈáèÔºåË∑üÈöèÁ≥ªÁªü‰∏ªÈ¢òÂàáÊç¢
  &.theme-default {
    --primary-color: #4665ee;
    --secondary-color: #f7f7f9; // ‰∏éËÉåÊôØËâ≤‰øùÊåÅ‰∏ÄËá¥
    --background-color: #f7f7f9;
    --text-color: #333333;
    --accent-color: #FF6B95;
  }

  &.theme-emerald {
    --primary-color: #10b981;
    --secondary-color: #ecfdf5; // Ë∞ÉÊï¥ÂõûÁï•Ê∑±ÁöÑÊ¨°Ë¶ÅÈ¢úËâ≤
    --background-color: #f0fbf5; // Ë∞ÉÊï¥‰∏∫Áï•Â∏¶ÁªøËâ≤Ë∞ÉÁöÑËÉåÊôØ
    --text-color: #064e3b; // Âä†Ê∑±ÊñáÊú¨È¢úËâ≤
    --accent-color: #7c3aed; // Âä†Ê∑±Á¥´Ëâ≤Âº∫Ë∞ÉËâ≤
  }

  &.theme-sunset {
    --primary-color: #f97316;
    --secondary-color: #fff7ed; // Êõ¥ÊòéÊòæÁöÑÊ©ôËâ≤ËÉåÊôØ
    --background-color: #fffaf5; // Ë∞ÉÊï¥‰∏∫Áï•Â∏¶Ê©ôËâ≤Ë∞ÉÁöÑËÉåÊôØ
    --text-color: #7c2d12; // Âä†Ê∑±ÊñáÊú¨È¢úËâ≤
    --accent-color: #2563eb; // Êõ¥Ê∑±ÁöÑËìùËâ≤Âº∫Ë∞É
  }

  &.theme-lavender {
    --primary-color: #8b5cf6;
    --secondary-color: #faf5ff; // ‰∏éËÉåÊôØËâ≤‰øùÊåÅ‰∏ÄËá¥
    --background-color: #faf5ff;
    --text-color: #581c87;
    --accent-color: #ec4899;
  }

  &.theme-graphite {
    --primary-color: #334155;
    --secondary-color: #f1f5f9; // Êõ¥ÊòéÊòæÁöÑËÉåÊôØËâ≤
    --background-color: #f8fafc;
    --text-color: #0f172a;
    --accent-color: #4f46e5; // Êõ¥‰∫ÆÁöÑÂº∫Ë∞ÉËâ≤
  }
  
  /* Ê†πÊçÆÂ≠ó‰ΩìËÆæÁΩÆË∞ÉÊï¥ */
  &.font-size-small {
    font-size: 0.9rem;
  }
  
  &.font-size-medium {
    font-size: 1rem;
  }
  
  &.font-size-large {
    font-size: 1.1rem;
  }
  
  &.font-spacing-compact {
    line-height: 1.4;
  }
  
  &.font-spacing-normal {
    line-height: 1.6;
  }
  
  &.font-spacing-relaxed {
    line-height: 1.8;
  }
  
  &.font-family-default {
    --font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
  }
  
  &.font-family-serif {
    --font-family: 'Noto Serif SC', serif;
  }
  
  &.font-family-mono {
    --font-family: 'Fira Code', 'Source Code Pro', monospace;
  }
  
  /* Ê∑±Ëâ≤Ê®°Âºè */
  &.dark-mode {
    --background-color: #1a1a1a;
    --secondary-color: #2a2a2a;
    --text-color: #f0f0f0;
    --sidebar-border-color: #333;
    
    .sidebar {
      background: var(--secondary-color);
      border-right-color: var(--sidebar-border-color);
      
      .sidebar-header {
        border-bottom-color: var(--sidebar-border-color);
      }
      
      .logo {
        color: #fff;
      }
      
      .history-item {
        &:hover {
          background: #333;
        }
      }
      
      .sidebar-footer {
        border-top-color: var(--sidebar-border-color);
      }
    }
    
    .message-content {
      background: #2a2a2a;
      color: #f0f0f0;
      
      .message-time {
        color: #aaa;
      }
    }
    
    .user-message .message-content {
      background: linear-gradient(135deg, #FF9A8B, #FF6B95); // ‰øùÊåÅÊ∑±Ëâ≤Ê®°Âºè‰∏ãÁî®Êà∑Ê∂àÊÅØËÉåÊôØ‰πü‰ΩøÁî®Á≤âËâ≤Á≥ª
    }
    
    .chat-input-area {
      background: #2a2a2a;
      border: 1px solid #333;
      
      .chat-input {
        color: #f0f0f0;
      }
    }
    
    .modal-container {
      background: #2a2a2a;
      color: #f0f0f0;
      
      .modal-header {
        border-bottom-color: #333;
      }
      
      .modal-footer {
        border-top-color: #333;
      }
    }
  }
}

/* ‰æßËæπÊ†èÂàáÊç¢ÊåâÈíÆ */
.sidebar-toggle {
  position: fixed;
  left: 10px;
  top: 10px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 30;
  border: none;
  color: #666;
  transition: all 0.2s;
  
  &:hover {
    background: #f0f0f3;
    color: #333;
    transform: scale(1.05);
  }
  
  svg {
    stroke: currentColor;
  }
}

/* ‰æßËæπÊ†èÊ†∑Âºè */
.sidebar {
  width: 260px;
  background: var(--background-color, #f7f7f9); // ‰ΩøÁî®‰∏é‰∏ªÈ°µÈù¢Áõ∏ÂêåÁöÑËÉåÊôØËâ≤
  border-right: 1px solid rgba(0, 0, 0, 0.12); // Âä†Ê∑±ËæπÊ°ÜÈ¢úËâ≤
  display: flex;
  flex-direction: column;
  height: 100%;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.03); // Ê∑ªÂä†ËΩªÂæÆÈò¥ÂΩ±Â¢ûÂä†Â±ÇÊ¨°ÊÑü
  
  &.sidebar-collapsed {
    width: 0;
    margin-left: -10px;
    border: none;
  }
  
  .sidebar-header {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.12); // Âä†Ê∑±ËæπÊ°ÜÈ¢úËâ≤
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 50px;
    background: rgba(0, 0, 0, 0.02); // ËΩªÂæÆËÉåÊôØËâ≤Âå∫Âà´
    
    .logo {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color, #333); // ‰ΩøÁî®‰∏ªÈ¢òÊñáÊú¨È¢úËâ≤
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
      
      .logo-icon {
        width: 24px;
        height: 24px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        
        svg {
          width: 100%;
          height: 100%;
        }
      }
      
      span {
        position: relative;
        top: 1px;
      }
    }
    
    .header-buttons {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
    }
    
    .exit-btn,
    .collapse-btn {
      background: transparent;
      border: none;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #666;
      transition: all 0.2s;
      
      &:hover {
        background: rgba(0, 0, 0, 0.05);
        color: #333;
      }
    }
    
    .exit-btn:hover {
      color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
    }
  }
  
  .sidebar-actions {
    padding: 12px;
    
    .new-chat-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 10px;
      background: linear-gradient(135deg, #FF9A8B, #FF6B95);
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 3px 8px rgba(255, 107, 149, 0.3);
      font-weight: 600;
      
      &:hover {
        background: linear-gradient(135deg, #FF8A7B, #FF5B85);
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(255, 107, 149, 0.4);
      }
      
      .btn-icon {
        margin-right: 6px;
        font-weight: bold;
        font-size: 1.1rem;
      }
    }
  }
  
  .history-list {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    
    .history-item {
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
      border: 1px solid rgba(0, 0, 0, 0.04); // Ê∑ªÂä†ËΩªÂæÆËæπÊ°Ü
      
      &:hover {
        background: rgba(0, 0, 0, 0.06); // Âä†Ê∑±ÊÇ¨ÂÅúÊïàÊûú
        border-color: rgba(0, 0, 0, 0.08); // Âä†Ê∑±ÊÇ¨ÂÅúÊó∂ËæπÊ°Ü
      }
      
      .history-content {
        flex: 1;
        overflow: hidden;
        
        .history-title {
          font-size: 0.9rem;
          margin-bottom: 4px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          padding-right: 80px;
          position: relative;
        }
        
        .history-meta {
          display: flex;
          align-items: center;
          gap: 6px;
          flex-wrap: nowrap;
          overflow: hidden;
          
          .history-time {
            font-size: 0.75rem;
            color: #888;
            flex-shrink: 0;
          }
          
          .history-tags {
            display: inline-flex;
            flex-wrap: nowrap;
            gap: 4px;
            overflow: hidden;
            
            .history-tag {
              font-size: 0.65rem;
              padding: 1px 5px;
              border-radius: 10px;
              color: white;
              white-space: nowrap;
              font-weight: 500;
              flex-shrink: 0;
            }
          }
        }
      }
      
      .history-actions {
        display: flex;
        position: absolute;
        top: 10px;
        right: 8px;
        gap: 3px;
        
        .history-action-btn {
          background: transparent;
          border: none;
          color: #999;
          width: 24px;
          height: 24px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          opacity: 0.8;
          transition: all 0.2s;
          
          &:hover {
            background: rgba(0, 0, 0, 0.05);
            opacity: 1;
          }
          
          &.tag-btn:hover {
            background: rgba(255, 107, 149, 0.1);
            color: #FF6B95;
          }
          
          &.export-btn:hover {
            background: rgba(70, 101, 238, 0.1);
            color: #4665ee;
          }
          
          &.delete-history-btn:hover {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
          }
        }
      }
    }
  }
  
  .sidebar-footer {
    padding: 12px;
    border-top: 1px solid rgba(0, 0, 0, 0.12); // Âä†Ê∑±ËæπÊ°ÜÈ¢úËâ≤
    background: rgba(0, 0, 0, 0.02); // ËΩªÂæÆËÉåÊôØËâ≤Âå∫Âà´
    
    .settings-btn,
    .profile-btn {
      width: 100%;
      display: flex;
      align-items: center;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.7); // ËΩªÂæÆÁôΩËâ≤ËÉåÊôØ
      border: 1px solid rgba(0, 0, 0, 0.1); // Âä†Ê∑±ËæπÊ°Ü
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--text-color, #333); // ‰ΩøÁî®‰∏ªÈ¢òÊñáÊú¨È¢úËâ≤
      
      &:hover {
        background: rgba(0, 0, 0, 0.06); // Âä†Ê∑±ÊÇ¨ÂÅúÊïàÊûú
        transform: translateY(-1px); // ËΩªÂæÆÊä¨Ëµ∑ÊïàÊûú
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); // ÊÇ¨ÂÅúÊó∂Ê∑ªÂä†Èò¥ÂΩ±
      }
      
      .btn-icon {
        margin-right: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
    
    .settings-btn {
      margin-bottom: 8px;
    }
  }
}

/* ‰∏ªÂÜÖÂÆπÂå∫Ê†∑Âºè */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  
  &.full-width {
    width: 100%;
  }
}

.chat-content {
  flex: 1;
  overflow-y: auto;
  padding: 0;
  scroll-behavior: smooth;
  display: flex;
  flex-direction: column;
  padding-bottom: 150px; // Â¢ûÂä†Â∫ïÈÉ®ÂÜÖËæπË∑ùÔºåËÆ©ËÅäÂ§©ÂÜÖÂÆπÂá∫Áé∞Âú®Êõ¥‰∏äÊñπ
  position: relative; // Ê∑ªÂä†Áõ∏ÂØπÂÆö‰Ωç‰Ωú‰∏∫ËæìÂÖ•Ê°ÜÁöÑÂÆö‰ΩçÂü∫ÂáÜ
}

.welcome-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  margin-top: -100px;
  
  .bot-avatar {
    margin-bottom: 20px;
    width: 150px;
    height: 150px;
    background: linear-gradient(135deg, #FF9A8B, #FF6B95);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 20px rgba(255, 107, 149, 0.4);
    position: relative;
    overflow: hidden;
    
    img {
      width: 180px;
      height: 180px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -42%);
      filter: drop-shadow(0px 2px 5px rgba(0, 0, 0, 0.15));
    }
  }
  
  .welcome-title {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 16px;
    color: #333;
  }
  
  .welcome-subtitle {
    font-size: 1.1rem;
    color: #666;
    max-width: 600px;
    line-height: 1.5;
  }
}

.message-container {
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
  padding: 40px 20px 120px; // Â¢ûÂä†Â∫ïÈÉ®ÂÜÖËæπË∑ù
  
  .message-item {
    display: flex;
    margin-bottom: 24px;
    
    &.user-message {
      flex-direction: row-reverse;
      justify-content: flex-start; // ‰ªéÂè≥‰æßÂºÄÂßã
      
      .message-avatar {
        margin-right: 0;
        margin-left: 12px;
      }
      
      .message-content {
        background-color: #e9efff;
        margin-right: 0;
        margin-left: auto; // Èù†Âè≥ÂØπÈΩê
        
        .message-text {
          color: #333333;
        }
      }
    }
    
    &.bot-message {
      justify-content: flex-start; // ‰ªéÂ∑¶‰æßÂºÄÂßã
      
      .message-avatar {
        background: #f0f7ff;
      }
      
      .message-content {
        margin-left: 0;
        margin-right: auto; // Èù†Â∑¶ÂØπÈΩê
      }
    }
    
    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
      margin-right: 12px;
    }
    
    .message-content {
      flex: 0 1 auto; // ‰øÆÊîπ‰∏∫Ëá™ÈÄÇÂ∫îÂÆΩÂ∫¶
      min-width: 60px; // ËÆæÁΩÆÊúÄÂ∞èÂÆΩÂ∫¶
      max-width: 80%; // ÊúÄÂ§ßÂÆΩÂ∫¶‰∏∫ÂÆπÂô®ÁöÑ80%
      width: fit-content; // Ê†πÊçÆÂÜÖÂÆπÈÄÇÂ∫îÂÆΩÂ∫¶
      padding: 12px 16px;
      border-radius: 12px;
      background-color: #f0f0f3;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      align-self: flex-start; // Á°Æ‰øù‰∏éÈ°∂ÈÉ®ÂØπÈΩê
      
      .message-time {
        font-size: 0.75rem;
        color: #888888;
        margin-top: 6px;
        text-align: right;
      }
      
      .message-text {
        font-size: 0.95rem;
        line-height: 1.5;
        color: #333333;
        word-break: break-word;
        white-space: pre-wrap;
        
        code {
          background-color: rgba(0, 0, 0, 0.05);
          padding: 2px 4px;
          border-radius: 4px;
          font-family: monospace;
        }
        
        pre {
          background-color: #f1f1f1;
          padding: 12px;
          border-radius: 8px;
          overflow-x: auto;
          margin: 10px 0;
          
          code {
            background-color: transparent;
            padding: 0;
          }
        }
      }
      
      /* ÊÄùËÄÉÂÜÖÂÆπÂå∫ÂüüÊ†∑Âºè */
      .message-thinking {
        margin-bottom: 12px;
        padding: 10px;
        background-color: #f9f5ff;
        border-radius: 8px;
        border-left: 3px solid #8b5cf6;
        font-size: 0.9rem;
        width: 100%; // Á°Æ‰øùÊÄùËÄÉÂå∫ÂüüÂÆΩÂ∫¶‰∏∫100%
        box-sizing: border-box; // ÂåÖÂê´paddingÂú®ÂÜÖ
        
        .thinking-header {
          display: flex;
          align-items: center;
          gap: 6px;
          margin-bottom: 8px;
          font-weight: 500;
          color: #8b5cf6;
          font-size: 0.85rem;
          
          svg {
            color: #8b5cf6;
          }
        }
        
        .thinking-content {
          color: #6b7280;
          line-height: 1.4;
        }
      }
    }
    
    &.user-message {
      flex-direction: row-reverse;
      
      .message-avatar {
        margin-right: 0;
        margin-left: 12px;
        background: #deeaff;
      }
      
      .message-content {
        background: linear-gradient(135deg, #FF9A8B, #FF6B95); // ‰ΩøÁî®‰∏é‰∏ªÈ¢òÁõ∏ÂåπÈÖçÁöÑÊ∏êÂèòÁ≤âËâ≤Á≥ª
        color: white;
        
        .message-time {
          color: rgba(255, 255, 255, 0.8);
        }
      }
    }
    
    &.bot-message {
      .message-avatar {
        background: #f0f7ff;
      }
    }
  }
  
  .typing-indicator {
    display: flex;
    padding: 12px 16px;
    background: white;
    border-radius: 12px;
    width: fit-content;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: #888;
      border-radius: 50%;
      margin: 0 2px;
      animation: typing-dot 1.4s infinite ease-in-out both;
      
      &:nth-child(1) {
        animation-delay: -0.32s;
      }
      
      &:nth-child(2) {
        animation-delay: -0.16s;
      }
    }
  }
}

.chat-input-wrapper {
  position: absolute; // Áõ∏ÂØπ‰∫é.chat-contentÁªùÂØπÂÆö‰Ωç
  left: 50%; 
  transform: translateX(-50%); // ‰ΩøÁî®transformÂ±Ö‰∏≠
  bottom: 20px;
  width: 100%;
  max-width: 700px; 
  margin: 0 auto; // Á°Æ‰øùÂ±Ö‰∏≠
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  background: transparent;
  z-index: 50; 
  
  // Ê†πÊçÆ‰æßËæπÊ†èÁä∂ÊÄÅË∞ÉÊï¥‰ΩçÁΩÆ
  &.sidebar-expanded {
    // ÁßªÈô§ transform ‰ΩçÁßªÔºå‰æßËæπÊ†èÂ±ïÂºÄÊó∂‰πü‰øùÊåÅ‰∏≠Â§Æ‰ΩçÁΩÆ
    margin-left: 0;
  }
  
  &.with-messages {
    position: absolute; // Êîπ‰∏∫ÁªùÂØπÂÆö‰Ωç
    bottom: 20px;
  }
  
  .chat-input-area {
    display: flex;
    position: relative;
    flex-direction: column;
    background: white;
    border-radius: 12px;
    padding: 14px 16px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    margin: 0 20px; // Ê∑ªÂä†Ê∞¥Âπ≥ËæπË∑ù
    
    .mode-selector-inner {
      display: flex;
      margin-bottom: 10px;
      gap: 8px;
      
      .mode-btn {
        display: flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        background-color: rgba(0, 0, 0, 0.05);
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        color: #333;
        
        svg {
          margin-right: 6px;
        }
        
        &.deep-think-btn {
          background-color: rgba(100, 80, 220, 0.1);
          color: #5140a7;
          
          svg {
            stroke: #5140a7;
          }
          
          &:hover {
            background-color: rgba(100, 80, 220, 0.2);
          }
          
          &.active {
            background-color: #5140a7;
            color: white;
            
            svg {
              stroke: white;
            }
          }
        }
        
        &.web-search-btn {
          background-color: rgba(14, 165, 233, 0.1);
          color: #0284c7;
          
          svg {
            stroke: #0284c7;
          }
          
          &:hover {
            background-color: rgba(14, 165, 233, 0.2);
          }
        }

        &.cloud-model-btn {
          background-color: rgba(25, 118, 210, 0.1);
          color: #1976d2;
          
          svg {
            stroke: #1976d2;
          }
          
          &:hover {
            background-color: rgba(25, 118, 210, 0.2);
          }
          
          &.active {
            background-color: #1976d2;
            color: white;
            
            svg {
              stroke: white;
            }
          }
        }
      }
    }
    
    .input-row {
      display: flex;
      flex-direction: column;
      
      .selected-files {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
        
        .selected-file-item {
          display: flex;
          align-items: center;
          background: rgba(70, 101, 238, 0.1);
          border: 1px solid rgba(70, 101, 238, 0.2);
          border-radius: 8px;
          padding: 6px 10px;
          font-size: 0.9rem;
          
          .file-icon {
            color: var(--primary-color);
            margin-right: 6px;
            display: flex;
            align-items: center;
          }
          
          .file-name {
            color: #333;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          }
          
          .file-size {
            color: #666;
            font-size: 0.8rem;
            margin-left: 4px;
          }
          
          .remove-file-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            margin-left: 8px;
            padding: 2px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            
            &:hover {
              background: rgba(255, 0, 0, 0.1);
              color: #ff4444;
            }
          }
        }
      }
      
      .input-container {
        display: flex;
        align-items: flex-end;
        border-radius: 8px;
        transition: all 0.3s ease;
        position: relative;
        
        &.dragging {
          background: rgba(70, 101, 238, 0.1);
          border: 2px dashed var(--primary-color);
          
          &::after {
            content: "ÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ‰∏ä‰º†";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-color);
            font-size: 0.9rem;
            font-weight: 500;
            pointer-events: none;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          }
        }
        
        .chat-input {
          flex: 1;
          border: none;
          background: transparent;
          font-size: 1.05rem;
          resize: none;
          outline: none;
          line-height: 1.5;
          max-height: 220px;
          min-height: 60px;
          padding: 15px 0 15px 10px;
          overflow-y: auto;
          text-align: left;
        }
        
        .input-tools {
          display: flex;
          align-items: center;
          justify-content: flex-end;
          align-self: flex-end;
          margin-left: 8px;
          
          .tool-btn {
            background: transparent;
            border: none;
            color: #666;
            padding: 6px 8px;
            margin-right: 6px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            
            &:hover {
              background: rgba(0, 0, 0, 0.05);
              color: #333;
            }
            
            /* Ê®°ÂûãÂàáÊç¢ÊåâÈíÆÁâπÊÆäÊ†∑Âºè */
            &.model-switch-btn {
              color: var(--accent-color);
              
              &:hover {
                background: rgba(255, 107, 149, 0.1);
                color: #FF5B85;
              }
            }
            
            /* ÊèêÁ§∫ËØçÂ∫ìÊåâÈíÆÁâπÊÆäÊ†∑Âºè */
            &.prompt-library-btn {
              color: var(--primary-color);
              
              &:hover {
                background: rgba(70, 101, 238, 0.1);
                color: #3a56d4;
              }
            }
            
            /* Êñá‰ª∂‰∏ä‰º†ÊåâÈíÆÁâπÊÆäÊ†∑Âºè */
            &.upload-btn {
              color: #42b983; /* Áø°Áø†ÁªøËâ≤ */
              
              &:hover {
                background: rgba(66, 185, 131, 0.1);
                color: #35a574;
              }
            }
            
            /* Êñá‰ª∂ÁÆ°ÁêÜÊåâÈíÆÁâπÊÆäÊ†∑Âºè */
            &.file-manager-btn {
              color: #f39c12; /* Ê©ôËâ≤ */
              
              &:hover {
                background: rgba(243, 156, 18, 0.1);
                color: #d68910;
              }
            }
          }
          
          .send-btn {
            color: #4665ee;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            
            &:hover {
              background: rgba(70, 101, 238, 0.1);
            }
            
            &:disabled {
              color: #ccc;
              cursor: not-allowed;
            }
            
            svg {
              stroke: currentColor;
            }
          }
        }
      }
    }
  }
  
  // Ê∑ªÂä†ÂÖçË¥£Â£∞ÊòéÊñáÊú¨
  &::after {
    content: "ÂÜÖÂÆπÁî± AI ÁîüÊàêÔºåËØ∑‰ªîÁªÜÁîÑÂà´";
    display: block;
    text-align: center;
    font-size: 12px;
    color: #999;
    margin-top: 10px;
    width: 100%;
    padding: 0 20px;
  }
}

/* Toast Ê†∑Âºè */
.toast-container {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, rgba(255, 154, 139, 0.95), rgba(255, 107, 149, 0.95)); // ‰ΩøÁî®‰∏éÁî®Êà∑Ê∂àÊÅØÁõ∏ÂêåÁöÑÊ∏êÂèòËâ≤ÔºåÊ∑ªÂä†ÈÄèÊòéÂ∫¶
  color: white;
  padding: 12px 24px;
  border-radius: 12px; // Â¢ûÂä†ÂúÜËßí
  z-index: 9999;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
  box-shadow: 0 8px 20px rgba(255, 107, 149, 0.3); // ÊüîÂíåÁöÑÈò¥ÂΩ±Ôºå‰∏éÁ≤âËâ≤Á≥ªÂåπÈÖç
  max-width: 90%;
  
  &.toast-show {
    opacity: 1;
  }
  
  .toast-message {
    font-size: 1rem;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 500; // Á®çÂæÆÂä†Á≤óÂ≠ó‰Ωì
  }
}

@keyframes typing-dot {
  0%, 80%, 100% { transform: scale(0.7); }
  40% { transform: scale(1); }
}

/* ÂºπÂá∫Â±ÇÊ†∑Âºè */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(2px);
}

.modal-container {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  display: flex;
  flex-direction: column;
  animation: modal-appear 0.3s ease-out;
  
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    
    h3 {
      margin: 0;
      font-size: 1rem;
      color: #333;
      font-weight: 600;
    }
    
    .modal-close {
      background: transparent;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      color: #888;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      
      &:hover {
        color: #333;
        background: #f0f0f3;
      }
    }
  }
  
  .modal-body {
    padding: 16px;
    overflow-y: auto;
  }
  
  .modal-footer {
    padding: 10px 16px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    
    button {
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .cancel-btn {
      background: transparent;
      border: 1px solid #ddd;
      color: #666;
      
      &:hover {
        background: #f5f5f5;
      }
    }
    
    .confirm-btn {
      background: linear-gradient(135deg, #FF9A8B, #FF6B95); // ‰ΩøÁî®‰∏éÊèêÁ§∫Ê°ÜÂíåÁî®Êà∑Ê∂àÊÅØÁõ∏ÂêåÁöÑÊ∏êÂèòËâ≤
      border: none;
      color: white;
      box-shadow: 0 2px 8px rgba(255, 107, 149, 0.3); // Ê∑ªÂä†ËΩªÂæÆÈò¥ÂΩ±
      
      &:hover {
        background: linear-gradient(135deg, #FF8A7B, #FF5B85); // ÊÇ¨ÂÅúÊó∂Á®çÂæÆÊ∑±‰∏ÄÁÇπ
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(255, 107, 149, 0.4);
      }
    }
    
    .add-model-btn {
      background: linear-gradient(135deg, #42b983, #2f9661);
      border: none;
      color: white;
      box-shadow: 0 2px 8px rgba(66, 185, 131, 0.3);
      margin-right: auto; // Â∞ÜÊåâÈíÆÊé®Âà∞Â∑¶‰æß
      
      &:hover {
        background: linear-gradient(135deg, #3ca876, #278255);
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(66, 185, 131, 0.4);
      }
    }
  }
}

/* Ê†áÁ≠æÈÄâÊã©Âô®Ê†∑Âºè */
.tag-selector {
  .tags-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 16px;
    
    .tag-item {
      display: flex;
      align-items: center;
      border: 1px solid #eee;
      border-left-width: 3px;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s;
      
      &:hover {
        background: #f9f9f9;
      }
      
      &.selected {
        background: #f5f8ff;
      }
      
      .tag-color {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }
      
      .tag-name {
        flex: 1;
        font-size: 0.9rem;
      }
      
      .tag-check {
        color: #4665ee;
        font-weight: bold;
      }
    }
  }
  
  /* Ê†áÈ¢òËæìÂÖ•Ê°ÜÊ†∑Âºè */
  .title-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background-color: #f9f9fb;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
    
    &:focus {
      outline: none;
      border-color: #4665ee;
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(70, 101, 238, 0.1);
    }
    
    &::placeholder {
      color: #aaa;
    }
  }
  
  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
}

/* ÂØºÂá∫ËèúÂçïÊ†∑Âºè */
.export-menu {
  .export-options {
    display: flex;
    flex-direction: column;
    
    .export-option {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 2px;
      
      &:hover {
        background: #f5f8ff;
      }
      
      .export-icon {
        margin-right: 12px;
        color: #4665ee;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .export-format {
        font-size: 0.95rem;
        color: #333;
      }
    }
  }
}

@keyframes modal-appear {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
@media (max-width: 768px) {
  .chat-container {
    flex-direction: column;
  }
  
  .sidebar-toggle {
    top: 10px;
    left: 10px;
  }
  
  .sidebar {
    width: 100%;
    height: auto;
    max-height: 300px;
    border-right: none;
    border-bottom: 1px solid #e5e5e5;
    
    &.sidebar-collapsed {
      max-height: 0;
      padding: 0;
      margin: 0;
      border-bottom: none;
    }
  }
  
  .chat-input-wrapper {
    bottom: 20px;
    padding: 0 16px;
    
    &.with-messages {
      padding: 10px 16px;
    }
  }
}

@media (max-width: 992px) {
  .sidebar:not(.sidebar-collapsed) {
    width: 240px;
  }
}

@keyframes modal-appear {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Êñá‰ª∂ÁÆ°ÁêÜÂô®Ê†∑Âºè */
.file-manager {
  .file-manager-toolbar {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 16px;
    
    .file-search {
      flex: 1;
      min-width: 200px;
      position: relative;
      
      .file-search-input {
        width: 100%;
        padding: 8px 12px 8px 32px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        
        &:focus {
          outline: none;
          border-color: #4665ee;
        }
      }
      
      .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
      }
    }
    
    .file-filters {
      display: flex;
      gap: 4px;
      
      .filter-btn {
        padding: 6px 12px;
        background: #f0f0f3;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        color: #666;
        
        &:hover {
          background: #e5e5e5;
        }
        
        &.active {
          background: #4665ee;
          color: white;
        }
      }
    }
    
    .upload-file-btn {
      padding: 6px 12px;
      background: #4665ee;
      color: white;
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      
      &:hover {
        background: #3a56d4;
        transform: translateY(-1px);
      }
    }
  }
  
  .files-container {
    border: 1px solid #eee;
    border-radius: 6px;
    max-height: 400px;
    overflow-y: auto;
    
    .file-item {
      display: flex;
      align-items: flex-start;
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
      
      &:last-child {
        border-bottom: none;
      }
      
      &:hover {
        background: #f5f8ff;
      }
      
      &.selected {
        background: #e9efff;
      }
      
      .file-icon {
        margin-right: 12px;
        flex-shrink: 0;
        width: 24px;
        height: 24px;
        margin-top: 2px;
      }
      
      .file-details {
        flex: 1;
        min-width: 0;
        
        .file-name {
          font-weight: 500;
          margin-bottom: 4px;
          font-size: 0.95rem;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          padding-right: 60px;
          
          &.restricted {
            color: #888;
          }
          
          .restricted-badge {
            display: inline-block;
            font-size: 0.65rem;
            background: #EB5757;
            color: white;
            padding: 1px 5px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            position: relative;
            top: -1px;
          }
        }
        
        .file-meta {
          display: flex;
          gap: 12px;
          margin-bottom: 4px;
          font-size: 0.8rem;
          color: #888;
          
          .file-size, .file-date {
            white-space: nowrap;
          }
        }
        
        .file-description {
          font-size: 0.85rem;
          color: #666;
          overflow: hidden;
          text-overflow: ellipsis;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
        }
      }
      
      .file-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 4px;
        
        .file-action-btn {
          background: transparent;
          border: none;
          width: 26px;
          height: 26px;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          color: #888;
          transition: all 0.2s;
          
          &:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
          }
          
          &.toggle-access:hover {
            color: #4665ee;
          }
          
          &.delete-file:hover {
            color: #EB5757;
          }
        }
      }
    }
    
    .no-files {
      padding: 30px;
      text-align: center;
      color: #888;
      font-size: 0.9rem;
    }
  }
}

/* Êñá‰ª∂‰∏ä‰º†Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
.file-upload-modal {
  max-width: 500px;
  
  .file-upload-area {
    .upload-dropzone {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.2s;
      
      &:hover {
        border-color: #4665ee;
        background: #f9f9ff;
      }
      
      svg {
        color: #888;
        margin-bottom: 10px;
      }
      
      p {
        font-size: 1rem;
        color: #333;
        margin: 0 0 8px;
      }
      
      .upload-formats {
        font-size: 0.8rem;
        color: #888;
      }
    }
    
    .upload-form {
      .form-group {
        margin-bottom: 14px;
        
        label {
          display: block;
          font-size: 0.9rem;
          margin-bottom: 6px;
          color: #555;
        }
        
        input[type="text"], textarea {
          width: 100%;
          padding: 8px 10px;
          border: 1px solid #ddd;
          border-radius: 6px;
          font-size: 0.9rem;
          
          &:focus {
            outline: none;
            border-color: #4665ee;
          }
        }
        
        textarea {
          resize: vertical;
        }
        
        .checkbox-label {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
          
          input[type="checkbox"] {
            margin-right: 8px;
          }
          
          .hint {
            font-size: 0.8rem;
            color: #888;
            margin-left: 22px;
          }
        }
      }
    }
  }
}

/* ‰∏ªÈ¢òËÆæÁΩÆÂºπÂá∫Á™óÂè£Ê†∑Âºè */
.theme-settings {
  .settings-layout {
    display: flex;
    gap: 20px;
    
    .settings-column {
      flex: 1;
      min-width: 0;
      
      &:first-child {
        flex: 0 0 55%;
      }
      
      &:last-child {
        flex: 0 0 45%;
      }
    }
  }

  .theme-section {
    margin-bottom: 12px;
    
    /* ÈöêËóèÂ≠ó‰ΩìËÆæÁΩÆÊ†áÈ¢ò */
    &:nth-child(3) .section-title {
      display: none;
    }
    
    .section-row {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .section-title {
      font-size: 0.95rem;
      font-weight: bold;
      width: 70px;
      margin-right: 8px;
      margin-bottom: 0;
    }
    
    .theme-options {
      display: flex;
      gap: 8px;
      flex: 1;
      
      .theme-option {
        flex: 1;
        padding: 5px;
        border: 2px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        
        &.selected {
          border-color: #4665ee;
        }
        
        .theme-preview {
          width: 100%;
          height: 30px;
          border-radius: 4px;
          margin-bottom: 4px;
        }
        
        .theme-name {
          font-size: 0.85rem;
          color: #333;
          text-align: center;
        }
      }
    }
    
    .mode-toggle {
      display: flex;
      gap: 8px;
      flex: 1;
      
      .mode-btn {
        flex: 1;
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        
        &.active {
          border-color: #4665ee;
        }
        
        svg {
          margin-right: 5px;
        }
      }
    }
    
    .setting-label {
      font-size: 0.85rem;
      font-weight: bold;
      width: 70px;
      margin-right: 8px;
    }
    
    .setting-options {
      display: flex;
      gap: 6px;
      flex: 1;
      
      .option-btn {
        flex: 1;
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
        
        &.active {
          border-color: #4665ee;
        }
      }
    }
  }
}

/* ÊèêÁ§∫ËØçÂ∫ìÊ†∑Âºè */
.prompt-library {
  .prompt-library-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    
    .prompt-search {
      position: relative;
      flex: 1; // ËÆ©ÊêúÁ¥¢Ê°ÜÂç†ÊçÆÂâ©‰ΩôÁ©∫Èó¥
      min-width: 200px;
      
      .prompt-search-input {
        width: 100%;
        padding: 8px 12px 8px 36px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        
        &:focus {
          outline: none;
          border-color: var(--primary-color);
        }
      }
      
      .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
      }
    }
    
    .prompt-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      
      .filter-btn {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
        
        &:hover {
          background: rgba(0, 0, 0, 0.05);
        }
        
        &.active {
          background: var(--primary-color);
          color: white;
          border-color: var(--primary-color);
        }
      }
    }
    
    .add-prompt-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      
      &:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      
      svg {
        stroke: currentColor;
      }
    }
    
    /* Ê®°ÂûãÂàáÊç¢ÊåâÈíÆÊ†∑Âºè */
    .model-switch-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      
      &:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      
      svg {
        stroke: currentColor;
      }
    }
  }
  
  .prompts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    
    .prompt-card {
      border: 1px solid #eee;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      cursor: pointer;
      
      &:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      
      .prompt-card-header {
        padding: 10px 12px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        
        .prompt-name {
          font-weight: 600;
          font-size: 0.95rem;
          max-width: 180px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .prompt-category-badge {
          padding: 2px 6px;
          border-radius: 12px;
          background: rgba(255, 255, 255, 0.2);
          font-size: 0.7rem;
          font-weight: 500;
        }
      }
      
      .prompt-card-body {
        padding: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
        
        .prompt-description {
          font-size: 0.85rem;
          margin-bottom: 8px;
          color: #666;
          line-height: 1.5;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
          flex: 1;
        }
        
        .prompt-tool-id {
          font-size: 0.75rem;
          color: #888;
          margin-bottom: 8px;
          display: flex;
          align-items: center;
          gap: 4px;
          padding: 4px 8px;
          background: #f8f9fa;
          border-radius: 12px;
          border: 1px solid #e9ecef;
          width: fit-content;
          
          svg {
            color: #6c757d;
          }
        }
        
        .prompt-tags {
          display: flex;
          flex-wrap: wrap;
          gap: 4px;
          
          .prompt-tag {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.05);
            color: #666;
            white-space: nowrap;
          }
          
          .prompt-tag-more {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.03);
            color: #888;
          }
        }
      }
      
      .prompt-card-footer {
        padding: 8px 12px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        
        .prompt-actions {
          display: flex;
          gap: 4px;
          
          .prompt-action-btn {
            background: transparent;
            border: none;
            width: 26px;
            height: 26px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #888;
            transition: all 0.2s;
            
            &:hover {
              background: rgba(0, 0, 0, 0.05);
              color: #333;
            }
            
            &.copy-btn:hover {
              color: var(--primary-color);
              background: rgba(70, 101, 238, 0.1);
            }
            
            &.edit-btn:hover {
              color: #4CAF50;
              background: rgba(76, 175, 80, 0.1);
            }
            
            &.delete-btn:hover {
              color: #F44336;
              background: rgba(244, 67, 54, 0.1);
            }
          }
        }
      }
    }
  }
  
  .no-prompts {
    text-align: center;
    padding: 30px;
    color: #888;
    font-style: italic;
  }
}

/* ÊèêÁ§∫ËØçÈ¢ÑËßàÊèêÁ§∫ */
.prompt-preview-tooltip {
  position: fixed;
  z-index: 1000;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  padding: 16px;
  width: 320px;
  max-height: 400px;
  overflow-y: auto;
  
  .preview-header {
    font-weight: 600;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
  }
  
  .preview-content {
    font-size: 0.9rem;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
  }
}

/* ÊèêÁ§∫ËØçÁºñËæëÊ®°ÊÄÅÊ°Ü */
.prompt-modal {
  .prompt-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      
      label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #555;
      }
      
      input, textarea, select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        
        &:focus {
          outline: none;
          border-color: var(--primary-color);
        }
      }
      
      textarea {
        min-height: 120px;
        resize: vertical;
      }
    }
  }
}

/* Ê®°ÂûãÈÄâÊã©Âô®Ê†∑Âºè */
.model-selector {
  .models-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 60vh;
    overflow-y: auto;
    padding: 4px;
    
    .model-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border: 1px solid #eee;
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
      
      &:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      
      &.selected {
        border-color: var(--primary-color);
        background: rgba(70, 101, 238, 0.05);
      }
      
      .model-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      
      .model-details {
        flex: 1;
        overflow: hidden;
        
        .model-name {
          font-weight: 600;
          font-size: 1rem;
          margin-bottom: 4px;
        }
        
        .model-provider {
          font-size: 0.85rem;
          color: #666;
          margin-bottom: 8px;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }
        
        .model-tags {
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
          
          .model-tag {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.05);
            color: #666;
          }
        }
      }
      
      .model-select-indicator {
        position: absolute;
        right: 16px;
        top: 16px;
        color: var(--primary-color);
      }
      
      .model-actions {
        position: absolute;
        right: 16px;
        bottom: 16px;
        display: flex;
        gap: 8px;
        
        .edit-model-btn {
          width: 28px;
          height: 28px;
          border-radius: 50%;
          background-color: rgba(255, 255, 255, 0.9);
          border: 1px solid #eee;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.2s;
          color: #555;
          
          &:hover {
            background-color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            color: var(--primary-color);
          }
        }
        .delete-model-btn {
          width: 28px;
          height: 28px;
          border-radius: 50%;
          background-color: rgba(255, 255, 255, 0.9);
          border: 1px solid #eee;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.2s;
          color: #555;
          
          &:hover {
            background-color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            color: #EB5757;
          }
        }
      }
    }
  }
}

/* Ê∑ªÂä†Ê®°ÂûãÂºπÂá∫Â±ÇÊ†∑Âºè */
.add-model-modal {
  .model-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-height: 70vh;
    overflow-y: auto;
    padding: 0 4px;
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      
      label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #555;
      }
      
      input, textarea {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.2s;
        background-color: #f9f9fb;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        
        &:focus {
          outline: none;
          border-color: #42b983;
          background-color: #fff;
          box-shadow: 0 0 0 3px rgba(66, 185, 131, 0.1);
        }
        
        &::placeholder {
          color: #aaa;
        }
      }
      
      textarea {
        min-height: 100px;
        resize: vertical;
      }
    }
  }
}

/* Âà†Èô§Ê®°ÂûãÁ°ÆËÆ§ÂºπÁ™óÊ†∑Âºè */
.delete-model-confirm {
  .confirm-message {
    font-size: 1rem;
    margin-bottom: 16px;
    text-align: center;
    
    strong {
      color: #EB5757;
    }
  }
  
  .confirm-warning {
    font-size: 0.9rem;
    color: #888;
    text-align: center;
    background-color: rgba(235, 87, 87, 0.1);
    padding: 8px 12px;
    border-radius: 8px;
    border-left: 3px solid #EB5757;
  }
  
  .modal-footer {
    .delete-btn {
      background: linear-gradient(135deg, #EB5757, #CC4444);
      border: none;
      color: white;
      box-shadow: 0 2px 8px rgba(235, 87, 87, 0.3);
      
      &:hover {
        background: linear-gradient(135deg, #DF4444, #BB3333);
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(235, 87, 87, 0.4);
      }
    }
  }
}

.field-hint {
  color: #888;
  font-size: 0.8rem;
  margin-top: 4px;
}

/* ÊøÄÊ¥ªÁöÑÁ≥ªÁªüÊèêÁ§∫ËØçÊòæÁ§∫Âå∫Âüü */
.active-prompt-container {
  position: fixed;
  top: 80px;
  right: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
  padding: 0;
  max-width: 360px;
  z-index: 1000;
  overflow: hidden;
  border: 1px solid rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  
  .active-prompt-badge {
    display: flex;
    flex-direction: column;
    
    .active-prompt-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      background-color: #f8f9fa;
      
      .active-prompt-info {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        width: 100%;
        
        svg {
          color: var(--primary-color);
          flex-shrink: 0;
          margin-top: 4px;
        }
        
        .prompt-title-wrapper {
          display: flex;
          flex-direction: column;
          line-height: 1.3;
          width: 100%;
          
          .prompt-label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            width: 100%;
            
            .prompt-title-label {
              font-size: 0.8rem;
              color: var(--primary-color);
              font-weight: 500;
              background-color: rgba(70, 101, 238, 0.08);
              padding: 4px 10px;
              border-radius: 4px;
              display: inline-block;
              letter-spacing: 0.3px;
              border: 1px solid rgba(70, 101, 238, 0.15);
              box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            }
            
            .active-prompt-close {
              background: transparent;
              border: none;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              width: 24px;
              height: 24px;
              border-radius: 50%;
              color: #777;
              transition: all 0.2s ease;
              
              &:hover {
                background: rgba(220, 53, 69, 0.1);
                color: #dc3545;
              }
            }
          }
          
          .active-prompt-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #333;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 8px;
          }
          
          .prompt-actions-row {
            display: flex;
            align-items: center;
            gap: 8px;
            
            .active-prompt-category {
              padding: 3px 8px;
              border-radius: 20px;
              font-size: 0.75rem;
              color: white;
              font-weight: 500;
              display: flex;
              align-items: center;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .active-prompt-tool-id {
              padding: 3px 8px;
              border-radius: 20px;
              font-size: 0.75rem;
              color: #666;
              background: #f0f0f0;
              border: 1px solid #ddd;
              font-weight: 500;
              display: flex;
              align-items: center;
              gap: 4px;
              
              svg {
                color: #888;
                margin-top: 0;
              }
            }
            
            .active-prompt-toggle {
              background: transparent;
              border: none;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 3px;
              color: #666;
              font-size: 0.8rem;
              padding: 4px 8px;
              border-radius: 6px;
              transition: all 0.2s ease;
              white-space: nowrap;
              min-width: 60px;
              
              &:hover {
                background: rgba(0, 0, 0, 0.05);
                color: #333;
              }
              
              svg {
                transition: transform 0.2s ease;
                flex-shrink: 0;
                margin-top: 0;
              }
              
              span {
                display: inline-block;
              }
            }
          }
        }
      }
      
      .active-prompt-actions {
        display: none;
      }
    }
    
    .active-prompt-content {
      padding: 16px;
      background: white;
      
      .active-prompt-text {
        font-size: 0.9rem;
        line-height: 1.5;
        color: #444;
        max-height: 300px;
        overflow-y: auto;
        padding-right: 8px;
        margin: 0;
        font-family: inherit;
        white-space: pre-wrap;
        word-break: break-word;
        
        /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
        &::-webkit-scrollbar {
          width: 6px;
        }
        
        &::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 10px;
        }
        
        &::-webkit-scrollbar-thumb {
          background: #ccc;
          border-radius: 10px;
        }
        
        &::-webkit-scrollbar-thumb:hover {
          background: #999;
        }
      }
    }
  }
}
</style> 
